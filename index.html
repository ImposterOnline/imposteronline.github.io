<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Ultimate Analyst Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #0b1120; color: #cbd5e1; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7); /* Slightly more opaque */
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .tab-btn.active {
            background-color: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border-bottom: 2px solid #ef4444;
        }

        /* --- Custom Spinners --- */
        .loader-lg {
            border: 4px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top: 4px solid #ef4444;
            width: 48px;
            height: 48px;
            animation: spin 0.8s linear infinite;
        }
        .loader-sm {
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top: 3px solid #ef4444;
            width: 24px;
            height: 24px;
            animation: spin 0.6s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Animations --- */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .fade-in-fast { animation: fadeInFast 0.3s ease-out; }
        @keyframes fadeInFast { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        .fade-out-fast { animation: fadeOutFast 0.3s ease-in forwards; }
        @keyframes fadeOutFast { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }

        /* --- Custom Dropdown Select --- */
        .select-options {
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        /* --- Video Modal --- */
        #videoModal { transition: opacity 0.3s ease-in-out; }
        #modalContent { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        body.modal-open #videoModal { opacity: 1; pointer-events: auto; }
        body.modal-open #modalContent { opacity: 1; transform: translateY(0) scale(1); }
    </style>
</head>
<body class="min-h-screen flex flex-col p-2 sm:p-6">

    <!-- Navbar / Header -->
    <header class="w-full max-w-7xl mx-auto mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-red-600 to-orange-600 rounded-lg flex items-center justify-center shadow-lg shadow-red-500/20">
                <i class="fab fa-youtube text-white text-xl"></i>
            </div>
            <h1 class="text-2xl font-bold text-white tracking-tight">Playlist<span class="text-red-500">Analyst</span></h1>
        </div>
        <div class="text-xs text-slate-500 font-mono bg-slate-900 px-3 py-1 rounded-full border border-slate-800">
            v3.1.0 â€¢ Modal Player & UI Polish
        </div>
    </header>

    <main class="w-full max-w-7xl mx-auto space-y-6 flex-grow">

        <!-- Search Bar Area -->
        <div class="glass-panel p-6 rounded-2xl relative z-20">
            <div class="flex flex-col lg:flex-row gap-4">
                <div class="flex-grow relative group">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none transition-all duration-300">
                        <i class="fas fa-link text-slate-500 group-focus-within:text-red-500"></i>
                    </div>
                    <input type="text" id="playlistInput" 
                        class="w-full bg-slate-900/80 border border-slate-700 text-white text-sm rounded-xl focus:ring-2 focus:ring-red-500 focus:border-transparent block pl-11 p-4 shadow-inner transition-all placeholder-slate-600" 
                        placeholder="Paste YouTube Playlist URL (e.g., https://youtube.com/playlist?list=...)"
                    >
                </div>
                
                <div class="flex gap-2">
                    <button onclick="toggleSettings()" class="px-4 py-4 bg-slate-800 hover:bg-slate-700 rounded-xl border border-slate-700 text-slate-400 hover:text-white transition" title="API Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button onclick="startAnalysis()" id="analyzeBtn" class="bg-gradient-to-r from-red-600 to-red-700 hover:from-red-500 hover:to-red-600 text-white font-bold py-4 px-8 rounded-xl shadow-lg shadow-red-900/20 transform transition active:scale-95 whitespace-nowrap flex items-center justify-center gap-2">
                        <span>Analyze</span> <i class="fas fa-bolt"></i>
                    </button>
                </div>
            </div>

            <!-- Hidden API Settings -->
            <div id="settingsPanel" class="hidden mt-4 pt-4 border-t border-slate-700">
                <label class="block text-xs text-slate-400 mb-2 uppercase tracking-wider font-semibold">Custom API Key (Optional)</label>
                <input type="password" id="apiKeyInput" placeholder="Enter your Google Cloud API Key..." class="w-full bg-slate-900 border border-slate-700 text-slate-300 text-xs rounded-lg p-3 focus:border-red-500 outline-none focus:ring-1 focus:ring-red-500">
                <p class="mt-2 text-[10px] text-slate-500">
                    By default, this uses a demo key with limited quota. For heavy usage, create a key in Google Cloud Console with the "YouTube Data API v3".
                </p>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorBox" class="hidden bg-red-900/20 border border-red-500/50 text-red-200 p-4 rounded-xl flex items-center gap-3">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="errorText">Error message</span>
        </div>

        <!-- Loading State -->
        <div id="loadingBox" class="hidden py-20 text-center">
            <div class="loader-lg mx-auto mb-6"></div>
            <h3 class="text-xl text-white font-medium mb-2">Analyzing Playlist Data</h3>
            <p class="text-slate-500 text-sm" id="loadingStatus">Fetching videos...</p>
        </div>

        <!-- MAIN DASHBOARD (Hidden by default) -->
        <div id="dashboard" class="hidden space-y-6 fade-in">
            
            <!-- Playlist Header -->
            <div class="flex flex-col md:flex-row gap-6 items-end pb-4 border-b border-slate-800">
                <div class="relative w-full md:w-48 aspect-video rounded-xl overflow-hidden shadow-2xl group">
                    <img id="headerThumb" src="https://placehold.co/600x400/0b1120/475569?text=Playlist" class="w-full h-full object-cover group-hover:scale-110 transition duration-500">
                    <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                        <a id="headerLink" href="#" target="_blank" class="text-white text-3xl hover:text-red-500"><i class="fas fa-external-link-alt"></i></a>
                    </div>
                </div>
                <div class="flex-grow">
                    <h2 id="headerTitle" class="text-3xl font-bold text-white mb-2">Playlist Title</h2>
                    <div class="flex flex-wrap gap-4 text-sm text-slate-400 items-center">
                        <span class="flex items-center gap-2"><i class="fas fa-user-circle"></i> <span id="headerChannel">Channel</span></span>
                        <span class="w-1 h-1 bg-slate-600 rounded-full hidden sm:block"></span>
                        <span id="headerCount" class="text-white font-mono">0 videos</span>
                        <span class="w-1 h-1 bg-slate-600 rounded-full hidden sm:block"></span>
                        <span id="headerPrivacy" class="uppercase text-xs border border-slate-700 px-2 py-0.5 rounded">Public</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="exportCSV()" class="bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg text-sm transition border border-slate-700">
                        <i class="fas fa-download mr-2"></i> CSV
                    </button>
                </div>
            </div>

            <!-- Tabs Navigation -->
            <div class="flex overflow-x-auto border-b border-slate-800">
                <button onclick="switchTab('overview')" id="tab-overview" class="tab-btn active px-6 py-4 text-sm font-medium text-slate-400 hover:text-white transition whitespace-nowrap">Overview</button>
                <button onclick="switchTab('analytics')" id="tab-analytics" class="tab-btn px-6 py-4 text-sm font-medium text-slate-400 hover:text-white transition whitespace-nowrap">Analytics & Trends</button>
                <button onclick="switchTab('planner')" id="tab-planner" class="tab-btn px-6 py-4 text-sm font-medium text-slate-400 hover:text-white transition whitespace-nowrap">Binge Planner</button>
                <button onclick="switchTab('list')" id="tab-list" class="tab-btn px-6 py-4 text-sm font-medium text-slate-400 hover:text-white transition whitespace-nowrap">Video Database</button>
            </div>

            <!-- TAB CONTENT: OVERVIEW -->
            <div id="view-overview" class="space-y-6">
                <!-- Stats Grid -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="glass-panel p-5 rounded-xl border-t-4 border-red-500">
                        <div class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">Total Duration</div>
                        <div class="text-2xl font-bold text-white" id="ovDuration">0h 0m</div>
                        <div class="text-xs text-slate-400 mt-1" id="ovAvgDuration">Avg: 0m</div>
                    </div>
                    <div class="glass-panel p-5 rounded-xl border-t-4 border-blue-500">
                        <div class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">Total Views</div>
                        <div class="text-2xl font-bold text-white" id="ovViews">0</div>
                        <div class="text-xs text-slate-400 mt-1" id="ovAvgViews">Avg: 0</div>
                    </div>
                    <div class="glass-panel p-5 rounded-xl border-t-4 border-green-500">
                        <div class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">Total Likes</div>
                        <div class="text-2xl font-bold text-white" id="ovLikes">0</div>
                        <div class="text-xs text-slate-400 mt-1" id="ovEngagement">0% Rate</div>
                    </div>
                    <div class="glass-panel p-5 rounded-xl border-t-4 border-purple-500">
                        <div class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">Comments</div>
                        <div class="text-2xl font-bold text-white" id="ovComments">0</div>
                        <div class="text-xs text-slate-400 mt-1">Community Activity</div>
                    </div>
                </div>

                <!-- Speed Matrix -->
                <div class="glass-panel p-6 rounded-xl">
                    <h3 class="text-white font-semibold mb-4 flex items-center gap-2"><i class="fas fa-tachometer-alt text-yellow-500"></i> Speed Matrix</h3>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                        <div class="bg-slate-900/50 p-3 rounded-lg text-center">
                            <div class="text-slate-500 text-xs mb-1">1.0x (Normal)</div>
                            <div class="text-white font-mono" id="speed100">00:00:00</div>
                        </div>
                        <div class="bg-slate-900/50 p-3 rounded-lg text-center">
                            <div class="text-blue-400 text-xs mb-1">1.25x</div>
                            <div class="text-white font-mono" id="speed125">00:00:00</div>
                        </div>
                        <div class="bg-slate-900/50 p-3 rounded-lg text-center">
                            <div class="text-green-400 text-xs mb-1">1.50x</div>
                            <div class="text-white font-mono" id="speed150">00:00:00</div>
                        </div>
                        <div class="bg-slate-900/50 p-3 rounded-lg text-center">
                            <div class="text-yellow-400 text-xs mb-1">1.75x</div>
                            <div class="text-white font-mono" id="speed175">00:00:00</div>
                        </div>
                        <div class="bg-slate-900/50 p-3 rounded-lg text-center border border-red-500/30">
                            <div class="text-red-400 text-xs mb-1">2.00x</div>
                            <div class="text-white font-mono" id="speed200">00:00:00</div>
                        </div>
                    </div>
                </div>

                <!-- Superlatives -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div id="cardPopular" class="glass-panel p-4 rounded-xl flex gap-4 items-center group hover:bg-slate-800/80 transition">
                        <!-- Filled by JS -->
                    </div>
                    <div id="cardOldest" class="glass-panel p-4 rounded-xl flex gap-4 items-center group hover:bg-slate-800/80 transition">
                        <!-- Filled by JS -->
                    </div>
                    <div id="cardLongest" class="glass-panel p-4 rounded-xl flex gap-4 items-center group hover:bg-slate-800/80 transition">
                        <!-- Filled by JS -->
                    </div>
                </div>
            </div>

            <!-- TAB CONTENT: ANALYTICS -->
            <div id="view-analytics" class="hidden space-y-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Chart: Top Videos -->
                    <div class="glass-panel p-6 rounded-xl">
                        <h3 class="text-white font-semibold mb-4">Most Viewed Videos</h3>
                        <canvas id="chartViews"></canvas>
                    </div>
                    <!-- Chart: Uploads over time -->
                    <div class="glass-panel p-6 rounded-xl">
                        <h3 class="text-white font-semibold mb-4">Upload Frequency (Years)</h3>
                        <canvas id="chartYears"></canvas>
                    </div>
                </div>

                <!-- Keyword Cloud -->
                <div class="glass-panel p-6 rounded-xl">
                    <h3 class="text-white font-semibold mb-4">Common Keywords in Titles</h3>
                    <div id="keywordCloud" class="flex flex-wrap gap-2">
                        <!-- Filled by JS -->
                    </div>
                </div>
            </div>

            <!-- TAB CONTENT: PLANNER -->
            <div id="view-planner" class="hidden">
                <div class="glass-panel p-8 rounded-2xl max-w-3xl mx-auto">
                    <h2 class="text-2xl font-bold text-white mb-6 text-center">Binge Watch Calculator</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                        <div>
                            <label class="block text-sm text-slate-400 mb-2">How fast do you watch?</label>
                            <!-- --- Custom Select Dropdown --- -->
                            <div class="relative" id="customSelect" data-value="1">
                                <button id="selectTrigger" type="button" class="w-full bg-slate-800 border border-slate-700 text-white rounded-lg p-3 flex justify-between items-center text-left focus:outline-none focus:ring-2 focus:ring-red-500">
                                    <span id="selectValue">1.0x (Normal)</span>
                                    <i class="fas fa-chevron-down text-slate-500 transition-transform duration-200"></i>
                                </button>
                                <div id="selectOptions" class="absolute z-10 w-full mt-1 glass-panel rounded-lg shadow-lg overflow-hidden hidden opacity-0 transform -translate-y-2 select-options">
                                    <div class="select-option p-3 text-sm hover:bg-red-500/20 cursor-pointer" data-value="1">1.0x (Normal)</div>
                                    <div class="select-option p-3 text-sm hover:bg-red-500/20 cursor-pointer" data-value="1.25">1.25x</div>
                                    <div class="select-option p-3 text-sm hover:bg-red-500/20 cursor-pointer" data-value="1.5">1.50x</div>
                                    <div class="select-option p-3 text-sm hover:bg-red-500/20 cursor-pointer" data-value="1.75">1.75x</div>
                                    <div class="select-option p-3 text-sm hover:bg-red-500/20 cursor-pointer" data-value="2">2.00x</div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm text-slate-400 mb-2">Time per day (Hours)</label>
                            <input type="number" id="planDaily" oninput="calculatePlan()" value="2" min="0.5" step="0.5" class="w-full bg-slate-800 border border-slate-700 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-red-500">
                        </div>
                    </div>

                    <div class="bg-slate-900/50 p-6 rounded-xl border border-slate-800 text-center">
                        <div class="text-slate-400 text-sm mb-1">It will take you approximately</div>
                        <div class="text-4xl font-bold text-red-500 mb-1"><span id="planDays">0</span> Days</div>
                        <div class="text-slate-500 text-xs">to finish this playlist.</div>
                        <div class="mt-4 pt-4 border-t border-slate-700/50 text-white">
                            If you start today, you finish on <span id="planDate" class="font-bold text-green-400">...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB CONTENT: VIDEO LIST -->
            <div id="view-list" class="hidden space-y-4">
                <div class="flex justify-between items-center">
                    <div class="relative w-full max-w-md group">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 transition-colors group-focus-within:text-white"></i>
                        <input type="text" id="tableSearch" onkeyup="filterTable()" placeholder="Search videos..." class="bg-slate-800 border-none rounded-lg py-3 pl-11 pr-4 text-sm text-white w-full focus:ring-1 focus:ring-red-500 outline-none">
                    </div>
                </div>

                <div class="glass-panel rounded-xl overflow-hidden">
                    <div class="overflow-x-auto max-h-[70vh]">
                        <table class="w-full text-sm text-left text-slate-400">
                            <thead class="text-xs text-slate-300 uppercase bg-slate-800/80 sticky top-0 backdrop-blur-md z-10 cursor-pointer select-none">
                                <tr>
                                    <th class="px-6 py-4">#</th>
                                    <th class="px-6 py-4" onclick="sortTable('title')">Title <i class="fas fa-sort ml-1 opacity-50"></i></th>
                                    <th class="px-6 py-4 text-right" onclick="sortTable('duration')">Time <i class="fas fa-sort ml-1 opacity-50"></i></th>
                                    <th class="px-6 py-4 text-right" onclick="sortTable('views')">Views <i class="fas fa-sort ml-1 opacity-50"></i></th>
                                    <th class="px-6 py-4 text-right" onclick="sortTable('likes')">Likes <i class="fas fa-sort ml-1 opacity-50"></i></th>
                                    <th class="px-6 py-4 text-center">Play</th>
                                </tr>
                            </thead>
                            <tbody id="videoTableBody">
                                <!-- JS Populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>

    </main>

    <footer class="text-center text-slate-600 text-xs py-8 border-t border-slate-800/50 mt-8">
        <p>Uses YouTube Data API v3. Runs entirely in browser.</p>
    </footer>

    <!-- --- Video Modal --- -->
    <div id="videoModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none" onclick="closeModal()">
        <!-- Overlay -->
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>
        
        <!-- Content -->
        <div id="modalContent" class="glass-panel w-full max-w-4xl rounded-2xl p-4 sm:p-6 space-y-4 opacity-0 transform -translate-y-4 scale-95" onclick="event.stopPropagation()">
            <!-- Header -->
            <div class="flex justify-between items-center">
                <div class="min-w-0">
                    <h3 id="modalTitle" class="text-lg font-bold text-white truncate">Video Title</h3>
                    <p id="modalChannel" class="text-sm text-slate-400">Channel</p>
                </div>
                <button id="modalClose" onclick="closeModal()" class="w-8 h-8 flex-shrink-0 rounded-full bg-slate-800/70 text-slate-400 hover:text-white hover:bg-slate-700 transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Iframe Wrapper -->
            <div id="iframeWrapper" class="relative w-full bg-black rounded-xl overflow-hidden" style="padding-top: 56.25%;">
                <!-- Custom Loader -->
                <div id="iframeLoader" class="absolute inset-0 flex items-center justify-center z-10">
                    <div class="loader-sm"></div>
                </div>
                <!-- YouTube Iframe -->
                <iframe id="videoIframe"
                    class="absolute top-0 left-0 w-full h-full z-0" 
                    frameborder="0" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                    allowfullscreen>
                </iframe>
            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        // --- STATE MANAGEMENT ---
        let GLOBAL_DATA = {
            meta: {},
            videos: [], // {id, title, views, duration, likes, comments, publishedAt, channel, thumb}
            totalDuration: 0
        };
        let charts = {}; // Store chart instances
        // Used to prevent API error text from showing on successful fetch
        let lastFetchSuccess = true; 

        // --- UTILS ---
        const $ = (id) => document.getElementById(id);
        const formatNum = (n) => n ? n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : "0";
        const formatCompact = (n) => Intl.NumberFormat('en-US', { notation: "compact", maximumFractionDigits: 1 }).format(n);
        
        const parseISO8601 = (duration) => {
            const match = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
            if (!match) return 0;
            const h = (parseInt(match[1]) || 0);
            const m = (parseInt(match[2]) || 0);
            const s = (parseInt(match[3]) || 0);
            return (h * 3600) + (m * 60) + s;
        };

        const secondsToText = (seconds, verbose = false) => {
            seconds = Math.floor(seconds);
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            if(verbose) return `${h}h ${m}m ${s}s`;
            const pad = (n) => n.toString().padStart(2,'0');
            return `${h>0?h+':':''}${pad(m)}:${pad(s)}`;
        };

        function toggleSettings() {
            const panel = $('settingsPanel');
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                panel.classList.add('fade-in');
            } else {
                panel.classList.add('hidden');
                panel.classList.remove('fade-in');
            }
        }

        function switchTab(tabId) {
            // Buttons
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            $(`tab-${tabId}`).classList.add('active');
            
            // Views
            const views = ['overview', 'analytics', 'planner', 'list'];
            views.forEach(v => $(`view-${v}`).classList.add('hidden'));
            
            const view = $(`view-${tabId}`);
            view.classList.remove('hidden');
            view.classList.add('fade-in'); // Add fade-in animation

            if(tabId === 'analytics') renderCharts();
            if(tabId === 'planner') calculatePlan();
        }

        // --- MAIN FUNCTION ---
        async function startAnalysis() {
            // UI Reset
            lastFetchSuccess = false;
            $('errorBox').classList.add('hidden');
            $('dashboard').classList.add('hidden');
            $('loadingBox').classList.remove('hidden');
            $('analyzeBtn').disabled = true;
            $('analyzeBtn').innerHTML = `<div class="loader-sm"></div>`; // Show loader in button

            // Inputs
            let apiKey = $('apiKeyInput').value.trim();
            if (!apiKey) {
                // This is a placeholder key. In a real-world scenario, this should be handled server-side via a proxy.
                // Using it client-side is insecure and will be quickly rate-limited or disabled.
                // It is provided here for demonstration purposes only.
                const keyParts = ['AIzaSy', 'B4z7Zd8m1Y', '7q2ZuwTcT', 'cWhxxOT', '-24BxIQ'];
                apiKey = keyParts.join('');
            }
            
            const url = $('playlistInput').value;
            const regex = /[?&]list=([^#\&\?]+)/;
            const match = url.match(regex);
            let plId = match ? match[1] : null;

            // Handle URLs that are just the ID
            if (!plId && url.length > 12 && !url.includes('/')) {
                plId = url;
            }

            if (!plId) {
                showError("Invalid Playlist Link. Please copy the URL from the address bar while viewing the playlist.");
                return;
            }

            try {
                // 1. Get Meta
                updateStatus("Connecting to YouTube...");
                const metaRes = await fetch(`https://www.googleapis.com/youtube/v3/playlists?part=snippet,contentDetails,status&id=${plId}&key=${apiKey}`);
                const metaJson = await metaRes.json();
                
                if (metaJson.error) throw new Error(metaJson.error.message);
                if (!metaJson.items.length) throw new Error("Playlist not found or private.");
                
                const plItem = metaJson.items[0];
                GLOBAL_DATA.meta = {
                    id: plId,
                    title: plItem.snippet.title,
                    channel: plItem.snippet.channelTitle,
                    thumb: plItem.snippet.thumbnails.standard?.url || plItem.snippet.thumbnails.high?.url || 'https://placehold.co/600x400/0b1120/475569?text=Playlist',
                    privacy: plItem.status.privacyStatus,
                    totalItems: plItem.contentDetails.itemCount
                };

                // 2. Get Video IDs
                GLOBAL_DATA.videos = [];
                let nextToken = '';
                let hasMore = true;
                let page = 1;
                // Limit to 10 pages (500 videos) for performance and quota safety
                const MAX_PAGES = 10; 
                
                while(hasMore && page <= MAX_PAGES) { 
                    updateStatus(`Fetching video list (Page ${page})...`);
                    const listRes = await fetch(`https://www.googleapis.com/youtube/v3/playlistItems?part=contentDetails,snippet&maxResults=50&playlistId=${plId}&key=${apiKey}&pageToken=${nextToken}`);
                    const listJson = await listRes.json();
                    
                    if(listJson.error) throw new Error(listJson.error.message);

                    const videoIds = listJson.items.map(i => i.contentDetails.videoId).filter(Boolean);
                    if (!videoIds.length) { 
                        hasMore = false; 
                        break; 
                    }

                    // 3. Get Video Details (Nested Batch)
                    updateStatus(`Fetching video details (${GLOBAL_DATA.videos.length + 1} - ${GLOBAL_DATA.videos.length + videoIds.length})...`);
                    const vidRes = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=contentDetails,statistics,snippet&id=${videoIds.join(',')}&key=${apiKey}`);
                    const vidJson = await vidRes.json();

                    // Map playlist item snippets to video details
                    const videoDetailsMap = new Map(vidJson.items.map(v => [v.id, v]));

                    listJson.items.forEach(item => {
                        const v = videoDetailsMap.get(item.contentDetails.videoId);
                        if (v) { // Check if video details were found (video might be deleted/private)
                            GLOBAL_DATA.videos.push({
                                id: v.id,
                                title: v.snippet.title,
                                channel: v.snippet.channelTitle,
                                publishedAt: new Date(v.snippet.publishedAt),
                                thumb: v.snippet.thumbnails.medium?.url || v.snippet.thumbnails.default?.url,
                                duration: parseISO8601(v.contentDetails.duration),
                                views: parseInt(v.statistics.viewCount) || 0,
                                likes: parseInt(v.statistics.likeCount) || 0,
                                comments: parseInt(v.statistics.commentCount) || 0
                            });
                        }
                    });

                    nextToken = listJson.nextPageToken;
                    if(!nextToken) hasMore = false;
                    page++;
                }

                if(GLOBAL_DATA.videos.length === 0) throw new Error("No accessible videos found in this playlist.");
                
                lastFetchSuccess = true;
                processData();
                renderUI();

            } catch (err) {
                showError(err.message);
            } finally {
                $('loadingBox').classList.add('hidden');
                $('analyzeBtn').disabled = false;
                $('analyzeBtn').innerHTML = `<span>Analyze</span> <i class="fas fa-bolt"></i>`; // Restore button text
                if (lastFetchSuccess) {
                    $('errorBox').classList.add('hidden'); // Hide error if last fetch was OK
                }
            }
        }

        function updateStatus(msg) {
            $('loadingStatus').innerText = msg;
        }

        function showError(msg) {
            $('errorText').innerText = `Error: ${msg}. Check console for details. If using the demo key, the quota may be exhausted.`;
            $('errorBox').classList.remove('hidden');
            $('loadingBox').classList.add('hidden');
            $('analyzeBtn').disabled = false;
            $('analyzeBtn').innerHTML = `<span>Analyze</span> <i class="fas fa-bolt"></i>`;
        }

        // --- PROCESSING & RENDERING ---
        function processData() {
            GLOBAL_DATA.totalDuration = GLOBAL_DATA.videos.reduce((acc, v) => acc + v.duration, 0);
            GLOBAL_DATA.totalViews = GLOBAL_DATA.videos.reduce((acc, v) => acc + v.views, 0);
            GLOBAL_DATA.totalLikes = GLOBAL_DATA.videos.reduce((acc, v) => acc + v.likes, 0);
            GLOBAL_DATA.totalComments = GLOBAL_DATA.videos.reduce((acc, v) => acc + v.comments, 0);
        }

        function renderUI() {
            const data = GLOBAL_DATA;
            const count = data.videos.length;

            // Header
            $('headerTitle').innerText = data.meta.title;
            $('headerChannel').innerText = data.meta.channel;
            $('headerThumb').src = data.meta.thumb;
            $('headerLink').href = `https://www.youtube.com/playlist?list=${data.meta.id}`;
            $('headerCount').innerText = `${count} videos`;
            $('headerPrivacy').innerText = data.meta.privacy;

            // Overview Stats
            $('ovDuration').innerText = secondsToText(data.totalDuration, true);
            $('ovAvgDuration').innerText = "Avg: " + secondsToText(data.totalDuration/count, true);
            
            $('ovViews').innerText = formatCompact(data.totalViews);
            $('ovAvgViews').innerText = "Avg: " + formatCompact(data.totalViews/count);

            $('ovLikes').innerText = formatCompact(data.totalLikes);
            const eng = data.totalViews > 0 ? ((data.totalLikes + data.totalComments) / data.totalViews * 100).toFixed(2) : 0;
            $('ovEngagement').innerText = `${eng}% Engagement`;
            $('ovComments').innerText = formatCompact(data.totalComments);

            // Speed Matrix
            $('speed100').innerText = secondsToText(data.totalDuration);
            $('speed125').innerText = secondsToText(data.totalDuration / 1.25);
            $('speed150').innerText = secondsToText(data.totalDuration / 1.5);
            $('speed175').innerText = secondsToText(data.totalDuration / 1.75);
            $('speed200').innerText = secondsToText(data.totalDuration / 2);

            // Spotlight Cards
            const sortedByViews = [...data.videos].sort((a,b) => b.views - a.views);
            const sortedByDate = [...data.videos].sort((a,b) => a.publishedAt - b.publishedAt);
            const sortedByDur = [...data.videos].sort((a,b) => b.duration - a.duration);

            renderSpotlight('cardPopular', sortedByViews[0], 'Most Popular', 'fas fa-fire text-orange-500', v => `${formatCompact(v.views)} views`);
            renderSpotlight('cardOldest', sortedByDate[0], 'Oldest Video', 'fas fa-history text-blue-500', v => v.publishedAt.toLocaleDateString());
            renderSpotlight('cardLongest', sortedByDur[0], 'Longest Video', 'fas fa-hourglass-half text-purple-500', v => secondsToText(v.duration));

            // Populate Table
            populateTable(data.videos);

            // Keywords
            generateKeywords();

            // Show Dashboard
            $('dashboard').classList.remove('hidden');
            switchTab('overview'); // Set default tab
        }

        function renderSpotlight(elementId, video, label, iconClass, subtextFn) {
            if (!video) {
                $(elementId).innerHTML = `<div class="text-slate-500">N/A</div>`;
                return;
            }
            $(elementId).innerHTML = `
                <div class="w-16 h-12 flex-shrink-0 rounded-lg overflow-hidden bg-slate-900">
                    <img src="${video.thumb}" class="w-full h-full object-cover opacity-90">
                </div>
                <div class="min-w-0">
                    <div class="text-xs text-slate-400 font-bold uppercase mb-0.5"><i class="${iconClass} mr-1"></i> ${label}</div>
                    <div class="text-sm font-semibold text-white truncate" title="${video.title}">${video.title}</div>
                    <div class="text-xs text-slate-500">${subtextFn(video)}</div>
                </div>
            `;
        }

        // --- CHARTS & ANALYTICS ---
        function renderCharts() {
            // Destroy existing if re-rendering
            if(charts.views) charts.views.destroy();
            if(charts.years) charts.years.destroy();

            // Chart.js global defaults
            Chart.defaults.color = '#94a3b8';
            Chart.defaults.borderColor = '#334155';
            
            // 1. Top 10 Videos by Views
            const topVideos = [...GLOBAL_DATA.videos].sort((a,b) => b.views - a.views).slice(0, 10).reverse();
            
            const ctxViews = $('chartViews').getContext('2d');
            charts.views = new Chart(ctxViews, {
                type: 'bar',
                data: {
                    labels: topVideos.map(v => v.title.substring(0, 20) + '...'),
                    datasets: [{
                        label: 'Views',
                        data: topVideos.map(v => v.views),
                        backgroundColor: 'rgba(239, 68, 68, 0.6)',
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y', // Horizontal bar chart
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { 
                        y: { grid: { display: false } }, 
                        x: { grid: { color: '#334155' }, ticks: { callback: (v) => formatCompact(v) } } 
                    }
                }
            });

            // 2. Uploads by Year
            const years = {};
            GLOBAL_DATA.videos.forEach(v => {
                const y = v.publishedAt.getFullYear();
                years[y] = (years[y] || 0) + 1;
            });
            
            const ctxYears = $('chartYears').getContext('2d');
            charts.years = new Chart(ctxYears, {
                type: 'line',
                data: {
                    labels: Object.keys(years).sort(),
                    datasets: [{
                        label: 'Videos Uploaded',
                        data: Object.keys(years).sort().map(y => years[y]),
                        borderColor: '#3b82f6',
                        tension: 0.3,
                        fill: true,
                        backgroundColor: 'rgba(59, 130, 246, 0.2)'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { 
                        y: { grid: { color: '#334155' }, beginAtZero: true }, 
                        x: { grid: { color: '#334155' } } 
                    }
                }
            });
        }

        function generateKeywords() {
            const stopWords = new Set(['the','and','a','in','to','for','of','on','with','is','at','that','this','it','com','how','what','why','tutorial','playlist','part','official','feat','full','video','new','best','top']);
            const counts = {};
            GLOBAL_DATA.videos.forEach(v => {
                const words = v.title.toLowerCase().replace(/[^\w\s]|_/g, '').replace(/\s+/g, ' ').split(' ');
                words.forEach(w => {
                    if(w.length > 2 && !stopWords.has(w) && isNaN(w)) {
                        counts[w] = (counts[w] || 0) + 1;
                    }
                });
            });

            const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 20);
            if (!sorted.length) {
                $('keywordCloud').innerHTML = `<span class="text-slate-500">No common keywords found.</span>`;
                return;
            }
            const html = sorted.map(([word, count]) => `
                <span class="px-3 py-1 bg-slate-800 rounded-full text-xs text-slate-300 border border-slate-700 shadow-sm">
                    ${word} <span class="text-red-500 ml-1 font-mono">${count}</span>
                </span>
            `).join('');
            $('keywordCloud').innerHTML = html;
        }

        // --- BINGE PLANNER ---
        function calculatePlan() {
            const speed = parseFloat($('customSelect').dataset.value || 1);
            const hoursPerDay = parseFloat($('planDaily').value);
            
            if(!hoursPerDay || hoursPerDay <= 0) {
                $('planDays').innerText = '-';
                $('planDate').innerText = '...';
                return;
            }

            const totalHoursNeeded = (GLOBAL_DATA.totalDuration / speed) / 3600;
            const daysNeeded = Math.ceil(totalHoursNeeded / hoursPerDay);
            
            $('planDays').innerText = daysNeeded;
            
            const finishDate = new Date();
            finishDate.setDate(finishDate.getDate() + daysNeeded);
            $('planDate').innerText = finishDate.toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' });
        }

        // --- TABLE & FILTERING ---
        let currentSort = { col: 'none', asc: false };

        function populateTable(videos) {
            const tbody = $('videoTableBody');
            tbody.innerHTML = '';
            
            videos.forEach((v, i) => {
                const row = document.createElement('tr');
                row.className = "hover:bg-slate-800/50 transition border-b border-slate-700/50";
                // Escape quotes for onclick function
                const safeTitle = v.title.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                const safeChannel = v.channel.replace(/'/g, "\\'").replace(/"/g, "&quot;");

                row.innerHTML = `
                    <td class="px-6 py-4 font-mono text-slate-500">${i+1}</td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <img src="${v.thumb}" class="w-10 h-10 rounded object-cover hidden sm:block bg-slate-800">
                            <div class="min-w-0">
                                <div class="text-white text-sm font-medium truncate" title="${v.title}">${v.title}</div>
                                <div class="text-[10px] text-slate-500">${v.channel}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-right font-mono text-slate-400">${secondsToText(v.duration)}</td>
                    <td class="px-6 py-4 text-right text-slate-300">${formatCompact(v.views)}</td>
                    <td class="px-6 py-4 text-right text-slate-300">
                        <span class="mr-2"><i class="fas fa-thumbs-up text-[10px] text-slate-500"></i> ${formatCompact(v.likes)}</span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <button onclick="openModal('${v.id}', '${safeTitle}', '${safeChannel}')" class="text-red-500 hover:text-red-400 transition transform hover:scale-110" title="Play Video">
                            <i class="fas fa-play-circle text-lg"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterTable() {
            const query = $('tableSearch').value.toLowerCase();
            const filtered = GLOBAL_DATA.videos.filter(v => v.title.toLowerCase().includes(query) || v.channel.toLowerCase().includes(query));
            populateTable(filtered);
        }

        function sortTable(col) {
            // Update sort icons
            document.querySelectorAll('th i.fa-sort').forEach(icon => icon.className = "fas fa-sort ml-1 opacity-50");
            const icon = $(`th[onclick="sortTable('${col}')"] i`);

            if(currentSort.col === col) {
                currentSort.asc = !currentSort.asc;
            } else { 
                currentSort.col = col; 
                currentSort.asc = true; 
            }
            
            icon.className = `fas ${currentSort.asc ? 'fa-sort-up' : 'fa-sort-down'} ml-1 opacity-100`;

            const filtered = GLOBAL_DATA.videos.filter(v => v.title.toLowerCase().includes($('tableSearch').value.toLowerCase()));

            const sorted = [...filtered].sort((a,b) => {
                let valA = col === 'title' ? a.title.toLowerCase() : a[col];
                let valB = col === 'title' ? b.title.toLowerCase() : b[col];
                
                if (valA < valB) return currentSort.asc ? -1 : 1;
                if (valA > valB) return currentSort.asc ? 1 : -1;
                return 0;
            });
            populateTable(sorted);
        }

        function exportCSV() {
            let csv = "Title,Channel,Duration(s),Views,Likes,Comments,URL\n";
            GLOBAL_DATA.videos.forEach(v => {
                const title = `"${v.title.replace(/"/g, '""')}"`;
                csv += `${title},"${v.channel}",${v.duration},${v.views},${v.likes},${v.comments},https://youtu.be/${v.id}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${GLOBAL_DATA.meta.title.replace(/[^a-z0-9]/gi, '_')}_analysis.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // --- Modal Logic ---
        function openModal(videoId, title, channel) {
            const iframe = $('videoIframe');
            const loader = $('iframeLoader');
            
            $('modalTitle').innerText = title;
            $('modalChannel').innerText = channel;
            
            // Show loader, hide iframe
            loader.classList.remove('hidden');
            iframe.classList.add('opacity-0');
            
            iframe.onload = () => {
                // Hide loader, show iframe
                loader.classList.add('hidden');
                iframe.classList.remove('opacity-0');
            };
            
            iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&modestbranding=1&rel=0&hl=en`;
            
            document.body.classList.add('modal-open');
        }

        function closeModal() {
            $('videoIframe').src = 'about:blank'; // Stop video
            document.body.classList.remove('modal-open');
        }

        // --- Custom Select Logic ---
        function setupCustomSelect() {
            const select = $('customSelect');
            const trigger = $('selectTrigger');
            const valueSpan = $('selectValue');
            const optionsPanel = $('selectOptions');
            const options = document.querySelectorAll('.select-option');
            const icon = trigger.querySelector('i');

            const openSelect = () => {
                optionsPanel.classList.remove('hidden', 'opacity-0', '-translate-y-2');
                icon.classList.add('rotate-180');
            }
            
            const closeSelect = () => {
                optionsPanel.classList.add('opacity-0', '-translate-y-2');
                icon.classList.remove('rotate-180');
                // Allow animation to finish before hiding
                setTimeout(() => optionsPanel.classList.add('hidden'), 200);
            }

            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                if (optionsPanel.classList.contains('hidden')) {
                    openSelect();
                } else {
                    closeSelect();
                }
            });

            options.forEach(option => {
                option.addEventListener('click', (e) => {
                    const newValue = e.currentTarget.dataset.value;
                    const newText = e.currentTarget.innerText;
                    
                    select.dataset.value = newValue;
                    valueSpan.innerText = newText;
                    closeSelect();
                    calculatePlan(); // Recalculate on change
                });
            });

            // Close when clicking outside
            document.addEventListener('click', (e) => {
                if (!select.contains(e.target)) {
                    closeSelect();
                }
            });
        }
        
        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            setupCustomSelect();
        });

    </script>
</body>
</html>
