<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Imposter • Find the Spy</title>
    
    <!-- Favicon -->
    <link rel="icon" href="https://em-content.zobj.net/source/microsoft/379/disguised-face_1f978.png" type="image/png">

	<!-- Social Media / Share Metadata (Open Graph & Twitter) -->
    <meta property="og:title" content="Imposter • Find the Spy" />
    <meta property="og:description" content="Can you blend in? Find the spy before time runs out. Play with friends online or on one device!" />
    
    <meta property="og:url" content="https://imposteronline.github.io/" />
    
    <meta property="og:image" content="https://www.pngall.com/wp-content/uploads/19/Shh-Emoji-Gentle-Reminder-Icon-PNG.png" />
    
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Imposter • Find the Spy" />
    <meta name="twitter:description" content="Can you blend in? Find the spy before time runs out. Play with friends online or on one device!" />
    
    <!-- Same image link as above -->
    <meta name="twitter:image" content="https://www.pngall.com/wp-content/uploads/19/Shh-Emoji-Gentle-Reminder-Icon-PNG.png" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@400;500;700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Outfit', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        slate: {
                            850: '#151e2e',
                            950: '#020617',
                        },
                        brand: {
                            400: '#a78bfa',
                            500: '#8b5cf6',
                            600: '#7c3aed',
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'shine': 'shine 1.5s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        slideUp: {
                            'from': { transform: 'translateY(20px)', opacity: '0' },
                            'to': { transform: 'translateY(0)', opacity: '1' },
                        },
                        fadeIn: {
                            'from': { opacity: '0' },
                            'to': { opacity: '1' },
                        },
                        shine: {
                            '0%': { transform: 'translateX(-100%) translateY(-100%) rotate(45deg)' },
                            '100%': { transform: 'translateX(100%) translateY(100%) rotate(45deg)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
		html, body {
            position: fixed;
            inset: 0;
            overflow: hidden;
        }
		
        :root {
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        body {
            background-color: #020617;
            color: #f8fafc;
            /* overflow: hidden; is now handled by the 'html, body' rule above */
            -webkit-tap-highlight-color: transparent;
            touch-action: none; /* This prevents panning/scrolling gestures */
            height: 100%; /* Use 100% which works best with position: fixed */
            width: 100%;
            user-select: none;
            -webkit-user-select: none;
        }
        
        img {
            -webkit-user-drag: none;
            user-drag: none;
            -webkit-touch-callout: none;
            pointer-events: none;
        }

        /* Modern Glassmorphism */
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
        }

        .glass-panel-lighter {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* 3D Flip Animation Classes */
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .rotate-y-0 { transform: rotateY(0deg); }

        /* Supercell Background Animation */
        .supercell-container {
            position: absolute;
            inset: 0;
            overflow: hidden;
            z-index: 0;
            border-radius: inherit;
        }

        .supercell-bg-1, .supercell-bg-2 {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            mix-blend-mode: overlay;
            opacity: 0; /* Both start invisible */
            animation: alternateFade 16s infinite; /* A bit faster looks better */
        }

        .supercell-bg-1 {
            background-image: url('https://www.clashchamps.com/wp-content/uploads/2024/06/czJOx2-Q.png');
            /* No delay */
        }

        .supercell-bg-2 {
            background-image: url('https://wallpapercat.com/w/full/0/4/f/283609-2500x1466-desktop-hd-clash-of-clans-wallpaper.jpg');
            animation-delay: 8s; /* Half the duration delay */
        }

        @keyframes alternateFade {
            0%   { opacity: 0; animation-timing-function: ease-in; }
            25%  { opacity: 0.6; }
            50%  { opacity: 0.6; animation-timing-function: ease-out; }
            75%  { opacity: 0; }
            100% { opacity: 0; }
        }

        /* Ambient Blobs */
        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            z-index: 0;
            animation: blob-bounce 10s infinite ease-in-out;
        }
        @keyframes blob-bounce {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
        }
        
		/* --- Corrected Timer Slider Styles --- */

		/* Style the track for Webkit (Chrome, Safari) */
		.timer-slider::-webkit-slider-runnable-track {
		  width: 100%;
		  height: 8px; /* This creates the thin line */
		  cursor: pointer;
		  background: #0f172a; /* This was the old bg-slate-950 */
		  border-radius: 9999px; /* This was the old rounded-full */
		}

		/* Style the thumb for Webkit (Chrome, Safari) */
		.timer-slider::-webkit-slider-thumb {
		  -webkit-appearance: none;
		  /* This margin calculation perfectly centers the 28px thumb on the 8px track */
		  margin-top: -10px; 
		  height: 28px;
		  width: 28px;
		  background-image: url('https://em-content.zobj.net/source/microsoft-teams/337/three-oclock_1f552.png');
		  background-size: contain;
		  background-repeat: no-repeat;
		  background-position: center;
		  background-color: transparent;
		  cursor: pointer;
		  box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
		  border-radius: 50%;
		}

		/* Style the track for Firefox */
		.timer-slider::-moz-range-track {
		  width: 100%;
		  height: 8px;
		  cursor: pointer;
		  background: #0f172a;
		  border-radius: 9999px;
		}

		/* Style the thumb for Firefox */
		.timer-slider::-moz-range-thumb {
		  width: 28px;
		  height: 28px;
		  background-image: url('https://em-content.zobj.net/source/microsoft-teams/337/three-oclock_1f552.png');
		  background-size: contain;
		  background-repeat: no-repeat;
		  background-position: center;
		  background-color: transparent;
		  border: none;
		  cursor: pointer;
		  box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
		  border-radius: 50%;
		}

        /* Subtle Shine Effect */
        .subtle-shine-container {
            position: relative;
            overflow: hidden;
            isolation: isolate; /* Creates a new stacking context */
        }

        .subtle-shine-container::before {
            content: '';
            position: absolute;
            inset: 0;
            /* A very subtle, faded gradient */
            background: linear-gradient(
                110deg,
                transparent 30%,
                rgba(255, 255, 255, 0.06) 48%,
                rgba(255, 255, 255, 0.06) 52%,
                transparent 70%
            );
            transform: translateX(-100%);
            /* Slower, smoother, faded animation loop */
            animation: subtleShine 7s ease-in-out infinite;
        }

        @keyframes subtleShine {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }
    </style>
</head>
<body class="select-none">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- FIREBASE SETUP ---
        const firebaseConfig = {
          apiKey: "AIzaSyCebdOffzrb0D2efbgC9eDPRAr-hYgIXS8",
          authDomain: "imposter-e571f.firebaseapp.com",
          projectId: "imposter-e571f",
          storageBucket: "imposter-e571f.firebasestorage.app",
          messagingSenderId: "318719643356",
          appId: "1:318719643356:web:994fb32e845e6df743ae19",
          measurementId: "G-KHJRQCSH8Z"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        // --- END FIREBASE SETUP ---

        // --- DATA ---
		  const WORD_BANK = {
		  Supercell: [
			"Example"
		  ],

          Celebs: [
			"Example"
		  ],

		  Movies: [
			"Example"
		  ],

		  Food: [
		    "Example"
		  ],

		  Brands: [
		    "Example"
		  ],

		  Technology: [
		    "Example"
		  ],

		  TV: [
		    "Example"
		  ],

		  Jobs: [
			"Example"
		  ],

		  Mythology: [
			"Example"
		  ],

		  Sport: [
			"Example"
		  ],

		  Places: [
			"Example"
		  ],

		  Instruments: [
			"Example"
		  ],

		  Superheroes: [
			"Example"
		  ],

		  Animals: [ 
			"Example"
		  ],

		  Countries: [
			"Example"
		  ],

		  "Video Games": [
			"Example"
		  ],

		  Science: [
			"Example"
		  ],

		  Clothing: [
			 "Example"
		  ],

		  Home: [
			"Example"
		  ],

		  People: [
			"Example"
		  ],
		  
		 "Historical Figures": [
		   "Example"
		 ],

          "Board Games": [
			"Example"
		  ],

		  "Famous Landmarks": [
		    "Example"
		  ],
            
		  Music: [
		    "Example"
		  ],

		  School: [
			"Example"
		  ]
		};
		
        const CATEGORY_ICONS = {
            Supercell: "https://twitch.supercell.com/supercell-logo.png",
            Celebs: "https://em-content.zobj.net/source/microsoft-teams/337/smiling-face-with-sunglasses_1f60e.png",
            Movies: "https://em-content.zobj.net/source/microsoft-teams/337/popcorn_1f37f.png",
            Food: "https://em-content.zobj.net/source/microsoft-teams/363/hamburger_1f354.png",
            Brands: "https://em-content.zobj.net/source/microsoft-teams/337/shopping-bags_1f6cd-fe0f.png",
            Technology: "https://em-content.zobj.net/source/microsoft-teams/337/gear_2699-fe0f.png",
            TV: "https://em-content.zobj.net/source/microsoft-teams/337/television_1f4fa.png",
            Jobs: "https://em-content.zobj.net/source/microsoft-teams/337/briefcase_1f4bc.png",
            Mythology: "https://em-content.zobj.net/source/microsoft-teams/337/dragon-face_1f432.png", 
            Sport: "https://em-content.zobj.net/source/microsoft-teams/337/trophy_1f3c6.png",
            Places: "https://em-content.zobj.net/source/microsoft-teams/337/cityscape_1f3d9-fe0f.png",
            Instruments: "https://em-content.zobj.net/source/microsoft-teams/364/guitar_1f3b8.png",
            Superheroes: "https://em-content.zobj.net/source/microsoft-teams/337/superhero_light-skin-tone_1f9b8-1f3fb_1f3fb.png",
            Animals: "https://em-content.zobj.net/source/microsoft-teams/337/dog-face_1f436.png",
            Countries: "https://em-content.zobj.net/source/microsoft-teams/337/globe-showing-americas_1f30e.png",
            "Video Games": "https://em-content.zobj.net/source/microsoft-teams/337/joystick_1f579-fe0f.png",
            Science: "https://em-content.zobj.net/source/microsoft-teams/363/scientist-light-skin-tone_1f9d1-1f3fb-200d-1f52c.png",
            Clothing: "https://em-content.zobj.net/source/microsoft-teams/337/t-shirt_1f455.png",
            Home: "https://em-content.zobj.net/source/microsoft-teams/337/house_1f3e0.png",
            People: [
                "https://em-content.zobj.net/source/microsoft-teams/337/person_light-skin-tone_1f9d1-1f3fb_1f3fb.png",
                "https://em-content.zobj.net/source/microsoft-teams/337/old-man_light-skin-tone_1f474-1f3fb_1f3fb.png",
                "https://em-content.zobj.net/source/microsoft-teams/337/boy_medium-dark-skin-tone_1f466-1f3fe_1f3fe.png",
                "https://em-content.zobj.net/source/microsoft-teams/337/boy_medium-light-skin-tone_1f466-1f3fc_1f3fc.png",
                "https://em-content.zobj.net/source/microsoft-teams/337/woman-medium-light-skin-tone-red-hair_1f469-1f3fc-200d-1f9b0.png"
            ],
            "Historical Figures": "https://em-content.zobj.net/source/microsoft-teams/337/bust-in-silhouette_1f464.png",
            "Board Games": "https://em-content.zobj.net/source/microsoft-teams/337/game-die_1f3b2.png",
            "Famous Landmarks": "https://em-content.zobj.net/source/microsoft-teams/337/statue-of-liberty_1f5fd.png",
            Music: "https://em-content.zobj.net/source/microsoft-teams/337/musical-notes_1f3b6.png",
            School: "https://em-content.zobj.net/source/microsoft-teams/337/woman-teacher-light-skin-tone_1f469-1f3fb-200d-1f3eb.png",
        };

        const AUDIO_URLS = {
            // SFX (not affected by mute)
            startMission: "https://www.dropbox.com/scl/fi/6mqqjkan6k1z9b3rqv19m/01HX9JKSR2BK842A7XV43SW8Z0.mp3?rlkey=j9bf35mocbr2rceiunaak8r7i&raw=1",
            startRandomMission: "https://www.dropbox.com/scl/fi/9gl6f796t9szuen6f4y6p/01HXW72GB6SAGDFW8VBC8X25F2.mp3?rlkey=1392vzqlrk6dps0a8763us7uf&raw=1",
            selectCategory: "https://www.dropbox.com/scl/fi/tjwfrllo8lsb23t0abu27/01HWD5XAX15KKAKASJCBS18SMC.mp3?rlkey=82jumuuttcx9a0qdo98bp3wty&raw=1",
            deselectCategory: "https://www.dropbox.com/scl/fi/z9s27e8cx9zi4c9yg9zs9/01HWD5XAR2DPE0H1ZXJCBMF4MX.mp3?rlkey=54rmyfgzcntew0e0qy1lbf98z&raw=1",
            playAgain: "https://www.dropbox.com/scl/fi/o822ufm5jz0y0imeait4m/01HX6MKWSBBS0FW45A5N35AT5Z.mp3?rlkey=pwnm13xyxu5jo33pjgs2wyvyj&raw=1",
            switchOn: "https://www.dropbox.com/scl/fi/wttc9l7ujwjfjw8wuif7z/01HWD5XAV5T7SNYPM79JSPYJTP-1.mp3?rlkey=no7fuxmbz3bcgmtvaje61l5vy&raw=1",
            switchOff: "https://www.dropbox.com/scl/fi/ypnd4hikcnj69qi9y205k/01HWD5XB1GFY4G3Y4AZTC1GN2R.mp3?rlkey=m04pff93t90o6xkoktwqlv6wb&raw=1",
            uiClick: "https://www.dropbox.com/scl/fi/ww27xdd3abq3ozc0heds8/01HWD5XBKANVPZVCCTP7THR7Q2.mp3?rlkey=6httxc42qx2h3e7cfj16jvpbr&raw=1",
            openInfo: "https://www.dropbox.com/scl/fi/z3o61q4zqex0d4081r6ej/01HWD5XB2JFXRPXHS6VSGTFTMG.mp3?rlkey=o4j1j0zroc5tpseqa0z9stbdz&raw=1",
            toggleMode: "https://www.dropbox.com/scl/fi/a0csiwttotrzam52xos84/01HWD5XBNZEHSRDXY96T1W5E18.mp3?rlkey=wgjt1yzesree78p5bzroum1cd&raw=1",
            turnOrderReveal: "https://www.dropbox.com/scl/fi/wk1fguj7rf9u5t1hlaeq2/01HYDYM99NTN52107R03DRVHWV.mp3?rlkey=dy0a819d3z8l91uf08kdjpk6w&st=7tcwrkwi&raw=1",
            
            // Critical alerts & results (not affected by mute)
            alarm: "https://www.dropbox.com/scl/fi/33ljaplfdfse9h9xrqkia/01J9RASVSTKGV6WQ2GKBY86R84.mp3?rlkey=dhsr2ygnox9se0s88uklsfa5l&st=25yswvvu&raw=1",
            imposterWin: "https://www.dropbox.com/scl/fi/dcwhziv1s6y2esdeyshlr/01HSH4TXDZMFD17MZ6X052DSDK.mp3?rlkey=k125vxojv60ef1uimtqwvbmqr&st=k6mrbuoj&raw=1",
            agentWin: "https://www.dropbox.com/scl/fi/dfq6utr0g3ipxd7ie61iw/01HSH4PEC9GGB6AFS60K6059HB-1.mp3?rlkey=hr5l3w6ipwpq3uyo8vspo8slh&st=oqb5yhnp&raw=1",

            // Background Music (affected by mute)
            mainMenuMusic: "https://www.dropbox.com/scl/fi/2ptwdl60l1d8uonk2565r/01K2F0QVDH804F7BRXZM49PGP6.mp3?rlkey=xup3gy3mvh0s074m0exikou6m&st=b6sy1eaj&raw=1",
            categorySelectionMusic: "https://www.dropbox.com/scl/fi/tpqgmp0vic0fkwu2qa4z6/01K4783N93TC27JX716223WV45.mp3?rlkey=6gl82wcrpvioch4y30q7yaoij&st=nd1z0omz&raw=1",
            timerMusic: "https://www.dropbox.com/scl/fi/rw6a1k3er9zua9hy50y7r/01HSGT383SN8Y723GMVHWEGF1S.mp3?rlkey=o9inopsmgmztzh439pm3yqmw2&st=aqyn9x8c&raw=1",
            
            // Voice overs
            categories: {
                Supercell: "https://www.dropbox.com/scl/fi/8ebrjg08up658r0r1l20r/ElevenLabs_2025-12-15T08_16_40_Cornelius_pvc_sp100_s50_sb75_v3.mp3?rlkey=5e4wyoyeueev4zw5m0hsnn5kn&raw=1",
                Celebs: "https://www.dropbox.com/scl/fi/hzt3egh9lr83ua2qbzots/ElevenLabs_2025-12-15T08_18_49_Cornelius_pvc_sp100_s50_sb75_v3.mp3?rlkey=ox4hhf4k01vqeub4n92rusbtt&raw=1",
                Movies: "https://www.dropbox.com/scl/fi/42kj3rmyzt94t8sbcnh9t/ElevenLabs_2025-12-15T08_20_15_Cornelius_pvc_sp100_s50_sb75_v3.mp3?rlkey=ai0g0f6jzy98u9qvtsjyw6dna&raw=1",
                Food: "https://www.dropbox.com/scl/fi/eq07yw6djh5il36mfwkao/ElevenLabs_2025-12-15T08_21_33_Cornelius_pvc_sp100_s50_sb75_v3.mp3?rlkey=li1g1jblyxj0eivyldagpuwp4&raw=1",
                Brands: "https://www.dropbox.com/scl/fi/6jgyalizd34oikhfjxhjc/ElevenLabs_2025-12-15T08_22_46_Cornelius_pvc_sp100_s50_sb75_v3.mp3?rlkey=07ogqqlh1qxg7cpn0neekfsqv&raw=1",
                Technology: "https://www.dropbox.com/scl/fi/gaq3bohzoi8sosns9olkd/ElevenLabs_2025-12-15T08_23_41_Cornelius_pvc_sp100_s50_sb75_v3.mp3?rlkey=v9zsg3i0sgjfrcfae50mppid2&raw=1",
                TV: "https://www.dropbox.com/scl/fi/akhpp5u75pdzh9icg33mo/ElevenLabs_2025-12-15T18_17_44_Cornelius_pvc_sp100_s50_sb75_v3.mp3?rlkey=o4lfbwubfvc1okpnga3ppj38l&raw=1",
                Jobs: "https://www.dropbox.com/scl/fi/zi2ggltharedj9bbwzfeg/ElevenLabs_2025-12-15T08_25_23_Cornelius_pvc_sp100_s50_sb75_v3.mp3?rlkey=xz9g6qscw0e2j2p4fzaap55dr&raw=1",
                Mythology: "https://www.dropbox.com/scl/fi/az8vf55cavmg8yw1ujl51/ElevenLabs_2025-12-15T08_26_13_Cornelius_pvc_sp100_s50_sb75_v3.mp3?rlkey=xf5pa1mtm7ovpklf0u4mev68u&raw=1",
                Sport: "https://www.dropbox.com/scl/fi/mtasry0x1rsbkdetzfjde/ElevenLabs_2025-12-15T08_27_37_Cornelius_pvc_sp100_s50_sb75_v3.mp3?rlkey=ps81bq9m31hqkyi9orq0zcv25&raw=1",
                Places: "https://www.dropbox.com/scl/fi/2cqnpjiwxg92cy2jsafcg/ElevenLabs_2025-12-15T08_28_27_Cornelius_pvc_sp100_s50_sb75_v3.mp3?rlkey=68iifrvmfc7g7wxg5b5p4kj9v&raw=1",
                Instruments: "https://www.dropbox.com/scl/fi/voh9inpojdxru6hrmi7ic/ElevenLabs_2025-12-15T08_29_22_Cornelius_pvc_sp100_s50_sb75_v3.mp3?rlkey=9ff7iivutejrfsim7wk3mic1w&raw=1",
                Superheroes: "https://www.dropbox.com/scl/fi/p5xbsz50if9i75pras2og/ElevenLabs_2025-12-15T08_38_43_Cornelius_pvc_sp100_s50_sb75_v3.mp3?rlkey=cvsc91cryxm94sfetmntb630s&raw=1",
                Animals: "https://www.dropbox.com/scl/fi/fhty3jkw4g43v32a82wa5/ElevenLabs_2025-12-15T08_41_39_Cornelius_pvc_sp100_s50_sb75_v3.mp3?rlkey=kefs2jzmt9lealfbi20jz80xy&raw=1",
                Countries: "https://www.dropbox.com/scl/fi/7ogj4vdnm8vgv8l06q851/ElevenLabs_2025-12-15T08_42_31_Cornelius_pvc_sp100_s50_sb75_v3.mp3?rlkey=xj31mwhkj3gnkdtfagqendwo5&raw=1",
                "Video Games": "https://www.dropbox.com/scl/fi/e95u1v2ugjqjyndkzbr5x/ElevenLabs_2025-12-15T08_43_37_Cornelius_pvc_sp100_s50_sb75_v3.mp3?rlkey=h8fi9gfb9fabe46sfambcwdse&raw=1",
                Science: "https://www.dropbox.com/scl/fi/ir5zqotuomxllzs9rrtkk/ElevenLabs_2025-12-15T08_44_27_Cornelius_pvc_sp100_s50_sb75_v3.mp3?rlkey=e3556mc64aaa6w86nhfe7meu6&raw=1",
                Clothing: "https://www.dropbox.com/scl/fi/j9ufwciweptnoezljo8ut/ElevenLabs_2025-12-15T08_45_27_Cornelius_pvc_sp100_s50_sb75_v3.mp3?rlkey=edhoon9hrhxm8k46t1rao01rp&raw=1",
                Home: "https://www.dropbox.com/scl/fi/d833xr5wu9aonnpj2guv1/ElevenLabs_2025-12-15T08_47_02_Cornelius_pvc_sp100_s50_sb75_v3.mp3?rlkey=kxugvsnlwtofbke9bcn1gwxl0&raw=1",
                People: "https://www.dropbox.com/scl/fi/4nqyxqkzkihhay2ocqx3x/ElevenLabs_2025-12-15T08_47_55_Cornelius_pvc_sp100_s50_sb75_v3.mp3?rlkey=0bcjbnbv1vzlyj7q53hiyb9et&raw=1",
                "Historical Figures": "https://www.dropbox.com/scl/fi/loo1iw5wyh8bpv5lmoygo/ElevenLabs_2025-12-15T14_24_36_Cornelius_pvc_sp100_s50_sb75_v3-1.mp3?rlkey=1fca4p6w65i6mm0eu10x299qk&raw=1",
                "Board Games": "https://www.dropbox.com/scl/fi/g591eqdqmeb3f7b5tkk9c/ElevenLabs_2025-12-15T14_28_29_Cornelius_pvc_sp100_s50_sb75_v3.mp3?rlkey=pb4ni2jbejp3ipm1ukshbqskn&raw=1",
                "Famous Landmarks": "https://www.dropbox.com/scl/fi/r626enpj8238gm2y1pbe2/ElevenLabs_2025-12-15T14_29_34_Cornelius_pvc_sp100_s50_sb75_v3.mp3?rlkey=cl0l16f5prizvydvcutl6gk5c&raw=1",
                Music: "https://www.dropbox.com/scl/fi/v9sf5kdv7n5j8va5wd5e0/ElevenLabs_2025-12-16T08_52_40_Cornelius_pvc_sp100_s50_sb75_v3.mp3?rlkey=58b05s7sniamze9ynzvnfbd3r&raw=1",
                School: "https://www.dropbox.com/scl/fi/lblzn777kgiswpnofikq7/ElevenLabs_2025-12-17T18_43_24_Cornelius_pvc_sp100_s50_sb75_v3.mp3?rlkey=h6aeq6c31rj05u57x4w9xjvoo&raw=1",
            }
        };

		
        const DISPLAY_CATEGORIES = ['Supercell', ...Object.keys(WORD_BANK).filter(c => c !== 'Supercell')];
		
		// --- DYNAMIC WORD COUNT CALCULATION ---
        const totalWords = Object.values(WORD_BANK).reduce((sum, category) => sum + category.length, 0);
        const roundedWordCount = Math.floor(totalWords / 250) * 250;
        
        // --- COMPONENTS ---

        const PlayerAvatar = ({ name, className = "" }) => {
            if (!name) return null;
            const avatarUrl = `https://api.dicebear.com/9.x/croodles-neutral/svg?seed=${encodeURIComponent(name)}`;
            
            // This cleaner filter just inverts the color, making black lines white.
            const monochromeFilter = { filter: 'invert(1)' };

            return (
                <img
                    src={avatarUrl}
                    alt={`${name}'s avatar`}
                    className={`flex-shrink-0 ${className}`}
                    style={monochromeFilter}
                    draggable="false"
                    onError={(e) => { e.target.style.display = 'none'; }}
                />
            );
        };

        // NEW: How to Play Modal
		const HowToPlayModal = ({ onClose }) => {
			const scenarios = {
				imposter: [
					{
						title: 'Scenario: The Word is "Shark"',
						agentWord: "Shark",
						imposterWord: "None",
						clues: [
							{ player: "Alice (Agent)", clue: "This creature lives in the ocean." },
							{ player: "Dan (Imposter)", clue: "It's a type of animal." },
							{ player: "Charlie (Agent)", clue: "It has a prominent fin." },
						],
						explanation: "Dan's clue is very generic. While true, it suggests he's waiting for more information before committing to a specific idea. Alice and Charlie's specific clues put pressure on Dan to be more detailed, which can expose him as the Imposter.",
					},
					{
						title: 'Scenario: The Word is "Guitar"',
						agentWord: "Guitar",
						imposterWord: "None",
						clues: [
							{ player: "Dave (Agent)", clue: "It's a musical instrument with strings." },
							{ player: "Eve (Imposter)", clue: "You can play music with it." },
							{ player: "Frank (Agent)", clue: "Many rock bands have at least one of these." },
						],
						explanation: "Eve's clue, much like Dan's in the previous example, is overly broad. It could apply to a piano, violin, or drums. The other agents can use this vagueness to identify her as the one who doesn't know the specific word.",
					},
				],
				fakeWord: [
					{
						title: 'Scenario: The Word is "Apple"',
						agentWord: "Apple",
						fakeWordPlayer: "Ben",
						fakeWord: "Banana",
						clues: [
							{ player: "Cloe (Agent)", clue: "This can be red or green." },
							{ player: "Ben (Fake Word Player)", clue: "It's long and you have to peel it." },
							{ player: "Michael (Agent)", clue: "A famous tech company is named after it." },
						],
						explanation: "Ben's confidence is his downfall. Unlike an Imposter who might say 'It's a fruit,' Ben gives specific details for the wrong word. This is the key to identifying the Fake Word holder.",
					},
					{
						title: 'Scenario: The Word is "Paris"',
						agentWord: "Paris",
						fakeWordPlayer: "Grace",
						fakeWord: "Rome",
						clues: [
							{ player: "Heidi (Agent)", clue: "This city has a famous tower." },
							{ player: "Grace (Fake Word Player)", clue: "You can see the Colosseum here." },
							{ player: "Ivan (Agent)", clue: "It's known as the 'City of Love'." },
						],
						explanation: "Grace, believing the word is Rome, gives a very specific and correct clue for her word. However, it directly contradicts the clues for Paris, immediately outing her as the player with the different word.",
					},
				],
			};

			const [currentImposterScenario, setCurrentImposterScenario] = React.useState(0);
			const [currentFakeWordScenario, setCurrentFakeWordScenario] = React.useState(0);

			const nextImposterScenario = () => {
				setCurrentImposterScenario((prev) => Math.min(prev + 1, scenarios.imposter.length - 1));
			};

			const prevImposterScenario = () => {
				setCurrentImposterScenario((prev) => Math.max(prev - 1, 0));
			};

			const nextFakeWordScenario = () => {
				setCurrentFakeWordScenario((prev) => Math.min(prev + 1, scenarios.fakeWord.length - 1));
			};

			const prevFakeWordScenario = () => {
				setCurrentFakeWordScenario((prev) => Math.max(prev - 1, 0));
			};
			
			// Mobile touch handling
			const useSwipe = (onSwipeLeft, onSwipeRight) => {
				const [touchStart, setTouchStart] = React.useState(null);

				const handleTouchStart = (e) => {
					setTouchStart(e.targetTouches[0].clientX);
				};

				const handleTouchMove = (e) => {
					if (touchStart === null) {
						return;
					}

					const currentTouch = e.targetTouches[0].clientX;
					const diff = touchStart - currentTouch;

					if (diff > 5) {
						onSwipeLeft();
					} else if (diff < -5) {
						onSwipeRight();
					}

					setTouchStart(null);
				};

				return { onTouchStart: handleTouchStart, onTouchMove: handleTouchMove };
			};
			
			const imposterSwipeHandlers = useSwipe(nextImposterScenario, prevImposterScenario);
			const fakeWordSwipeHandlers = useSwipe(nextFakeWordScenario, prevFakeWordScenario);


			return (
				<div className="fixed inset-0 z-50 flex items-center justify-center p-4 animate-fadeIn">
					<div className="absolute inset-0 bg-black/70 backdrop-blur-md" onClick={onClose}></div>
					<div className="relative w-full max-w-lg h-[90vh] glass-panel rounded-3xl border border-white/10 shadow-2xl animate-slide-up flex flex-col">
						<div className="flex-shrink-0 p-6 flex items-center justify-between border-b border-white/10">
							<h2 className="text-2xl font-display font-bold text-white flex items-center gap-3">
								<i className="fa-solid fa-book-open text-brand-400"></i>
								How to Play
							</h2>
							<button onClick={onClose} className="w-10 h-10 flex items-center justify-center bg-white/5 rounded-full text-white/50 hover:bg-white/10 active:scale-90 transition">
								<i className="fa-solid fa-xmark"></i>
							</button>
						</div>
						
						<div className="flex-1 overflow-y-auto no-scrollbar p-6 space-y-8 text-white/80 leading-relaxed">
							{/* Section 1: Objective */}
							<section>
								<h3 className="font-bold text-lg text-brand-400 mb-2 flex items-center gap-2">
									<img src="https://em-content.zobj.net/source/microsoft-teams/337/direct-hit_1f3af.png" alt="Objective Icon" className="w-8 h-8" />
									Primary Objective
								</h3>
								<p>A battle of wits and deception. In the classic game, the <span className="text-teal-400 font-semibold">Agents</span> must identify the <span className="text-red-400 font-semibold">Imposter</span>. In the alternate "Fake Word" mode, they must find the player who was given a different secret word.</p>
							</section>

							{/* Section 2: Setup */}
							<section>
								<h3 className="font-bold text-lg text-brand-400 mb-2 flex items-center gap-2">
									<img src="https://em-content.zobj.net/source/microsoft-teams/363/detective_light-skin-tone_1f575-1f3fb_1f3fb.png" alt="Setup Icon" className="w-8 h-8" style={{ position: 'relative', top: '-2px' }} />
									The Setup: Mission Secrecy
								</h3>
								<p>At the start of each round, every player receives a secret role. <span className="text-teal-400 font-semibold">Agents</span> get the same secret word. The role of the outsider depends on the game mode:</p>
								<div className="mt-3 space-y-2 text-sm pl-4">
									<p>• <strong>Classic Mode:</strong> The <span className="text-red-400 font-semibold">Imposter</span> gets no word and must deduce it from clues.</p>
									<p>• <strong>Fake Word Mode:</strong> One Agent receives a <span className="text-yellow-400 font-semibold">different word</span> from the same category. They don't know their word is the fake one!</p>
								</div>
								<div className="mt-3 bg-white/5 p-3 rounded-lg border border-white/10 text-sm">
									<p><i className="fa-solid fa-lightbulb text-yellow-400 mr-2"></i><strong>Pro-Tip:</strong> Press and hold a category during setup to see example words. This is crucial for getting a feel for the possibilities before the round begins!</p>
								</div>
							</section>
							
							{/* Section 3: Gameplay */}
							<section>
								<h3 className="font-bold text-lg text-brand-400 mb-2 flex items-center gap-2">
									<img src="https://em-content.zobj.net/source/microsoft-teams/364/speaking-head_1f5e3-fe0f.png" alt="Gameplay Icon" className="w-8 h-8" />
									Gameplay: The Art of Deception
								</h3>
								<p>Players take turns talking about the secret word without actually saying it. The goal is to prove you know the word while trying to spot who doesn't. Common ways to play include:</p>
								<div className="mt-3 space-y-2">
									<p>• <strong>State a Fact:</strong> Each player, in turn, says one known fact or description about the word.</p>
									<p>• <strong>Ask a Question:</strong> Players take turns asking the *next* player in the turn order a question related to the word.</p>
								</div>
							</section>

							{/* NEW Section: Imposter Mode Scenarios */}
							<section>
								<h3 className="font-bold text-lg text-red-400 mb-2 flex items-center gap-2">
									<img src="https://em-content.zobj.net/source/microsoft-teams/363/eyes_1f440.png" alt="Imposter Icon" className="w-7 h-7 -mt-1" />
									Deception Deep Dive: Imposter Mode
								</h3>
								<div className="relative">
									<div className="bg-white/5 p-4 rounded-xl border border-white/10" {...imposterSwipeHandlers}>
										<h4 className="font-bold text-base text-white/90 mb-2">{scenarios.imposter[currentImposterScenario].title}</h4>
										<div className="text-sm space-y-2 pl-2">
											<p>• <strong>Agents' Word:</strong> <span className="text-teal-300">{scenarios.imposter[currentImposterScenario].agentWord}</span> | <strong>Imposter's Word:</strong> <span className="text-red-300">{scenarios.imposter[currentImposterScenario].imposterWord}</span></p>
											<hr className="border-white/10 my-2" />
											{scenarios.imposter[currentImposterScenario].clues.map((clue, index) => (
												<p key={index}>• <strong>{clue.player}:</strong> "{clue.clue}"</p>
											))}
										</div>
										<p className="mt-3 text-xs text-white/60">
											{scenarios.imposter[currentImposterScenario].explanation}
										</p>
									</div>
									<button onClick={prevImposterScenario} className="hidden md:flex absolute top-1/2 -left-4 -translate-y-1/2 w-8 h-8 items-center justify-center bg-white/10 rounded-full text-white/50 hover:bg-white/20 active:scale-90 transition">
										<i className="fa-solid fa-chevron-left"></i>
									</button>
									<button onClick={nextImposterScenario} className="hidden md:flex absolute top-1/2 -right-4 -translate-y-1/2 w-8 h-8 items-center justify-center bg-white/10 rounded-full text-white/50 hover:bg-white/20 active:scale-90 transition">
										<i className="fa-solid fa-chevron-right"></i>
									</button>
								</div>
							</section>

							{/* NEW Section: Fake Word Mode Scenarios */}
							<section>
								<h3 className="font-bold text-lg text-yellow-400 mb-2 flex items-center gap-2">
									<img src="https://images.emojiterra.com/microsoft/fluent-emoji/15.1/3d/1f3ad_3d.png" alt="Fake Word Icon" className="w-7 h-7" />
									Deception Deep Dive: Fake Word Mode
								</h3>
								<div className="relative">
									<div className="bg-white/5 p-4 rounded-xl border border-white/10" {...fakeWordSwipeHandlers}>
										<h4 className="font-bold text-base text-white/90 mb-2">{scenarios.fakeWord[currentFakeWordScenario].title}</h4>
										<div className="text-sm space-y-2 pl-2">
											<p>• <strong>Agents' Word:</strong> <span className="text-teal-300">{scenarios.fakeWord[currentFakeWordScenario].agentWord}</span> | <strong>{scenarios.fakeWord[currentFakeWordScenario].fakeWordPlayer}'s Word:</strong> <span className="text-yellow-300">{scenarios.fakeWord[currentFakeWordScenario].fakeWord}</span></p>
											<hr className="border-white/10 my-2" />
											{scenarios.fakeWord[currentFakeWordScenario].clues.map((clue, index) => (
												<p key={index}>• <strong>{clue.player}:</strong> "{clue.clue}"</p>
											))}
										</div>
										<p className="mt-3 text-xs text-white/60">
											{scenarios.fakeWord[currentFakeWordScenario].explanation}
										</p>
									</div>
									<button onClick={prevFakeWordScenario} className="hidden md:flex absolute top-1/2 -left-4 -translate-y-1/2 w-8 h-8 items-center justify-center bg-white/10 rounded-full text-white/50 hover:bg-white/20 active:scale-90 transition">
										<i className="fa-solid fa-chevron-left"></i>
									</button>
									<button onClick={nextFakeWordScenario} className="hidden md:flex absolute top-1/2 -right-4 -translate-y-1/2 w-8 h-8 items-center justify-center bg-white/10 rounded-full text-white/50 hover:bg-white/20 active:scale-90 transition">
										<i className="fa-solid fa-chevron-right"></i>
									</button>
								</div>
							</section>

							{/* Section: Word Confusion */}
							<section>
								<h3 className="font-bold text-lg text-yellow-400 mb-2 flex items-center gap-2">
									<img src="https://em-content.zobj.net/source/microsoft-teams/337/face-with-monocle_1f9d0.png" alt="Confusion Icon" className="w-7 h-7" />
									What if I Don't Know the Word?
								</h3>
								<p>It happens! If you're an Agent and receive a secret word you don't recognize, you'll see a special button during the card reveal (online mode only).</p>
								<div className="mt-3 bg-white/5 p-3 rounded-lg border border-white/10 text-sm space-y-2">
									<p><strong>1. Declare Confusion:</strong> Press the "I don't recognize this word" button.</p>
									<p><strong>2. Agents Vote:</strong> This triggers a secret poll for all other Agents, asking if they know the word.</p>
									<p><strong>3. The Outcome:</strong> If a <span className="font-semibold text-white/90">majority</span> of Agents also vote that they don't know the word, the round is immediately re-dealt with a new word and Imposter. If not, the mission continues as planned!</p>
								</div>
								<p className="mt-3 text-xs text-white/50"><i className="fa-solid fa-lightbulb mr-1"></i>This feature ensures the game is always fair, even with a massive word bank.</p>
							</section>
							
							{/* Section 5: Agent Strategy */}
							<section>
								<h3 className="font-bold text-lg text-teal-400 mb-2 flex items-center gap-2">
									 <img src="https://em-content.zobj.net/source/microsoft-teams/337/busts-in-silhouette_1f465.png" alt="Agent Strategy Icon" className="w-8 h-8" style={{ position: 'relative', top: '-2px' }} />
									Strategies for Agents
								</h3>
								<div className="space-y-3">
									<p>• <strong className="text-white/90">Be Specific, Not Obvious:</strong> A clue like "Jaws" for "Shark" might be too revealing. A better clue is "fin" or "predator".</p>
									<p>• <strong className="text-white/90">Watch for Hesitation (Classic Mode):</strong> The Imposter might need extra time to process clues and invent a plausible answer.</p>
									<p>• <strong className="text-white/90">Analyze Confidently Wrong Clues (Fake Word Mode):</strong> If a clue is very specific but doesn't match your word, you may have found your target.</p>
									<p>• <strong className="text-white/90">Cross-Reference:</strong> Do all the clues fit together? If one feels out of place, you might have found your spy.</p>
								</div>
							</section>

							{/* Section 6: Imposter Strategy */}
							 <section>
								<h3 className="font-bold text-lg text-red-400 mb-2 flex items-center gap-2">
									<img src="https://em-content.zobj.net/source/microsoft-teams/337/ninja_medium-light-skin-tone_1f977-1f3fc_1f3fc.png" alt="Imposter Strategy Icon" className="w-8 h-8" style={{ position: 'relative', top: '-2px' }} />
									Strategies for the Imposter / Fake Word Player
								</h3>
								<div className="space-y-3">
									<p>• <strong className="text-white/90">Listen and Adapt (Classic Imposter):</strong> Your greatest weapon is information. Use the first few clues to build a theory, then blend in.</p>
									<p>• <strong className="text-white/90">Stay Vague Early (Classic Imposter):</strong> Start with general clues. As you get more confident, you can become more specific to build trust.</p>
									<p>• <strong className="text-white/90">Detect the Dissonance (Fake Word Player):</strong> If everyone's clues seem to point to a different word, you might be the one with the fake word. If you suspect this, pivot to more general clues that could fit both your word and what you think the real word is.</p>
									<p>• <strong className="text-white/90">Confidence is Key:</strong> In either role, act like you belong. Avoid nervous tells. Project certainty.</p>
								</div>
							</section>

							{/* Section 7: Voting */}
							<section>
								<h3 className="font-bold text-lg text-brand-400 mb-2 flex items-center gap-2">
									<img src="https://em-content.zobj.net/source/microsoft-teams/337/hammer-and-pick_2692-fe0f.png" alt="Voting Icon" className="w-7 h-7" />
									The Final Showdown
								</h3>
								<p>After discussion, everyone votes.
								<br/> • If the Imposter or Fake Word player is correctly identified, the <span className="text-teal-400 font-semibold">Agents win</span>.
								<br/> • If an innocent Agent is voted out, or if there's a tie, the <span className="text-red-400 font-semibold">Imposter / Fake Word player wins!</span></p>
							</section>
						</div>
					</div>
				</div>
			);
		};

        // NEW: Game Mode Selection Screen (Restyled)
        const GameModeSelectionScreen = ({ onSelectMode, onShowHowToPlay, audioManager, onMuteToggle, isMuted }) => {
            return (
                <div className="h-[100dvh] flex flex-col items-center justify-center p-6 bg-slate-950 text-center relative overflow-hidden animate-fadeIn">
                    <div className="absolute inset-0 pointer-events-none">
                        <div className="blob bg-brand-600/30 top-[-20%] left-[-20%] w-[60%] h-[60%]"></div>
                        <div className="blob bg-cyan-600/30 bottom-[-20%] right-[-20%] w-[60%] h-[60%] animation-delay-2000"></div>
                    </div>

                    <div className="absolute top-6 right-6 z-20">
                         <button onClick={onMuteToggle} className="w-12 h-12 flex items-center justify-center bg-white/5 rounded-full text-white/50 hover:bg-white/10 active:scale-90 transition-transform">
                            <i className={`fa-solid ${isMuted ? 'fa-volume-xmark' : 'fa-volume-high'}`}></i>
                        </button>
                    </div>
                    
                    <div className="relative z-10 flex flex-col items-center w-full max-w-lg mx-auto">
                         <div class="mb-10 text-center">
                            <h1 class="text-6xl font-display font-black text-transparent bg-clip-text bg-gradient-to-br from-white via-white to-white/50 mb-2 drop-shadow-lg tracking-tight">IMPOSTER</h1>
                            <div class="subtle-shine-container inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/5 border border-white/10 backdrop-blur-md">
                                <span class="text-white/60 text-[10px] font-bold tracking-[0.3em] uppercase">Trust No One • {roundedWordCount.toLocaleString()}+ Words</span>
                            </div>
                        </div>

                        <div className="w-full flex flex-col gap-4 mt-8">
                            <button
                                onClick={() => { onSelectMode('online'); audioManager.playSound('uiClick'); }}
                                className="w-full bg-white text-slate-950 font-display font-bold text-lg py-5 rounded-[1.5rem] shadow-[0_0_30px_rgba(255,255,255,0.1)] hover:shadow-[0_0_50px_rgba(255,255,255,0.2)] active:scale-[0.98] transition-all flex items-center justify-center gap-3 relative overflow-hidden group"
                            >
                                <i className="fa-solid fa-globe text-brand-500"></i> PLAY ONLINE
                            </button>
                             <button
                                onClick={() => { onSelectMode('local'); audioManager.playSound('uiClick'); }}
                                className="w-full glass-panel-lighter border-white/10 text-white/70 font-display font-bold text-lg py-5 rounded-[1.5rem] transition-all active:scale-98 flex items-center justify-center gap-3 hover:bg-white/5 hover:text-white"
                            >
                                <i className="fa-solid fa-mobile-screen-button"></i> PLAY ON THIS DEVICE
                            </button>
                        </div>

                        <button
                            onClick={() => { onShowHowToPlay(); audioManager.playSound('uiClick'); }}
                            className="mt-8 text-white/40 font-bold hover:text-white transition-colors flex items-center gap-2"
                        >
                            <i className="fa-solid fa-question-circle"></i> How to Play
                        </button>
                    </div>
                    <div className="absolute bottom-6 left-0 right-0 text-center text-xs text-white/30 z-20">
                        Platform made by <a href="https://fillabrona.github.io" target="_blank" rel="noopener noreferrer" className="font-bold text-white/50 hover:text-white/80 transition">Jandré du Preez</a>
                    </div>
                </div>
            );
        };
        
        // NEW: Online Lobby Screen (Restyled)
        const OnlineLobbyScreen = ({ user, onJoin, onCreate, audioManager, onBack, initialParams }) => {
            const [isJoining, setIsJoining] = useState(true);
            const [lobbyId, setLobbyId] = useState('');
            const [password, setPassword] = useState('');
            
            // FIX: Load username immediately from storage so avatar is there instantly
            const [username, setUsername] = useState(() => {
                try {
                    const saved = localStorage.getItem('imposter_username');
                    return saved ? JSON.parse(saved) : '';
                } catch { return ''; }
            });
            
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            useEffect(() => {
                try {
                    // Prioritize initialParams from props (passed from App component)
                    if (initialParams && initialParams.lobbyId) {
                        setLobbyId(initialParams.lobbyId.toUpperCase());
                        if (initialParams.password) {
                            setPassword(initialParams.password.toUpperCase());
                        }
                        setIsJoining(true); // Force joining mode if params are passed
                    }
                } catch {}
            }, [initialParams]);

            useEffect(() => { localStorage.setItem('imposter_username', JSON.stringify(username)); }, [username]);

            const handleAction = async () => {
                if (!username.trim()) { setError('Please enter a username.'); return; }
                setIsLoading(true);
                setError('');
                audioManager.playSound('uiClick');
                try {
                    if (isJoining) {
                        if (!lobbyId.trim() || !password.trim()) {
                            setError('Lobby ID and Password are required.');
                            setIsLoading(false);
                            return;
                        }
                        await onJoin(lobbyId.toUpperCase(), password.toUpperCase(), username.trim());
                    } else {
                        await onCreate(username.trim());
                    }
                } catch (e) {
                    setError(e.message);
                    setIsLoading(false);
                }
            };
            
            return (
                 <div className="flex flex-col h-[100dvh] relative z-10">
                    <div className="absolute top-6 left-6 z-20">
                         <button onClick={onBack} className="w-12 h-12 flex items-center justify-center bg-white/5 rounded-full text-white/50 hover:bg-white/10 active:scale-90 transition-transform">
                            <i className="fa-solid fa-chevron-left"></i>
                        </button>
                    </div>
                    <div className="flex-1 overflow-y-auto no-scrollbar pb-32">
                        <div className="max-w-lg mx-auto p-6 pt-28">
                             <div class="mb-10 text-center">
								<h1 class="text-5xl font-display font-black text-white mb-2 drop-shadow-lg tracking-tight">
                                    {isJoining ? 'Join Mission' : 'Create Mission'}
                                </h1>
                                <p class="text-white/40 font-semibold tracking-wide">
                                    {isJoining ? "Enter an existing lobby's credentials." : "Set up a new private game for your friends."}
                                </p>
							</div>

                            <section className="glass-panel rounded-[2rem] p-6 flex flex-col gap-4">
                                <div className="flex items-center gap-3 bg-slate-950/50 rounded-xl border border-white/5 focus-within:border-brand-500/50 focus-within:bg-slate-950/80 transition-all pr-4">
                                    <input
                                        type="text"
                                        value={username}
                                        onChange={(e) => setUsername(e.target.value)}
                                        placeholder="Enter codename..."
                                        className="flex-1 bg-transparent px-5 py-4 outline-none placeholder:text-white/20 font-medium text-sm text-white min-w-0"
                                    />
                                    {username.trim() && <PlayerAvatar name={username} className="w-8 h-8 rounded-full" />}
                                </div>
                                {isJoining && (
                                    <>
                                        <input
                                            type="text"
                                            value={lobbyId}
                                            onChange={(e) => setLobbyId(e.target.value.toUpperCase())}
                                            placeholder="Lobby ID"
                                            maxLength="6"
                                            className="w-full bg-slate-950/50 rounded-xl px-5 py-4 outline-none border border-white/5 focus:border-brand-500/50 focus:bg-slate-950/80 transition-all placeholder:text-white/20 font-mono text-lg tracking-widest text-white"
                                        />
                                        <input
                                            type="text"
                                            value={password}
                                            onChange={(e) => setPassword(e.target.value.toUpperCase())}
                                            placeholder="Password"
                                            maxLength="4"
                                            className="w-full bg-slate-950/50 rounded-xl px-5 py-4 outline-none border border-white/5 focus:border-brand-500/50 focus:bg-slate-950/80 transition-all placeholder:text-white/20 font-mono text-lg tracking-widest text-white"
                                        />
                                    </>
                                )}
                                
                                {error && <p className="text-red-400 text-xs text-center -my-2">{error}</p>}
                                
                                <button onClick={() => { setIsJoining(!isJoining); setError(''); }} className="text-brand-400/70 hover:text-brand-400 text-xs font-bold transition text-center">
                                    {isJoining ? 'Or, create a new lobby' : 'Or, join an existing lobby'}
                                </button>
                            </section>
                        </div>
                    </div>
                     <div className="fixed bottom-0 left-0 w-full p-6 bg-gradient-to-t from-[#020617] via-[#020617] to-transparent z-50">
                        <div className="max-w-lg mx-auto pb-[env(safe-area-inset-bottom)]">
                             <button
                                onClick={handleAction}
                                disabled={isLoading}
                                className="w-full h-[68px] flex items-center justify-center bg-white text-slate-950 font-display font-bold text-lg py-5 rounded-[1.5rem] shadow-[0_0_30px_rgba(255,255,255,0.1)] hover:shadow-[0_0_50px_rgba(255,255,255,0.2)] disabled:opacity-50 disabled:shadow-none active:scale-[0.98] transition-all"
                            >
                               {isLoading ? <i className="fa-solid fa-spinner animate-spin"></i> : (isJoining ? 'JOIN LOBBY' : 'CREATE LOBBY')}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        
        // NEW: Modal for Confusion Poll
        const ConfusionPollModal = ({ onVote }) => {
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-6 animate-fadeIn">
                    <div className="absolute inset-0 bg-black/70 backdrop-blur-md"></div>
                    <div className="relative w-full max-w-sm glass-panel rounded-3xl p-8 border border-white/10 shadow-2xl animate-slide-up text-center">
                        <div className="w-20 h-20 rounded-full flex items-center justify-center mb-6 bg-yellow-500/20 ring-1 ring-white/10 mx-auto">
                            <i className="fa-solid fa-circle-question text-4xl text-yellow-400"></i>
                        </div>
                        <h2 className="text-2xl font-display font-bold text-white mb-2">Word Check</h2>
                        <p className="text-white/60 mb-8">An agent doesn't recognize the secret word. Do you know what it is?</p>
                        <div className="flex flex-col gap-3">
                            <button
                                onClick={() => onVote('knows')}
                                className="w-full bg-green-500/80 hover:bg-green-500 text-white font-display font-bold py-4 rounded-xl active:scale-95 transition-all"
                            >
                                Yes, I know the word
                            </button>
                            <button
                                onClick={() => onVote('confused')}
                                className="w-full bg-red-500/80 hover:bg-red-500 text-white font-display font-bold py-4 rounded-xl active:scale-95 transition-all"
                            >
                                No, me neither
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        
        // NEW: Imposter Notification Modal
        const ImposterVoteNotificationModal = ({ onClose }) => {
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-6 animate-fadeIn">
                    <div className="absolute inset-0 bg-black/70 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative w-full max-w-sm glass-panel rounded-3xl p-8 border border-white/10 shadow-2xl animate-slide-up text-center">
                        <div className="w-20 h-20 rounded-full flex items-center justify-center mb-6 bg-red-500/20 ring-1 ring-white/10 mx-auto">
                            <i className="fa-solid fa-triangle-exclamation text-4xl text-red-400 animate-pulse"></i>
                        </div>
                        <h2 className="text-2xl font-display font-bold text-white mb-2">Agent Confusion Detected</h2>
                        <p className="text-white/60 mb-8">An agent has reported they do not recognize the secret word. A secret poll is now active. Maintain your cover.</p>
                        <button
                            onClick={onClose}
                            className="w-full bg-white/10 hover:bg-white/20 text-white font-display font-bold py-4 rounded-xl active:scale-95 transition-all"
                        >
                            DISMISS
                        </button>
                    </div>
                </div>
            );
        };
        
        // NEW: Restart Notification Modal
        const RestartNotificationModal = ({ word, onClose }) => {
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-6 animate-fadeIn">
                    <div className="absolute inset-0 bg-black/70 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative w-full max-w-sm glass-panel rounded-3xl p-8 border border-white/10 shadow-2xl animate-slide-up text-center">
                        <div className="w-20 h-20 rounded-full flex items-center justify-center mb-6 bg-sky-500/20 ring-1 ring-white/10 mx-auto">
                            <i className="fa-solid fa-arrows-rotate text-4xl text-sky-400"></i>
                        </div>
                        <h2 className="text-2xl font-display font-bold text-white mb-2">Mission Re-rolled</h2>
                        <p className="text-white/60 mb-6">
                            The round was restarted because a majority of agents did not recognize the secret word: <strong className="text-white/90 font-bold">{word}</strong>.
                        </p>
                        <p className="text-white/60 mb-8">A new word and imposter have been selected.</p>
                        <button
                            onClick={onClose}
                            className="w-full bg-white/10 hover:bg-white/20 text-white font-display font-bold py-4 rounded-xl active:scale-95 transition-all"
                        >
                            GOT IT
                        </button>
                    </div>
                </div>
            );
        };

        // NEW: Waiting Room Screen (Restyled & Feature-Rich)
        const WaitingRoom = ({ lobbyData, lobbyPlayers, user, lobbyId, onStartGame, onStartMission, onLeaveLobby, audioManager, onConfusionVote }) => {
            const isHost = user.uid === lobbyData.hostId;
            const MIN_PLAYERS = 3;
            const [showCopied, setShowCopied] = useState(false);
            const [inspectedCategory, setInspectedCategory] = useState(null);
            const categoryLongPressTimerRef = useRef(null);

            // Poll logic
            const pollIsActive = lobbyData.gameState === 'reveal' && lobbyPlayers.some(p => p.status === 'confused');
            
            // Logic for enabling the host's start button
            const allPlayersReady = lobbyData.gameState === 'reveal' && lobbyPlayers.length > 0 && lobbyPlayers.every(p => {
                const isImposter = lobbyData.imposterIds?.includes(p.id);
                // A player is ready if they have seen their card AND (the poll is not active OR (they are the imposter in classic mode) OR they have voted in the poll)
                // In fake word mode, the imposter doesn't exist, so everyone needs to vote.
                const needsToVote = lobbyData.isFakeWordMode ? true : !isImposter;
                return p.hasSeenCard && (!pollIsActive || !needsToVote || p.status);
            });

            // Confusion Poll Logic for the current user
            const me = lobbyPlayers.find(p => p.id === user.uid);
            const isMyRoleImposter = !lobbyData.isFakeWordMode && lobbyData.imposterIds?.includes(user.uid);
            
            // Show poll IF: poll is active, I am not the imposter in classic mode, and I have not voted yet.
            const showConfusionPoll = lobbyData.gameState === 'reveal' && pollIsActive && !isMyRoleImposter && !me?.status;

            const handleCategorySelect = (cat) => {
                if (isHost && lobbyData.category !== cat) {
                    db.collection('lobbies').doc(lobbyId).update({ 
                        category: cat,
                        lastSoundEvent: { name: 'selectCategory', timestamp: Date.now() }
                    });
                }
            };

            const handleModeChange = (newModeIsRandom) => {
                if (isHost && lobbyData.isRandomMode !== newModeIsRandom) {
                    db.collection('lobbies').doc(lobbyId).update({ 
                        isRandomMode: newModeIsRandom,
                        lastSoundEvent: { name: 'toggleMode', timestamp: Date.now() }
                    });
                }
            };
            
            const handleSettingChange = (settingName, currentValue) => {
                if (isHost) {
                    const newValue = !currentValue;
                    
                    // If turning on Fake Word Mode, turn off incompatible settings
                    if(settingName === 'isFakeWordMode' && newValue) {
                        db.collection('lobbies').doc(lobbyId).update({
                            isFakeWordMode: true,
                            notifyImposterOnVote: false, // Turn off notification
                            lastSoundEvent: { name: 'switchOn', timestamp: Date.now() }
                        });
                    } else {
                        db.collection('lobbies').doc(lobbyId).update({ 
                            [settingName]: newValue,
                            lastSoundEvent: { name: newValue ? 'switchOn' : 'switchOff', timestamp: Date.now() }
                        });
                    }
                }
            };


            const handleTwoImposterToggle = () => {
                if (isHost && lobbyPlayers.length >= 10) {
                    const newValue = !lobbyData.enableTwoImposters;
                    db.collection('lobbies').doc(lobbyId).update({ 
                        enableTwoImposters: newValue,
                        lastSoundEvent: { name: newValue ? 'switchOn' : 'switchOff', timestamp: Date.now() }
                    });
                }
            };

            useEffect(() => {
                if (isHost && lobbyPlayers.length < 10 && lobbyData.enableTwoImposters) {
                    db.collection('lobbies').doc(lobbyId).update({ enableTwoImposters: false });
                }
            }, [isHost, lobbyPlayers.length, lobbyData?.enableTwoImposters]);

            const handleCategoryTouchStart = (cat) => {
                categoryLongPressTimerRef.current = setTimeout(() => {
                    setInspectedCategory(cat);
                    audioManager.playSound('openInfo');
                    if (navigator.vibrate) navigator.vibrate(30);
                }, 600);
            };

            const handleCategoryTouchEnd = () => {
                if (categoryLongPressTimerRef.current) {
                    clearTimeout(categoryLongPressTimerRef.current);
                    categoryLongPressTimerRef.current = null;
                }
            };

            const handleCopyInvite = () => {
                const inviteLink = `${window.location.origin}${window.location.pathname}?lobbyId=${lobbyId}&password=${lobbyData.password}`;
                audioManager.playSound('uiClick');

                if (navigator.share) {
                    navigator.share({
                        title: 'Imposter Game Invite',
                        text: `Join my Imposter game! Lobby ID: ${lobbyId}`,
                        url: inviteLink,
                    })
                    .catch((error) => console.log('Error sharing:', error));
                } else {
                    navigator.clipboard.writeText(inviteLink).then(() => {
                        setShowCopied(true);
                        setTimeout(() => setShowCopied(false), 2000);
                    });
                }
            };

            const handleRemovePlayer = (playerId) => {
                if (isHost && user.uid !== playerId) {
                    db.collection('lobbies').doc(lobbyId).collection('players').doc(playerId).delete()
                        .catch(err => console.error("Failed to remove player:", err));
                }
            };

            return (
                 <div className="flex flex-col h-[100dvh] relative z-10">
                    <CategoryInfoModal category={inspectedCategory} onClose={() => setInspectedCategory(null)} />
                    {showConfusionPoll && <ConfusionPollModal onVote={onConfusionVote} />}
                    
                    <div className="absolute top-6 left-6 z-20">
                        {lobbyData.gameState === 'waiting' && (
                            <button 
                                onClick={onLeaveLobby} 
                                className={`h-12 flex items-center justify-center rounded-full px-4 active:scale-90 transition-all text-sm font-bold ${
                                    isHost 
                                    ? 'bg-red-500/10 text-red-400/80 hover:bg-red-500/20 hover:text-red-400' 
                                    : 'bg-white/5 text-white/50 hover:bg-white/10 hover:text-white/80'
                                }`}
                            >
                                <i className="fa-solid fa-door-open mr-2"></i>
                                <span>{isHost ? 'Close Lobby' : 'Exit Lobby'}</span>
                            </button>
                        )}
                    </div>
                     
                    <div className="flex-1 overflow-y-auto no-scrollbar pb-32">
                        <div className="max-w-lg mx-auto p-6 pt-28">
                            <div class="mb-10 text-center">
								<h1 class="text-5xl font-display font-black text-white mb-2 drop-shadow-lg tracking-tight">Mission Lobby</h1>
                                <p class="text-white/40 font-semibold tracking-wide">Waiting for agents to assemble.</p>
							</div>
                            
                            <section className="mb-6 glass-panel rounded-[2rem] p-6">
                               <div className="flex items-center gap-4">
                                    <div className="flex-1">
                                        <div className="text-white/40 text-[10px] uppercase font-bold tracking-widest mb-1">Lobby ID</div>
                                        <div className="font-mono text-2xl font-bold tracking-widest">{lobbyId}</div>
                                    </div>
                                    <div className="w-px h-10 bg-white/10"></div>
                                    <div className="flex-1">
                                        <div className="text-white/40 text-[10px] uppercase font-bold tracking-widest mb-1">Password</div>
                                        <div className="font-mono text-2xl font-bold tracking-widest">{lobbyData.password}</div>
                                    </div>
                                    <button onClick={handleCopyInvite} className="relative w-14 h-14 bg-white/10 rounded-xl flex items-center justify-center text-brand-400 hover:bg-brand-500/20 active:scale-90 transition">
                                        <i className={`fa-solid ${showCopied ? 'fa-check' : 'fa-share-nodes'} transition-all`}></i>
                                        {showCopied && <div className="absolute -top-8 text-xs bg-slate-800 px-2 py-1 rounded-md">Copied!</div>}
                                    </button>
                                </div>
                            </section>

                            <section className="mb-6 glass-panel rounded-[2rem] p-6">
                                <h2 className="text-sm font-bold tracking-widest text-brand-400 mb-4 flex items-center gap-2 uppercase">
                                    <i className="fa-solid fa-users"></i> Agents
                                    <span className="ml-auto text-[10px] bg-white/5 px-2 py-1 rounded-md text-white/50">{lobbyPlayers.length}</span>
                                </h2>
                                <div className="flex flex-col gap-3">
                                    {lobbyPlayers.map(p => {
                                        const hasAcknowledgedCard = !!p.hasSeenCard;

                                        return (
                                            <div key={p.id} className={`flex items-center gap-3 px-4 py-3 rounded-xl transition-colors ${p.id === user.uid ? 'bg-white/10' : 'bg-white/5'}`}>
                                                <i className={`fa-solid ${p.id === lobbyData.hostId ? 'fa-crown text-yellow-400' : 'fa-user-secret text-white/40'}`}></i>
                                                <PlayerAvatar name={p.name} className="w-6 h-6 rounded-full"/>
                                                <span className="font-bold text-white/90 truncate">{p.name}</span>
                                                {(lobbyData.gameState === 'reveal' || lobbyData.gameState === 'turnOrder') && (
                                                    <span className="ml-auto text-xs font-bold flex items-center gap-2">
                                                        {hasAcknowledgedCard ? 
                                                            <i className="fa-solid fa-check-circle text-green-400 animate-fadeIn"></i> :
                                                            <i className="fa-solid fa-ellipsis text-white/30"></i>
                                                        }
                                                    </span>
                                                )}
                                                {isHost && p.id !== user.uid && lobbyData.gameState === 'waiting' && (
                                                    <button onClick={() => handleRemovePlayer(p.id)} className="ml-auto w-8 h-8 flex items-center justify-center rounded-full text-white/40 hover:bg-red-500/20 hover:text-red-400 transition-colors">
                                                        <i className="fa-solid fa-trash-can text-xs"></i>
                                                    </button>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </section>
                            
                            {lobbyData.gameState === 'waiting' && (
                                <>
                                 <section className="mb-6 glass-panel rounded-[2rem] p-6 space-y-4">
                                    <div className="flex items-center justify-between">
                                        <div className="pr-4">
                                            <h3 className="font-bold text-white/90 text-base flex items-center gap-3">
                                                <i className="fa-solid fa-masks-theater text-yellow-400/80 w-5 text-center"></i>
                                                <span>Fake Word Mode</span>
                                            </h3>
                                            <p className="text-white/40 text-xs mt-1 pl-8">One agent gets a different word. They don't know it's fake.</p>
                                        </div>
                                        <button 
                                            onClick={() => handleSettingChange('isFakeWordMode', lobbyData.isFakeWordMode)}
                                            disabled={!isHost}
                                            className={`flex-shrink-0 w-12 h-7 rounded-full p-1 transition-all duration-300 ${lobbyData.isFakeWordMode ? 'bg-yellow-500/80' : 'bg-white/10'} ${!isHost && 'opacity-50 cursor-not-allowed'}`}
                                        >
                                            <div className={`w-5 h-5 bg-white rounded-full shadow-md transform transition-transform duration-300 ${lobbyData.isFakeWordMode ? 'translate-x-5' : 'translate-x-0'}`} />
                                        </button>
                                    </div>
                                    <div className="h-px bg-white/10"></div>
                                    <div 
                                        className={`flex items-center justify-between transition-opacity duration-300 ${(lobbyPlayers.length < 10 || lobbyData.isFakeWordMode) ? 'opacity-50' : ''}`}
                                        title={lobbyData.isFakeWordMode ? "Disabled in Fake Word Mode" : (lobbyPlayers.length < 10 ? "Requires 10 or more players" : "Add a second spy to the mission")}
                                    >
                                        <div className="pr-4">
                                            <h3 className="font-bold text-white/90 text-base flex items-center gap-3">
                                                <i className="fa-solid fa-user-secret text-orange-400/80 w-5 text-center"></i>
                                                <span>{lobbyData.isFakeWordMode ? 'Second Fake Card' : 'Second Imposter'}</span>
                                            </h3>
                                            <p className="text-white/40 text-xs mt-1 pl-8">Adds a second rogue agent when 10 or more agents are in the lobby.</p>
                                        </div>
                                        <button 
                                            onClick={() => handleSettingChange('enableTwoImposters', lobbyData.enableTwoImposters)}
                                            disabled={!isHost || lobbyPlayers.length < 10 || lobbyData.isFakeWordMode}
                                            className={`flex-shrink-0 w-12 h-7 rounded-full p-1 transition-all duration-300 ${lobbyData.enableTwoImposters ? 'bg-orange-500/80' : 'bg-white/10'} ${(!isHost || lobbyPlayers.length < 10 || lobbyData.isFakeWordMode) && 'cursor-not-allowed'}`}
                                        >
                                            <div className={`w-5 h-5 bg-white rounded-full shadow-md transform transition-transform duration-300 ${lobbyData.enableTwoImposters ? 'translate-x-5' : 'translate-x-0'}`} />
                                        </button>
                                    </div>
                                    <div className="h-px bg-white/10"></div>
                                     <div className={`flex items-center justify-between transition-opacity duration-300 ${lobbyData.isFakeWordMode ? 'opacity-50' : ''}`} title={lobbyData.isFakeWordMode ? "Disabled in Fake Word Mode" : ""}>
                                        <div className="pr-4">
                                            <h3 className="font-bold text-red-400/90 text-base flex items-center gap-3">
                                                <i className="fa-solid fa-bell text-red-400/80 w-5 text-center"></i>
                                                <span>Notify Imposter on Vote</span>
                                            </h3>
                                            <p className="text-white/40 text-xs mt-1 pl-8">Shows a pop-up to the Imposter if an agent initiates a word-check.</p>
                                        </div>
                                        <button 
                                            onClick={() => handleSettingChange('notifyImposterOnVote', lobbyData.notifyImposterOnVote)}
                                            disabled={!isHost || lobbyData.isFakeWordMode}
                                            className={`flex-shrink-0 w-12 h-7 rounded-full p-1 transition-all duration-300 ${lobbyData.notifyImposterOnVote ? 'bg-red-500/80' : 'bg-white/10'} ${(!isHost || lobbyData.isFakeWordMode) && 'opacity-50 cursor-not-allowed'}`}
                                        >
                                            <div className={`w-5 h-5 bg-white rounded-full shadow-md transform transition-transform duration-300 ${lobbyData.notifyImposterOnVote ? 'translate-x-5' : 'translate-x-0'}`} />
                                        </button>
                                    </div>
                                    <div className="h-px bg-white/10"></div>
                                    <div className="flex items-center justify-between">
                                        <div className="pr-4">
                                            <h3 className="font-bold text-white/90 text-base flex items-center gap-3">
                                                <i className="fa-solid fa-volume-high text-purple-400/80 w-5 text-center"></i>
                                                <span>Speak Category</span>
                                            </h3>
                                            <p className="text-white/40 text-xs mt-1 pl-8">Announces the chosen category name when the mission begins.</p>
                                        </div>
                                        <button 
                                            onClick={() => handleSettingChange('speakCategory', lobbyData.speakCategory)}
                                            disabled={!isHost}
                                            className={`flex-shrink-0 w-12 h-7 rounded-full p-1 transition-all duration-300 ${lobbyData.speakCategory ? 'bg-purple-500/80' : 'bg-white/10'} ${!isHost && 'opacity-50 cursor-not-allowed'}`}
                                        >
                                            <div className={`w-5 h-5 bg-white rounded-full shadow-md transform transition-transform duration-300 ${lobbyData.speakCategory ? 'translate-x-5' : 'translate-x-0'}`} />
                                        </button>
                                    </div>
                                 </section>
                                <section>
                                    <div className="flex items-center justify-between mb-4 px-2">
                                        <h2 className="text-sm font-bold tracking-widest text-teal-400 flex items-center gap-2 uppercase">
                                            <i className="fa-solid fa-layer-group"></i> Mission
                                        </h2>
                                        <div className={`flex bg-slate-950/50 p-1 rounded-lg border border-white/5 ${!isHost && 'opacity-50 pointer-events-none'}`}>
                                            <button 
                                                onClick={() => handleModeChange(false)}
                                                className={`px-3 py-1.5 rounded-md text-[10px] font-bold uppercase tracking-wide transition-all ${!lobbyData.isRandomMode ? 'bg-white/10 text-white shadow-sm' : 'text-white/30 hover:text-white/60'}`}
                                            >
                                                Select
                                            </button>
                                            <button 
                                                onClick={() => handleModeChange(true)}
                                                className={`px-3 py-1.5 rounded-md text-[10px] font-bold uppercase tracking-wide transition-all ${lobbyData.isRandomMode ? 'bg-gradient-to-r from-brand-600 to-fuchsia-600 text-white shadow-sm' : 'text-white/30 hover:text-white/60'}`}
                                            >
                                                Random
                                            </button>
                                        </div>
                                    </div>
                                    {lobbyData.isRandomMode ? (
                                        <div className="glass-panel rounded-[2rem] p-8 text-center animate-fadeIn border border-brand-500/20 relative overflow-hidden group">
                                            <div className="absolute inset-0 bg-gradient-to-br from-brand-500/10 via-transparent to-fuchsia-500/10 opacity-50 group-hover:opacity-100 transition-opacity duration-700"></div>
                                            <div className="relative z-10 py-8">
                                                <div className="w-24 h-24 mx-auto bg-gradient-to-br from-brand-500 to-fuchsia-600 rounded-3xl rotate-12 flex items-center justify-center shadow-lg shadow-brand-900/40 mb-6 group-hover:rotate-[20deg] group-hover:scale-110 transition-transform duration-500">
                                                    <i className="fa-solid fa-dice text-4xl text-white drop-shadow-md"></i>
                                                </div>
                                                <h3 className="text-2xl font-display font-bold text-white mb-2">Mystery Mode</h3>
                                                <p className="text-white/50 text-sm max-w-[200px] mx-auto leading-relaxed">
                                                    The system will automatically select a random category for your mission.
                                                </p>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className={`grid grid-cols-2 sm:grid-cols-3 gap-3 ${!isHost && 'opacity-60'}`}>
                                        {DISPLAY_CATEGORIES.map(cat => {
                                            const iconSource = CATEGORY_ICONS[cat];
                                            const isSelected = lobbyData.category === cat;
                                            const isSupercell = cat === 'Supercell';
                                            
                                            let cardClasses = `relative overflow-hidden flex flex-col items-center justify-center gap-3 p-4 rounded-[1.5rem] border transition-all duration-300 active:scale-95 group min-h-[110px] `;
                                            
                                            if (isSupercell) {
                                                if (isSelected) {
                                                    cardClasses += 'border-blue-400 bg-blue-900/20 ring-2 ring-blue-500 shadow-lg shadow-blue-900/40 text-white';
                                                } else {
                                                    cardClasses += 'border-white/10 bg-slate-900/40 opacity-60 grayscale-[0.5] hover:opacity-100 hover:grayscale-0 text-slate-300';
                                                }
                                            } else {
                                                if (isSelected) {
                                                    cardClasses += 'glass-panel bg-teal-500/10 border-teal-500/40 text-teal-100 shadow-[0_0_20px_rgba(20,184,166,0.1)]';
                                                } else {
                                                    cardClasses += 'glass-panel-lighter border-white/5 text-slate-400 hover:bg-white/5 hover:border-white/10';
                                                }
                                            }

                                            return (
                                                <button
                                                    key={cat}
                                                    onClick={() => handleCategorySelect(cat)}
                                                    onMouseDown={() => handleCategoryTouchStart(cat)}
                                                    onMouseUp={handleCategoryTouchEnd}
                                                    onMouseLeave={handleCategoryTouchEnd}
                                                    onTouchStart={() => handleCategoryTouchStart(cat)}
                                                    onTouchEnd={handleCategoryTouchEnd}
                                                    onTouchMove={handleCategoryTouchEnd}
                                                    className={cardClasses}
                                                >
                                                    {isSupercell && (
                                                        <div className="supercell-container pointer-events-none">
                                                            <div className="supercell-bg-1"></div>
                                                            <div className="supercell-bg-2"></div>
                                                        </div>
                                                    )}
                                                    <div className="relative z-10 flex flex-col items-center gap-2">
                                                        <FaIcon 
                                                            name={iconSource} 
                                                            sizeClass="text-2xl" 
                                                            className={`transition-all duration-300 ${isSupercell ? "drop-shadow-md brightness-125" : (isSelected ? "text-teal-400 scale-110" : "text-white/40 group-hover:text-white/70")}`} 
                                                        />
                                                        <span className={`text-xs font-bold tracking-wide transition-colors ${isSupercell ? 'text-white drop-shadow-md' : ''}`}>{cat}</span>
                                                    </div>
                                                    {isSelected && (
                                                        <div className={`absolute top-3 right-3 w-5 h-5 rounded-full flex items-center justify-center text-[10px] shadow-sm ${isSupercell ? 'bg-blue-500 text-white' : 'bg-teal-500 text-slate-900'}`}>
                                                            <i className="fa-solid fa-check"></i>
                                                        </div>
                                                    )}
                                                </button>
                                            )
                                        })}
                                        </div>
                                    )}
                                </section>
                                </>
                            )}
                        </div>
                    </div>
                    
                    <div className="fixed bottom-0 left-0 w-full p-6 bg-gradient-to-t from-[#020617] via-[#020617] to-transparent z-50">
                        <div className="max-w-lg mx-auto pb-[env(safe-area-inset-bottom)]">
                        {isHost ? (
                            allPlayersReady && !pollIsActive ? (
                                <button
                                    onClick={onStartMission}
                                    className="w-full bg-green-500 text-white font-display font-bold text-lg py-5 rounded-[1.5rem] shadow-[0_0_30px_rgba(34,197,94,0.2)] active:scale-95 transition-all flex items-center justify-center gap-3 animate-pulse"
                                >
                                    <i className="fa-solid fa-rocket text-lg"></i>
                                    ALL AGENTS READY - BEGIN!
                                </button>
                            ) : (
                                <button
                                    onClick={onStartGame}
                                    disabled={lobbyPlayers.length < MIN_PLAYERS || lobbyData.gameState !== 'waiting'}
                                    className="w-full bg-white text-slate-950 font-display font-bold text-lg py-5 rounded-[1.5rem] shadow-[0_0_30px_rgba(255,255,255,0.1)] hover:shadow-[0_0_50px_rgba(255,255,255,0.2)] disabled:opacity-50 disabled:shadow-none active:scale-[0.98] transition-all flex items-center justify-center gap-3"
                                >
                                    <i className="fa-solid fa-play text-sm"></i> START MISSION ({lobbyPlayers.length}/{MIN_PLAYERS}+)
                                </button>
                            )
                        ) : (
                             <div className="text-center p-4 glass-panel rounded-xl">
                               <p className="text-white/60 font-medium">
                                 {allPlayersReady && !pollIsActive ? "All agents are ready! Waiting for host..." : "Waiting for host to start the mission..."}
                               </p>
                           </div>
                        )}
                        </div>
                    </div>
                </div>
            );
        };


		const TIPS = [
            "The Imposter doesn't know the secret word. Ask questions that might expose them!",
            "Pay attention to hesitation. The Imposter might need extra time to think of a lie.",
            "Try to ask a question only a true agent would know the answer to.",
            "Long-press on a category card during setup to see example words.",
            "The first player on the turn order list asks the first question.",
            "Innocent agents should try to prove they know the word without giving it away.",
            "Random Mode chooses a category from the entire word bank for an extra challenge.",
            "You can record your own 'It's your turn!' voice note by tapping the microphone icon when adding a player.",
            "Use the untimed mode for a more relaxed, deduction-focused game.",
            "The Imposter's goal is to survive the round without being identified.",
            "As an agent, be specific enough to prove you're innocent but vague enough not to reveal the word to the Imposter.",
            "Listen to how others answer. Is someone being overly generic or changing their story?",
            "If you are the Imposter, try to get others to talk first so you can copy their vibe.",
            "Don't be too obvious! If the word is 'Pizza', don't ask 'Do you like pepperoni?'",
            "In Online Mode, check the 'Voting Record' at the end to see who betrayed whom.",
            "The 'Speak Category' toggle allows the game to announce the category name aloud.",
            "Watch out for players who simply repeat the previous answer in different words.",
            "Silence is suspicious! Make sure you have an answer ready before it's your turn.",
            "If the group is confused, the Imposter often wins. Keep your questions clear.",
            "Eye contact can be deceiving. Some Imposters are great at looking you in the eye.",
            "Use the 'Verify Identity' button in local mode to ensure you are handing the phone to the right person.",
			"Did someone smile when they saw their card? That might be a clue.",
            "If you are the Imposter and figure out the word, try to blend in by adding a unique detail.",
			"Keep your card hidden! Reflections in glasses or windows can give you away.",
            "Got a word you don't recognize? As an Agent, you can press a button on the reveal screen to start a 'Word Check' poll.",
            "If a 'Word Check' poll appears, vote honestly. Rerolling a confusing word gives the Agents a better chance to win.",
            "If a round suddenly restarts before it begins, it means a majority of Agents were confused by the secret word and voted to re-deal.",
            "Imposter Tip: A long pause before the round starts? That's a secret 'Word Check' for Agents. Stay cool, they don't know you're excluded.",
			"Agent Tip: Don't recognize the word? Use the 'Word Check' button! It's better to admit confusion and help the team than to look like the Imposter.",
            "With 10 or more players, the host can enable a second Imposter, raising the stakes and the suspicion!",
            "When two Imposters are in play, they don't know each other's identity. Be careful not to accidentally vote for your fellow spy!",
            "If the 'Notify Imposter' setting is on, the spy gets a heads-up when an Agent starts a 'Word Check' poll. Use this intel to stay one step ahead!",
            "If the game seems to pause after cards are dealt in online mode, a secret 'Word Check' poll is likely in progress. Imposters, use this time to prepare your cover story!",
            "Pay attention to the voting record at the end of an online match. It can reveal alliances and voting patterns you missed during the discussion.",
            "In 'Fake Word' mode, one player has a different word from the same category. They think their word is the real one!",
            "Tip for Fake Word mode: If someone gives a clue that is confidently wrong, they might have the fake word. Don't dismiss them as just a bad player!",
            "The player with the Fake Word is included in 'Word Check' polls online. This makes it much harder to identify them by process of elimination.",
        ];

        // --- MODIFIED: LoadingScreen with real progress and stuttering effect ---
        const LoadingScreen = ({ onStart, onFinishedLoading }) => {
            const [currentTipIndex, setCurrentTipIndex] = useState(() => Math.floor(Math.random() * TIPS.length));
            const [isReady, setIsReady] = useState(false);

            // State for actual loading progress
            const [targetProgress, setTargetProgress] = useState(0);
            // State for what the user sees on the progress bar
            const [visualProgress, setVisualProgress] = useState(0);
            
            const stutterTimeoutRef = useRef(null);

            // Tip rotation effect
            useEffect(() => {
                const tipInterval = setInterval(() => {
                    setCurrentTipIndex(prev => {
                        let newIndex;
                        do { newIndex = Math.floor(Math.random() * TIPS.length); } while (newIndex === prev && TIPS.length > 1);
                        return newIndex;
                    });
                }, 5000);
                return () => clearInterval(tipInterval);
            }, []);

            // Effect to handle the asset loading and progress tracking
            useEffect(() => {
                let loadedCount = 0;
                let totalAssets = 0;

                const handleProgress = () => {
                    loadedCount++;
                    const newProgress = Math.round((loadedCount / totalAssets) * 100);
                    setTargetProgress(newProgress);
                };

                // This function now returns the total count and the promise
                const { assetPromise, count } = preloadAssets(handleProgress);
                totalAssets = count;

                assetPromise.then(() => {
                    setTargetProgress(100); // Ensure it hits 100%
                    // Wait a moment after loading is complete before showing the button
                    setTimeout(() => {
                        onFinishedLoading();
                        setIsReady(true);
                    }, 500);
                });
            }, [onFinishedLoading]);

            // Effect to create the "stuttering" progress bar animation
            useEffect(() => {
                if (visualProgress < targetProgress) {
                    if (stutterTimeoutRef.current) {
                        clearTimeout(stutterTimeoutRef.current);
                    }
                    // Set a new timeout with a random delay to update the visual progress
                    stutterTimeoutRef.current = setTimeout(() => {
                        setVisualProgress(targetProgress);
                    }, Math.random() * 250 + 50); // Random delay between 50ms and 300ms
                }
                 // Clean up the timeout if the component unmounts
                return () => clearTimeout(stutterTimeoutRef.current);
            }, [targetProgress]);


            return (
                <div className="h-[100dvh] flex flex-col items-center justify-center p-8 bg-slate-950 text-center relative overflow-hidden animate-fadeIn">
                    <div className="absolute inset-0 pointer-events-none">
                        <div className="blob bg-brand-600/50 top-[-20%] left-[-20%] w-[60%] h-[60%]"></div>
                        <div className="blob bg-cyan-600/50 bottom-[-20%] right-[-20%] w-[60%] h-[60%] animation-delay-2000"></div>
                    </div>
                    
                    <div className="relative z-10 flex flex-col items-center w-full max-w-sm">
                        <div className="w-28 h-28 mb-8 relative flex items-center justify-center">
                            <div className="absolute inset-0 bg-brand-500/20 rounded-full animate-pulse-slow blur-xl"></div>
                            <img src="https://em-content.zobj.net/source/microsoft-teams/400/disguised-face_1f978.png" alt="Loading Icon" draggable="false" className="w-24 h-24 animate-float" />
                        </div>
                        
                        <h1 className="text-6xl font-display font-black text-transparent bg-clip-text bg-gradient-to-br from-white via-white to-white/50 mb-4 drop-shadow-lg tracking-tight">IMPOSTER</h1>
                        <p className="text-white/50 font-semibold text-lg mb-12">Find the spy before time runs out.</p>

                        <div className="w-full h-24 flex flex-col items-center justify-center">
                            {isReady ? (
                                <button
                                    onClick={onStart}
                                    className="w-full max-w-xs bg-white text-slate-950 font-display font-bold text-lg py-5 rounded-[1.5rem] shadow-[0_0_30px_rgba(255,255,255,0.1)] hover:shadow-[0_0_50px_rgba(255,255,255,0.2)] active:scale-[0.98] transition-all flex items-center justify-center gap-3 animate-slide-up"
                                >
                                    <i className="fa-solid fa-play text-sm"></i> START GAME
                                </button>
                            ) : (
                                <div className="w-full max-w-xs animate-fadeIn">
                                    <div className="w-full bg-slate-800/50 rounded-full h-2.5 mb-4 border border-white/5 overflow-hidden">
                                        <div className="bg-brand-500 h-full rounded-full transition-all duration-300 ease-out" style={{ width: `${visualProgress}%` }}></div>
                                    </div>
                                    <p key={currentTipIndex} className="text-white/60 font-medium text-sm animate-fadeIn h-10">
                                        <i className="fa-solid fa-lightbulb text-brand-400 mr-2"></i>
                                        {TIPS[currentTipIndex]}
                                    </p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const FaIcon = ({ name, sizeClass = "text-xl", className = "" }) => {
            const [currentImageIndex, setCurrentImageIndex] = useState(0);

            useEffect(() => {
                if (Array.isArray(name) && name.length > 1) {
                    const interval = setInterval(() => {
                        setCurrentImageIndex(prev => (prev + 1) % name.length);
                    }, 5000);
                    return () => clearInterval(interval);
                }
            }, [name]);

            if (Array.isArray(name)) {
                return (
                    <div className={`relative w-8 h-8 inline-block ${className}`}>
                        {name.map((url, index) => (
                             <img 
                                key={url} 
                                src={url} 
                                alt="icon" 
                                draggable="false"
                                className={`absolute inset-0 w-full h-full object-contain transition-opacity duration-1000 ${index === currentImageIndex ? 'opacity-100' : 'opacity-0'}`} 
                             />
                        ))}
                    </div>
                );
            }

            if (name.startsWith('http')) {
                return <img src={name} alt="icon" draggable="false" className={`w-8 h-8 object-contain ${className}`} />;
            }
            return <i className={`fa-solid ${name} ${sizeClass} ${className}`}></i>;
        };

        // Modal for Long Press Category Info
        const CategoryInfoModal = ({ category, onClose }) => {
            if (!category) return null;
            
            const categoryWords = WORD_BANK[category];
            const examples = categoryWords.slice(0, 8).join(", ");
            const remainingCount = categoryWords.length - 8;
            const icon = CATEGORY_ICONS[category];

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-6 animate-fadeIn">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-md" onClick={onClose}></div>
                    <div className="relative w-full max-w-sm glass-panel rounded-3xl p-6 border border-white/10 shadow-2xl animate-slide-up transform transition-all">
                        <button onClick={onClose} className="absolute top-4 right-4 w-8 h-8 flex items-center justify-center bg-white/5 rounded-full text-white/50 hover:bg-white/10">
                            <i className="fa-solid fa-xmark"></i>
                        </button>
                        
                        <div className="flex flex-col items-center text-center mb-6">
                            <div className={`w-20 h-20 rounded-full flex items-center justify-center mb-4 ${category === 'Supercell' ? 'bg-blue-500/20' : 'bg-brand-500/20'} ring-1 ring-white/10`}>
                                <FaIcon name={icon} sizeClass="text-3xl" className={category === 'Supercell' ? '' : 'text-brand-400'} />
                            </div>
                            <h2 className="text-2xl font-display font-bold text-white">{category}</h2>
                            <p className="text-white/40 text-xs font-bold tracking-widest uppercase mt-1">Category Info</p>
                        </div>
                        
                        <div className="bg-white/5 rounded-xl p-4 border border-white/5">
                            <h3 className="text-white/70 text-sm font-semibold mb-2 flex items-center gap-2">
                                <i className="fa-solid fa-list-ul text-brand-400 text-xs"></i> Examples
                            </h3>
                            <p className="text-white/90 text-sm leading-relaxed">
                                {examples}{remainingCount > 0 ? `, and ${Math.floor(remainingCount / 10) * 10}+ more` : ''}
                            </p>
                        </div>
                        
                        <div className="mt-6 text-center text-white/30 text-xs">
                            Tap anywhere to close
                        </div>
                    </div>
                </div>
            );
        };
        
        // NEW: Modal for removed players
        const RemovedModal = ({ onClose }) => {
			return (
				<div className="fixed inset-0 z-50 flex items-center justify-center p-6 animate-fadeIn">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-md"></div>
                    <div className="relative w-full max-w-sm glass-panel rounded-3xl p-6 border border-white/10 shadow-2xl animate-slide-up text-center">
                        <div className="w-20 h-20 rounded-full flex items-center justify-center mb-4 bg-red-500/20 ring-1 ring-white/10 mx-auto">
                            <i className="fa-solid fa-user-slash text-3xl text-red-400"></i>
                        </div>
                        <h2 className="text-2xl font-display font-bold text-white mb-2">Removed from Lobby</h2>
                        <p className="text-white/60 mb-6">The host has removed you from the mission lobby.</p>
                        
                        <button 
                            onClick={onClose}
                            className="w-full bg-white hover:bg-slate-200 text-slate-950 py-3 rounded-xl font-display font-bold text-base shadow-[0_0_20px_rgba(255,255,255,0.1)] active:scale-95 transition-all flex items-center justify-center gap-3"
                        >
                            RETURN TO HOME
                        </button>
                    </div>
                </div>
            );
        };
        
        // NEW: Modal for when host closes lobby
        const LobbyClosedModal = ({ hostName, onClose }) => {
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-6 animate-fadeIn">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-md"></div>
                    <div className="relative w-full max-w-sm glass-panel rounded-3xl p-6 border border-white/10 shadow-2xl animate-slide-up text-center">
                        <div className="w-20 h-20 rounded-full flex items-center justify-center mb-4 bg-yellow-500/20 ring-1 ring-white/10 mx-auto">
                            <i className="fa-solid fa-door-open text-3xl text-yellow-400"></i>
                        </div>
                        <h2 className="text-2xl font-display font-bold text-white mb-2">Lobby Closed</h2>
                        <p className="text-white/60 mb-6">{hostName} has left the mission. The lobby has been closed.</p>
                        
                        <button 
                            onClick={onClose}
                            className="w-full bg-white hover:bg-slate-200 text-slate-950 py-3 rounded-xl font-display font-bold text-base shadow-[0_0_20px_rgba(255,255,255,0.1)] active:scale-95 transition-all flex items-center justify-center gap-3"
                        >
                            RETURN TO HOME
                        </button>
                    </div>
                </div>
            );
        };

        // NEW: Modal to review turn order during game
        const TurnOrderReviewModal = ({ players, onClose }) => {
            if (!players || players.length === 0) return null;
            
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-6 animate-fadeIn">
                    <div className="absolute inset-0 bg-black/70 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative w-full max-w-sm glass-panel rounded-3xl p-6 border border-white/10 shadow-2xl animate-slide-up flex flex-col max-h-[80vh]">
                        <h2 className="flex-shrink-0 text-xl font-display font-bold text-white mb-6 text-center flex items-center justify-center gap-3">
                            <i className="fa-solid fa-list-ol text-brand-400"></i>
                            Mission Turn Order
                        </h2>
                        <div className="flex-1 overflow-y-auto no-scrollbar space-y-3">
                            {players.map((player, index) => (
                                <div key={player.id || index} className="flex items-center gap-3 bg-white/5 p-3 rounded-lg">
                                    <div className="flex-shrink-0 w-8 h-8 flex items-center justify-center bg-sky-900/50 text-sky-400 font-mono font-bold text-sm rounded-md border border-sky-400/20">{index + 1}</div>
                                    <PlayerAvatar name={player.name} className="w-6 h-6 rounded-full" />
                                    <div className="font-semibold text-white/90 truncate">{player.name}</div>
                                </div>
                            ))}
                        </div>
                        <button 
                            onClick={onClose}
                            className="flex-shrink-0 w-full mt-6 bg-white/10 hover:bg-white/20 text-white/80 py-3 rounded-xl font-display font-bold text-base active:scale-95 transition-all"
                        >
                            CLOSE
                        </button>
                    </div>
                </div>
            );
        };
        
        // NEW: Modal to confirm leaving a lobby
        const ExitLobbyConfirmModal = ({ onConfirm, onCancel }) => {
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-6 animate-fadeIn">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-md"></div>
                    <div className="relative w-full max-w-sm glass-panel rounded-3xl p-6 border border-white/10 shadow-2xl animate-slide-up text-center">
                        <div className="w-20 h-20 rounded-full flex items-center justify-center mb-4 bg-yellow-500/20 ring-1 ring-white/10 mx-auto">
                            <i className="fa-solid fa-door-open text-3xl text-yellow-400"></i>
                        </div>
                        <h2 className="text-2xl font-display font-bold text-white mb-2">Leave Lobby?</h2>
                        <p className="text-white/60 mb-6">Are you sure you want to exit? The host may start the next round without you.</p>
                        
                        <div className="flex flex-col gap-3">
                            <button 
                                onClick={onConfirm}
                                className="w-full bg-red-600 hover:bg-red-500 text-white py-3 rounded-xl font-display font-bold text-base active:scale-95 transition-all"
                            >
                                Yes, Exit Lobby
                            </button>
                            <button 
                                onClick={onCancel}
                                className="w-full bg-white/10 hover:bg-white/20 text-white/80 py-3 rounded-xl font-display font-bold text-base active:scale-95 transition-all"
                            >
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // 1. Setup Screen
        const SetupScreen = ({ onStartGame, audioManager, onBack }) => {
            const DEFAULT_PLAYERS = [{ name: 'Player 1', audioData: null }, { name: 'Player 2', audioData: null }, { name: 'Player 3', audioData: null }];
            const MIN_PLAYERS = 3;

            // --- State Persistence Logic ---
            const [players, setPlayers] = useState(() => {
                try {
                    const saved = localStorage.getItem('imposter_players');
                    if (saved) {
                        let parsed = JSON.parse(saved);
                        if (Array.isArray(parsed) && parsed.length > 0) {
                            if (typeof parsed === 'string') {
                                parsed = parsed.map(name => ({ name, audioData: null }));
                            }
                            return parsed;
                        }
                    }
                    return DEFAULT_PLAYERS;
                } catch {
                    return DEFAULT_PLAYERS;
                }
            });

            const [selectedCategory, setSelectedCategory] = useState(() => {
                try {
                    const saved = localStorage.getItem('imposter_category');
                    return saved ? JSON.parse(saved) : 'Movies';
                } catch { return 'Movies'; }
            });

            const [isRandomMode, setIsRandomMode] = useState(() => {
                try {
                    const saved = localStorage.getItem('imposter_random_mode');
                    return saved ? JSON.parse(saved) : false;
                } catch { return false; }
            });
            
            const [speakCategory, setSpeakCategory] = useState(() => {
                try {
                    const saved = localStorage.getItem('imposter_speak_category');
                    return saved ? JSON.parse(saved) : false;
                } catch { return false; }
            });

            const [isFakeWordMode, setIsFakeWordMode] = useState(() => {
                try {
                    const saved = localStorage.getItem('imposter_fake_word_mode');
                    return saved ? JSON.parse(saved) : false;
                } catch { return false; }
            });

            const [newPlayerName, setNewPlayerName] = useState('');
            const [timerMinutes, setTimerMinutes] = useState(3);
            const [timerEnabled, setTimerEnabled] = useState(true);
            const [inspectedCategory, setInspectedCategory] = useState(null);
            const [enableTwoImposters, setEnableTwoImposters] = useState(false);
            
            // Voice recording state
            const [isRecording, setIsRecording] = useState(false);
            const [recordedAudioData, setRecordedAudioData] = useState(null);
            const [showMicTooltip, setShowMicTooltip] = useState(false);
            const mediaRecorderRef = useRef(null);
            const audioChunksRef = useRef([]);
            const micTooltipTimer = useRef(null);

            // Long press logic
            const categoryLongPressTimerRef = useRef(null);
            const playerPressTimerRef = useRef(null);
            
            // --- Save effects ---
            useEffect(() => { localStorage.setItem('imposter_players', JSON.stringify(players)); }, [players]);
            useEffect(() => { localStorage.setItem('imposter_category', JSON.stringify(selectedCategory)); }, [selectedCategory]);
            useEffect(() => { localStorage.setItem('imposter_random_mode', JSON.stringify(isRandomMode)); }, [isRandomMode]);
            useEffect(() => { localStorage.setItem('imposter_speak_category', JSON.stringify(speakCategory)); }, [speakCategory]);
            useEffect(() => { localStorage.setItem('imposter_fake_word_mode', JSON.stringify(isFakeWordMode)); }, [isFakeWordMode]);

            useEffect(() => {
                if (players.length < 10) {
                    setEnableTwoImposters(false);
                }
            }, [players]);

            const handleMicClick = async () => {
                if (isRecording) {
                    mediaRecorderRef.current.stop();
                    setIsRecording(false);
                } else {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        audioChunksRef.current = [];
                        const mediaRecorder = new MediaRecorder(stream);
                        mediaRecorderRef.current = mediaRecorder;

                        mediaRecorder.ondataavailable = event => {
                            audioChunksRef.current.push(event.data);
                        };

                        mediaRecorder.onstop = () => {
                            const audioBlob = new Blob(audioChunksRef.current, { type: 'audio/webm' });
                            const reader = new FileReader();
                            reader.readAsDataURL(audioBlob);
                            reader.onloadend = () => {
                                setRecordedAudioData(reader.result); // Save as Base64 data URL
                            };
                            stream.getTracks().forEach(track => track.stop());
                        };

                        mediaRecorder.start();
                        setIsRecording(true);
                        setRecordedAudioData(null); // Clear previous recording
                    } catch (err) {
                        console.error("Error accessing microphone:", err);
                        alert("Microphone access was denied. Please allow it in your browser settings.");
                    }
                }
            };
            
            const addPlayer = () => {
                if (newPlayerName.trim()) {
                    audioManager.playSound('uiClick');
                    setPlayers([...players, { name: newPlayerName.trim(), audioData: recordedAudioData }]);
                    setNewPlayerName('');
                    setRecordedAudioData(null); // Reset for the next player
                    if (navigator.vibrate) navigator.vibrate(10);
                }
            };

            const removePlayer = (index) => {
                if (players.length > MIN_PLAYERS) {
                    audioManager.playSound('uiClick');
                    setPlayers(players.filter((_, i) => i !== index));
                    if (navigator.vibrate) navigator.vibrate(10);
                }
            };

            const handleCategorySelect = (cat) => {
                if (selectedCategory !== cat) {
                    audioManager.playSound('selectCategory');
                }
                setSelectedCategory(cat);
                if (navigator.vibrate) navigator.vibrate(5);
            };
            
            const handleCategoryTouchStart = (cat) => {
                categoryLongPressTimerRef.current = setTimeout(() => {
                    setInspectedCategory(cat);
                    audioManager.playSound('openInfo');
                    if (navigator.vibrate) navigator.vibrate(30);
                }, 600);
            };

            const handleCategoryTouchEnd = () => {
                if (categoryLongPressTimerRef.current) {
                    clearTimeout(categoryLongPressTimerRef.current);
                    categoryLongPressTimerRef.current = null;
                }
            };
            
            const handlePlayerPress = (player) => {
                if (player.audioData) {
                    playerPressTimerRef.current = setTimeout(() => {
                        const audio = new Audio(player.audioData);
                        audio.play().catch(e => console.error("Failed to play custom audio:", e));
                        if (navigator.vibrate) navigator.vibrate(20);
                    }, 300);
                }
            };

            const handlePlayerRelease = () => {
                if (playerPressTimerRef.current) {
                    clearTimeout(playerPressTimerRef.current);
                }
            };

            const handleMicPress = () => {
                micTooltipTimer.current = setTimeout(() => setShowMicTooltip(true), 500);
            };
            const handleMicRelease = () => {
                clearTimeout(micTooltipTimer.current);
                setShowMicTooltip(false);
            };

            const handleStartClick = () => {
                if (players.length >= MIN_PLAYERS) {
                    if (navigator.vibrate) navigator.vibrate(30);
                    audioManager.playSound(isRandomMode ? 'startRandomMission' : 'startMission');
                    onStartGame(players, isRandomMode ? [] : [selectedCategory], timerEnabled ? timerMinutes * 60 : null, isRandomMode, speakCategory, enableTwoImposters, isFakeWordMode);
                }
            };
            
            const handleModeChange = (newModeIsRandom) => {
                if (isRandomMode !== newModeIsRandom) {
                    audioManager.playSound('toggleMode');
                    setIsRandomMode(newModeIsRandom);
                }
            };

            return (
                <div className="flex flex-col h-[100dvh] relative z-10">
                    <div className="absolute top-6 left-6 z-20">
                         <button onClick={onBack} className="w-12 h-12 flex items-center justify-center bg-white/5 rounded-full text-white/50 hover:bg-white/10 active:scale-90 transition-transform">
                            <i className="fa-solid fa-chevron-left"></i>
                        </button>
                    </div>
                    <CategoryInfoModal category={inspectedCategory} onClose={() => setInspectedCategory(null)} />

                    <div className="flex-1 overflow-y-auto no-scrollbar pb-32">
                        <div className="max-w-lg mx-auto p-6 pt-28">
                            {/* Header */}
                            <div class="mb-10 text-center">
								<h1 class="text-6xl font-display font-black text-transparent bg-clip-text bg-gradient-to-br from-white via-white to-white/50 mb-2 drop-shadow-lg tracking-tight">IMPOSTER</h1>
								<div class="subtle-shine-container inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/5 border border-white/10 backdrop-blur-md">
									<span class="text-white/60 text-[10px] font-bold tracking-[0.3em] uppercase">Local Game</span>
								</div>
							</div>

                            {/* Players */}
                            <section className="mb-6 glass-panel rounded-[2rem] p-6">
                                <h2 className="text-sm font-bold tracking-widest text-brand-400 mb-4 flex items-center gap-2 uppercase">
                                    <i className="fa-solid fa-users"></i> Agents
                                    <span className="ml-auto text-[10px] bg-white/5 px-2 py-1 rounded-md text-white/50">{players.length} / {MIN_PLAYERS}+</span>
                                </h2>
                                <div className="flex flex-col gap-3 mb-4">
                                    <div className="flex items-center gap-3 bg-slate-950/50 rounded-xl border border-white/5 focus-within:border-brand-500/50 focus-within:bg-slate-950/80 transition-all pr-4">
                                        <input
                                            type="text"
                                            value={newPlayerName}
                                            onChange={(e) => setNewPlayerName(e.target.value)}
                                            onKeyDown={(e) => e.key === 'Enter' && addPlayer()}
                                            placeholder="Enter codename..."
                                            className="flex-1 bg-transparent px-5 py-4 outline-none placeholder:text-white/20 font-medium text-sm text-white min-w-0"
                                        />
                                        {newPlayerName.trim() && <PlayerAvatar name={newPlayerName.trim()} className="w-8 h-8 rounded-full" />}
                                    </div>
                                    <div className="flex gap-3 relative">
                                        <button 
                                            onClick={handleMicClick}
                                            onMouseDown={handleMicPress}
                                            onMouseUp={handleMicRelease}
                                            onMouseLeave={handleMicRelease}
                                            onTouchStart={handleMicPress}
                                            onTouchEnd={handleMicRelease}
                                            className={`flex-1 flex items-center justify-center rounded-xl font-bold transition-all shadow-lg active:scale-95 border border-white/10 h-14 ${isRecording ? 'bg-red-500 animate-pulse' : (recordedAudioData ? 'bg-green-500' : 'bg-white/10 hover:bg-white/20')}`}
                                        >
                                            <i className={`fa-solid ${recordedAudioData && !isRecording ? 'fa-check' : 'fa-microphone'} text-white text-lg ${isRecording ? '' : 'opacity-70'}`}></i>
                                        </button>
                                        
                                        {showMicTooltip && (
                                            <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs bg-slate-800 text-white text-xs rounded-md px-3 py-2 shadow-lg animate-fadeIn z-20">
                                                Record a custom "It's your turn" voice note!
                                                <div className="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-4 border-x-transparent border-t-4 border-t-slate-800"></div>
                                            </div>
                                        )}
                                        
                                        <button 
                                            onClick={addPlayer}
                                            className="bg-brand-600 hover:bg-brand-500 flex-1 flex items-center justify-center rounded-xl font-bold transition shadow-lg shadow-brand-900/20 active:scale-95 border border-white/10 h-14"
                                        >
                                            <i className="fa-solid fa-plus text-white text-lg"></i>
                                        </button>
                                    </div>
                                </div>
                                <div className="flex flex-wrap gap-2">
                                    {players.map((p, i) => (
                                        <div 
                                            key={i} 
                                            className="flex items-center gap-2 bg-white/5 border border-white/5 pl-2 pr-1.5 py-1.5 rounded-full animate-fadeIn group hover:bg-white/10 transition-colors cursor-pointer"
                                            onMouseDown={() => handlePlayerPress(p)}
                                            onMouseUp={handlePlayerRelease}
                                            onMouseLeave={handlePlayerRelease}
                                            onTouchStart={() => handlePlayerPress(p)}
                                            onTouchEnd={handlePlayerRelease}
                                        >
                                            <PlayerAvatar name={p.name} className="w-5 h-5 rounded-full" />
                                            {p.audioData && <i className="fa-solid fa-microphone text-brand-400/50 text-xs"></i>}
                                            <span className="text-xs font-bold text-slate-300 pr-1">{p.name}</span>
                                            <button 
                                                onClick={(e) => { e.stopPropagation(); removePlayer(i); }}
                                                disabled={players.length <= MIN_PLAYERS}
                                                className={`w-6 h-6 flex items-center justify-center rounded-full text-[10px] transition-colors 
                                                    ${players.length > MIN_PLAYERS 
                                                        ? 'bg-white/5 hover:bg-red-500/20 text-white/40 hover:text-red-400' 
                                                        : 'opacity-20 cursor-not-allowed'
                                                    }`}
                                            >
                                                <i className="fa-solid fa-xmark"></i>
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            </section>

                            {/* Settings */}
                            <section className="mb-6 glass-panel rounded-[2rem] p-6 space-y-3">
                                <div className="flex items-center justify-between">
                                    <div className="pr-4">
                                        <h3 className="font-bold text-white/90 text-base flex items-center gap-3">
                                            <i className="fa-solid fa-masks-theater text-yellow-400/80 w-5 text-center"></i>
                                            <span>Fake Word Mode</span>
                                        </h3>
                                        <p className="text-white/40 text-xs mt-1 pl-8">One agent gets a different word. They don't know it's fake.</p>
                                    </div>
                                    <button 
                                        onClick={() => {
                                            setIsFakeWordMode(!isFakeWordMode);
                                            audioManager.playSound(!isFakeWordMode ? 'switchOn' : 'switchOff');
                                            if(navigator.vibrate) navigator.vibrate(10);
                                        }}
                                        className={`flex-shrink-0 w-12 h-7 rounded-full p-1 transition-all duration-300 ${isFakeWordMode ? 'bg-yellow-500/80' : 'bg-white/10'}`}
                                    >
                                        <div className={`w-5 h-5 bg-white rounded-full shadow-md transform transition-transform duration-300 ${isFakeWordMode ? 'translate-x-5' : 'translate-x-0'}`} />
                                    </button>
                                </div>
                                
                                <div className="h-px bg-white/10"></div>

                                <div 
                                    className={`flex items-center justify-between transition-opacity duration-300 ${(players.length < 10 || isFakeWordMode) ? 'opacity-50' : ''}`}
                                    title={isFakeWordMode ? "Disabled in Fake Word Mode" : (players.length < 10 ? "Requires 10 or more players" : "Add a second spy to the mission")}
                                >
                                    <div className="pr-4">
                                        <h3 className="font-bold text-white/90 text-base flex items-center gap-3">
                                            <i className="fa-solid fa-user-secret text-orange-400/80 w-5 text-center"></i>
                                            <span>{isFakeWordMode ? 'Second Fake Card' : 'Second Imposter'}</span>
                                        </h3>
                                        <p className="text-white/40 text-xs mt-1 pl-8">Adds a second rogue agent when 10 or more players are in the lobby.</p>
                                    </div>
                                    <button 
                                        onClick={() => {
                                            if (players.length >= 10 && !isFakeWordMode) {
                                                setEnableTwoImposters(!enableTwoImposters);
                                                audioManager.playSound(!enableTwoImposters ? 'switchOn' : 'switchOff');
                                                if(navigator.vibrate) navigator.vibrate(10);
                                            }
                                        }}
                                        disabled={players.length < 10 || isFakeWordMode}
                                        className={`flex-shrink-0 w-12 h-7 rounded-full p-1 transition-all duration-300 ${enableTwoImposters ? 'bg-orange-500/80' : 'bg-white/10'} ${(players.length < 10 || isFakeWordMode) ? 'cursor-not-allowed' : ''}`}
                                    >
                                        <div className={`w-5 h-5 bg-white rounded-full shadow-md transform transition-transform duration-300 ${enableTwoImposters ? 'translate-x-5' : 'translate-x-0'}`} />
                                    </button>
                                </div>

                                <div className="h-px bg-white/10"></div>

                                <div className={`flex items-center justify-between transition-all duration-300`}>
                                     <div className="pr-4">
                                        <h3 className="font-bold text-white/90 text-base flex items-center gap-3">
                                            <i className="fa-solid fa-stopwatch text-sky-400/80 w-5 text-center"></i>
                                            <span>Countdown Timer</span>
                                        </h3>
                                        <p className="text-white/40 text-xs mt-1 pl-8">Sets a time limit for discussion. When disabled, the game is untimed.</p>
                                    </div>
                                    <button 
                                        onClick={() => {
                                            setTimerEnabled(!timerEnabled);
                                            audioManager.playSound(!timerEnabled ? 'switchOn' : 'switchOff');
                                            if(navigator.vibrate) navigator.vibrate(10);
                                        }}
                                        className={`flex-shrink-0 w-12 h-7 rounded-full p-1 transition-all duration-300 ${timerEnabled ? 'bg-sky-500/80' : 'bg-white/10'}`}
                                    >
                                        <div className={`w-5 h-5 bg-white rounded-full shadow-md transform transition-transform duration-300 ${timerEnabled ? 'translate-x-5' : 'translate-x-0'}`} />
                                    </button>
                                </div>
                                <div className={`transition-all duration-300 overflow-hidden ${timerEnabled ? 'opacity-100 max-h-40 pt-4' : 'opacity-0 max-h-0'}`}>
                                    <div className="flex justify-between items-end mb-2 px-1">
                                        <span className="text-white/40 text-[10px] font-bold uppercase">Duration</span>
                                        <span className="font-mono text-xl font-bold text-white">{timerMinutes} <span className="text-sm text-white/50">min</span></span>
                                    </div>
                                    <input
										type="range"
										min="1"
										max="15"
										value={timerMinutes}
										onChange={(e) => setTimerMinutes(parseInt(e.target.value))}
										className="w-full h-7 appearance-none cursor-pointer timer-slider bg-transparent"
									/>
                                </div>

                                <div className="h-px bg-white/10"></div>

                                 <div className="flex items-center justify-between">
                                    <div className="pr-4">
                                        <h3 className="font-bold text-white/90 text-base flex items-center gap-3">
                                            <i className="fa-solid fa-volume-high text-purple-400/80 w-5 text-center"></i>
                                            <span>Speak Category</span>
                                        </h3>
                                        <p className="text-white/40 text-xs mt-1 pl-8">Announces the chosen category name when the mission begins.</p>
                                    </div>
                                    <button 
                                        onClick={() => {
                                            setSpeakCategory(!speakCategory);
                                            audioManager.playSound(!speakCategory ? 'switchOn' : 'switchOff');
                                            if(navigator.vibrate) navigator.vibrate(10);
                                        }}
                                        className={`flex-shrink-0 w-12 h-7 rounded-full p-1 transition-all duration-300 ${speakCategory ? 'bg-purple-500/80' : 'bg-white/10'}`}
                                    >
                                        <div className={`w-5 h-5 bg-white rounded-full shadow-md transform transition-transform duration-300 ${speakCategory ? 'translate-x-5' : 'translate-x-0'}`} />
                                    </button>
                                </div>
                            </section>

                            {/* Categories */}
                            <section>
                                <div className="flex items-center justify-between mb-4 px-2">
                                    <h2 className="text-sm font-bold tracking-widest text-teal-400 flex items-center gap-2 uppercase">
                                        <i className="fa-solid fa-layer-group"></i> Mission
                                    </h2>
                                    
                                    <div className="flex bg-slate-950/50 p-1 rounded-lg border border-white/5">
                                        <button 
                                            onClick={() => handleModeChange(false)}
                                            className={`px-3 py-1.5 rounded-md text-[10px] font-bold uppercase tracking-wide transition-all ${!isRandomMode ? 'bg-white/10 text-white shadow-sm' : 'text-white/30 hover:text-white/60'}`}
                                        >
                                            Select
                                        </button>
                                        <button 
                                            onClick={() => handleModeChange(true)}
                                            className={`px-3 py-1.5 rounded-md text-[10px] font-bold uppercase tracking-wide transition-all ${isRandomMode ? 'bg-gradient-to-r from-brand-600 to-fuchsia-600 text-white shadow-sm' : 'text-white/30 hover:text-white/60'}`}
                                        >
                                            Random
                                        </button>
                                    </div>
                                </div>

                                {isRandomMode ? (
                                    <div className="glass-panel rounded-[2rem] p-8 text-center animate-fadeIn border border-brand-500/20 relative overflow-hidden group">
                                        <div className="absolute inset-0 bg-gradient-to-br from-brand-500/10 via-transparent to-fuchsia-500/10 opacity-50 group-hover:opacity-100 transition-opacity duration-700"></div>
                                        <div className="relative z-10 py-8">
                                            <div className="w-24 h-24 mx-auto bg-gradient-to-br from-brand-500 to-fuchsia-600 rounded-3xl rotate-12 flex items-center justify-center shadow-lg shadow-brand-900/40 mb-6 group-hover:rotate-[20deg] group-hover:scale-110 transition-transform duration-500">
                                                <i className="fa-solid fa-dice text-4xl text-white drop-shadow-md"></i>
                                            </div>
                                            <h3 className="text-2xl font-display font-bold text-white mb-2">Mystery Mode</h3>
                                            <p className="text-white/50 text-sm max-w-[200px] mx-auto leading-relaxed">
                                                The system will automatically select a random category for your mission.
                                            </p>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-2 sm:grid-cols-3 gap-3 animate-fadeIn">
                                        {DISPLAY_CATEGORIES.map(cat => {
                                            const iconSource = CATEGORY_ICONS[cat];
                                            const isSelected = selectedCategory === cat;
                                            const isSupercell = cat === 'Supercell';
                                            
                                            // Conditional styling logic
                                            let cardClasses = `relative overflow-hidden flex flex-col items-center justify-center gap-3 p-4 rounded-[1.5rem] border transition-all duration-300 active:scale-95 group min-h-[110px] `;
                                            
                                            if (isSupercell) {
                                                if (isSelected) {
                                                    cardClasses += 'border-blue-400 bg-blue-900/20 ring-2 ring-blue-500 shadow-lg shadow-blue-900/40 text-white';
                                                } else {
                                                    cardClasses += 'border-white/10 bg-slate-900/40 opacity-60 grayscale-[0.5] hover:opacity-100 hover:grayscale-0 text-slate-300';
                                                }
                                            } else {
                                                if (isSelected) {
                                                    cardClasses += 'glass-panel bg-teal-500/10 border-teal-500/40 text-teal-100 shadow-[0_0_20px_rgba(20,184,166,0.1)]';
                                                } else {
                                                    cardClasses += 'glass-panel-lighter border-white/5 text-slate-400 hover:bg-white/5 hover:border-white/10';
                                                }
                                            }

                                            return (
                                                <button
                                                    key={cat}
                                                    onClick={() => handleCategorySelect(cat)}
                                                    onMouseDown={() => handleCategoryTouchStart(cat)}
                                                    onMouseUp={handleCategoryTouchEnd}
                                                    onMouseLeave={handleCategoryTouchEnd}
                                                    onTouchStart={() => handleCategoryTouchStart(cat)}
                                                    onTouchEnd={handleCategoryTouchEnd}
                                                    onTouchMove={handleCategoryTouchEnd}
                                                    className={cardClasses}
                                                >
                                                    {/* Supercell Background Layers */}
                                                    {isSupercell && (
                                                        <div className="supercell-container pointer-events-none">
                                                            <div className="supercell-bg-1"></div>
                                                            <div className="supercell-bg-2"></div>
                                                        </div>
                                                    )}

                                                    <div className="relative z-10 flex flex-col items-center gap-2">
                                                        <FaIcon 
                                                            name={iconSource} 
                                                            sizeClass="text-2xl" 
                                                            className={`transition-all duration-300 ${isSupercell ? "drop-shadow-md brightness-125" : (isSelected ? "text-teal-400 scale-110" : "text-white/40 group-hover:text-white/70")}`} 
                                                        />
                                                        <span className={`text-xs font-bold tracking-wide transition-colors ${isSupercell ? 'text-white drop-shadow-md' : ''}`}>{cat}</span>
                                                    </div>

                                                    {/* Selection Indicator Checkmark */}
                                                    {isSelected && (
                                                        <div className={`absolute top-3 right-3 w-5 h-5 rounded-full flex items-center justify-center text-[10px] shadow-sm ${isSupercell ? 'bg-blue-500 text-white' : 'bg-teal-500 text-slate-900'}`}>
                                                            <i className="fa-solid fa-check"></i>
                                                        </div>
                                                    )}
                                                </button>
                                            )
                                        })}
                                    </div>
                                )}
                            </section>
                        </div>
                    </div>

                    {/* Fixed Bottom Start Button */}
                    <div className="fixed bottom-0 left-0 w-full p-6 bg-gradient-to-t from-[#020617] via-[#020617] to-transparent z-50">
                        <div className="max-w-lg mx-auto pb-[env(safe-area-inset-bottom)]">
                            <button
                                onClick={handleStartClick}
                                disabled={players.length < MIN_PLAYERS}
                                className="w-full bg-white text-slate-950 font-display font-bold text-lg py-5 rounded-[1.5rem] shadow-[0_0_30px_rgba(255,255,255,0.1)] hover:shadow-[0_0_50px_rgba(255,255,255,0.2)] disabled:opacity-50 disabled:shadow-none active:scale-[0.98] transition-all flex items-center justify-center gap-3 relative overflow-hidden group"
                            >
                                <div className="absolute inset-0 bg-gradient-to-r from-transparent via-slate-200/50 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-1000"></div>
                                <span className="relative z-10 flex items-center gap-3">
                                    <i className="fa-solid fa-play text-sm"></i> START MISSION
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // 2. Card Reveal Screen (Enhanced with 3D Flip)
        const CardRevealScreen = ({ player, word, onNext, isLastPlayer, audioManager, onAcknowledge, isOnline, onConfused }) => {
            const [step, setStep] = useState(isOnline ? 'reveal' : 'handover'); 
            const [isFlipped, setIsFlipped] = useState(false);
            
            useEffect(() => {
                if(!isOnline) {
                    setStep('handover');
                    setIsFlipped(false);
                } else {
                    setStep('reveal');
                }
            }, [player, isOnline]);
            
            useEffect(() => {
                if (step === 'handover' && player.audioData) {
                    const audio = new Audio(player.audioData);
                    audio.play().catch(e => console.error("Custom audio playback failed:", e));
                }
            }, [player, step]);

            const handleReveal = () => {
                if (!isFlipped) {
                    setIsFlipped(true);
                    audioManager.playSound('uiClick');
                    if (navigator.vibrate) navigator.vibrate();
                }
            };
            
            const handleAckAndNext = () => {
                 audioManager.playSound('uiClick');
                if (isOnline) {
                    onAcknowledge();
                } else {
                    if(navigator.vibrate) navigator.vibrate(20);
                    onNext();
                }
            };

            const renderHandover = () => (
                <div className="flex flex-col items-center justify-center h-full text-center p-8 animate-slide-up relative z-10">
                    <div className="w-32 h-32 rounded-full flex items-center justify-center mb-10 relative">
                        <div className="absolute inset-0 bg-brand-500/20 blur-2xl rounded-full animate-pulse-slow"></div>
                        <div className="glass-panel w-full h-full rounded-full flex items-center justify-center border border-white/10 overflow-hidden">
                            <img src="https://em-content.zobj.net/source/microsoft-teams/363/detective_light-skin-tone_1f575-1f3fb_1f3fb.png" alt="Detective" draggable="false" className="w-35 h-35 relative top-3" />
                        </div>
                    </div>
                    
                    <h2 className="text-brand-400 text-xs font-bold uppercase tracking-[0.4em] mb-4">Classified Info For</h2>
                    <h1 className="text-6xl font-display font-black text-white mb-16 drop-shadow-2xl">{player.name}</h1>
                    
                    <div className="w-full max-w-sm">
                        <button 
                            onClick={() => {
                                audioManager.playSound('uiClick');
                                setStep('reveal');
                                if (navigator.vibrate) navigator.vibrate(20);
                            }}
                            className="w-full glass-panel hover:bg-white/5 border border-white/10 text-white font-display font-bold text-lg py-5 rounded-[1.5rem] transition-all active:scale-95 flex items-center justify-center gap-3"
                        >
                            <i className="fa-solid fa-fingerprint text-brand-400"></i> Verify Identity
                        </button>
                    </div>
                </div>
            );

            const renderFlipCard = () => (
                <div className="flex flex-col items-center justify-center h-full w-full p-6 relative">
                    {/* Background Overlay */}
                    <div className="absolute inset-0 bg-slate-950/80 backdrop-blur-sm z-0"></div>

                    {/* Card Container */}
                    <div className="relative w-full max-w-xs aspect-[3/4] perspective-1000 z-10 cursor-pointer" onClick={handleReveal}>
                        <div className={`relative w-full h-full transition-transform duration-700 transform-style-3d ${isFlipped ? 'rotate-y-180' : ''}`}>
                            
                            {/* FRONT (Locked) */}
                            <div className="absolute inset-0 backface-hidden">
                                <div className="w-full h-full bg-slate-900 rounded-[2.5rem] border border-white/10 shadow-2xl flex flex-col items-center justify-center p-8 relative overflow-hidden group">
                                    <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/soft-wallpaper.png')] opacity-10"></div>
                                    <div className="absolute inset-0 bg-gradient-to-br from-white/5 to-transparent pointer-events-none"></div>

                                    <div className="w-24 h-24 bg-slate-800 rounded-full flex items-center justify-center mb-8 ring-1 ring-white/10 shadow-[0_0_30px_rgba(0,0,0,0.5)]">
                                        <img src="https://em-content.zobj.net/source/microsoft-teams/337/locked_1f512.png" alt="Locked" draggable="false" className="w-12 h-12" />
                                    </div>
                                    <h3 className="text-white font-display font-bold text-2xl mb-2">TOP SECRET</h3>
                                    <p className="text-white/40 font-medium text-sm text-center tracking-wide">Tap to decrypt</p>
                                    
                                    <div className="absolute bottom-10 flex gap-2 items-center text-white/20 text-[10px] font-bold uppercase tracking-widest animate-pulse">
                                        <span>Tap to Open</span>
                                    </div>
                                </div>
                            </div>

                            {/* BACK (Revealed) */}
                            <div className="absolute inset-0 rotate-y-180 backface-hidden">
                                <div className={`w-full h-full rounded-[2.5rem] flex flex-col items-center justify-center p-8 text-center relative overflow-hidden shadow-2xl border ${
                                     word === "IMPOSTER" 
                                        ? 'bg-gradient-to-br from-red-950 to-slate-950 border-red-500/20' 
                                        : 'bg-gradient-to-br from-teal-950 to-slate-950 border-teal-500/20'
                                }`}>
                                    
                                    {/* Shine Effect */}
                                    <div className="absolute inset-0 z-0 opacity-20 pointer-events-none overflow-hidden">
                                         <div className="absolute w-[200%] h-[200%] bg-gradient-to-r from-transparent via-white/10 to-transparent animate-shine"></div>
                                    </div>

                                    <div className={`absolute top-[-50%] w-full h-full opacity-30 blur-[100px] z-0 ${word === 'IMPOSTER' ? 'bg-red-600' : 'bg-teal-500'}`}></div>

                                    <div className="relative z-10 flex flex-col items-center justify-center h-full">
                                        <p className={`text-[10px] uppercase tracking-[0.4em] font-bold mb-8 ${word === 'IMPOSTER' ? 'text-red-400' : 'text-teal-400'}`}>Your Mission Role</p>
                                        
                                        {word === "IMPOSTER" ? (
                                            <>
                                                <div className="w-28 h-28 bg-red-500/10 rounded-full flex items-center justify-center mb-6 ring-1 ring-red-500/30 shadow-[0_0_60px_rgba(239,68,68,0.2)]">
                                                    <img src="https://em-content.zobj.net/source/microsoft-teams/337/shushing-face_1f92b.png" alt="Shushing" draggable="false" className="w-16 h-16 drop-shadow-lg" />
                                                </div>
                                                <h2 className="text-4xl font-display font-black text-red-500 tracking-tight mb-4 drop-shadow-sm">IMPOSTER</h2>
                                                <p className="text-red-200/60 text-xs font-medium leading-relaxed max-w-[200px]">Blend in. Deceive. Don't let them know you are the spy.</p>
                                            </>
                                        ) : (
                                            <>
                                                <div className="w-28 h-28 bg-teal-500/10 rounded-full flex items-center justify-center mb-6 ring-1 ring-teal-500/30 shadow-[0_0_60px_rgba(20,184,166,0.2)]">
                                                    <img src="https://em-content.zobj.net/source/microsoft-teams/337/clipboard_1f4cb.png" alt="Clipboard" draggable="false" className="w-16 h-16 drop-shadow-lg" />
                                                </div>
                                                <h2 className="text-3xl font-display font-bold text-white mb-4 drop-shadow-sm">{word}</h2>
                                                <p className="text-teal-200/60 text-xs font-medium leading-relaxed max-w-[200px]">Memorize this word. It proves your innocence.</p>
                                            </>
                                        )}
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    {/* Action Buttons */}
                    <div className={`w-full max-w-sm mt-8 transition-all duration-700 transform ${isFlipped ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-10 pointer-events-none'}`}>
                        <button 
                            onClick={(e) => {
                                e.stopPropagation(); // Prevent re-triggering flip
                                handleAckAndNext();
                            }}
                            className="w-full bg-white hover:bg-slate-200 text-slate-950 py-5 rounded-[1.5rem] font-display font-bold text-lg shadow-[0_0_30px_rgba(255,255,255,0.1)] active:scale-95 transition-all flex items-center justify-center gap-3"
                        >
                            <i className="fa-solid fa-check-circle text-lg"></i>
                            {isOnline ? "CONTINUE" : (isLastPlayer ? "REVEAL TURN ORDER" : "NEXT PLAYER")}
                        </button>
                        
                        {isOnline && word !== "IMPOSTER" && (
                            <div className="w-full max-w-sm mt-3">
                                <button
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        onConfused();
                                    }}
                                    className="w-full text-white/50 hover:text-white hover:bg-white/5 font-bold text-sm py-3 rounded-xl transition-all"
                                >
                                    I don't recognize this word
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );

            return (
                <div className="h-[100dvh] relative overflow-hidden">
                    <div className="absolute inset-0 pointer-events-none">
                         <div className="blob bg-brand-600 top-[-10%] left-[-10%] w-[50%] h-[50%]"></div>
                         <div className="blob bg-cyan-600 bottom-[-10%] right-[-10%] w-[50%] h-[50%] animation-delay-2000"></div>
                    </div>
                    <div className="relative z-10 h-full">
                        {step === 'handover' ? renderHandover() : renderFlipCard()}
                    </div>
                </div>
            );
        };

        // 3. Turn Order Screen with Countdown
        const TurnOrderScreen = ({ players, onStartMission, audioManager, isHost }) => {
            const [countdown, setCountdown] = useState(10);

            useEffect(() => {
                if (audioManager) {
                    audioManager.playSound('turnOrderReveal');
                }
                return () => {
                    if (audioManager) {
                        audioManager.stopSound('turnOrderReveal');
                    }
                };
            }, [audioManager]);

            useEffect(() => {
                const timer = setInterval(() => {
                    setCountdown(prev => {
                        if (prev <= 1) {
                            clearInterval(timer);
                            if (isHost) {
                                onStartMission();
                            }
                            return 0;
                        }
                        return prev - 1;
                    });
                }, 1000);
                return () => clearInterval(timer);
            }, [isHost, onStartMission]);
            
            return (
                <div className="h-[100dvh] flex flex-col items-center p-6 text-center relative overflow-hidden animate-fadeIn">
                     <div className="absolute inset-0 pointer-events-none">
                         <div className="blob bg-teal-600/30 top-[-20%] left-[-20%] w-[60%] h-[60%]"></div>
                         <div className="blob bg-sky-600/30 bottom-[-20%] right-[-20%] w-[60%] h-[60%] animation-delay-2000"></div>
                    </div>

                    {/* Header */}
                    <div className="w-full max-w-sm pt-12">
                        <h1 className="text-4xl font-display font-bold text-white mb-4">Turn Order Established</h1>
                        <p className="text-white/60 mb-8 max-w-xs mx-auto">The mission will proceed in the following randomly assigned sequence.</p>
                    </div>
                    
                    {/* Scrollable List */}
                    <div className="flex-1 w-full max-w-sm my-4 flex flex-col min-h-0">
                        <div className="w-full glass-panel rounded-2xl p-6 overflow-y-auto no-scrollbar">
                            <div className="space-y-4">
                                {players.map((player, index) => (
                                    <div key={index} className="flex items-center gap-3 animate-slide-up" style={{ animationDelay: `${index * 100}ms` }}>
                                        <div className="flex-shrink-0 w-8 h-8 flex items-center justify-center bg-sky-900/50 text-sky-400 font-mono font-bold text-sm rounded-lg border border-sky-400/20">{index + 1}</div>
                                        <PlayerAvatar name={player.name} className="w-6 h-6 rounded-full" />
                                        <div className="text-left font-display font-semibold text-lg text-white/90 truncate">{player.name}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Footer */}
                    <div className="w-full max-w-sm pb-8">
                        <div
                            className="w-full bg-white text-slate-950 font-display font-bold text-lg py-5 rounded-[1.5rem] shadow-[0_0_30px_rgba(255,255,255,0.1)] transition-all flex items-center justify-center gap-3"
                        >
                            {countdown > 0 ? (
                                <span className="font-mono text-2xl tracking-widest">{countdown}</span>
                            ) : (
                                <>
                                 <i className="fa-solid fa-rocket text-sky-500"></i> BEGIN MISSION
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        };


        // 4. Game Timer Screen
        const GameTimerScreen = ({ lobbyData, onEndGame, firstPlayer, audioManager, isHost, lobbyId }) => {
            const [showTurnOrder, setShowTurnOrder] = useState(false);
            const { duration, missionStartTime, turnOrder } = lobbyData || {};
            const [timeLeft, setTimeLeft] = useState(duration || 0);
            const timerRef = useRef(null);

            // Force the timer music to play as soon as the screen is shown
            useEffect(() => {
                if (audioManager) {
                    audioManager.playMusic('timerMusic');
                }
            }, [audioManager]);

            useEffect(() => {
                if (!duration || !missionStartTime) {
                    return;
                }

                let timerExpired = false;
                const updateTimer = () => {
                    const getStartTime = () => {
                        if (missionStartTime.toDate) return missionStartTime.toDate().getTime(); // Firestore timestamp
                        if (missionStartTime instanceof Date) return missionStartTime.getTime(); // JS Date for local game
                        return Date.now(); // Fallback
                    };

                    const startTime = getStartTime();
                    const elapsed = (Date.now() - startTime) / 1000;
                    const newTimeLeft = Math.round(Math.max(0, duration - elapsed));
                    
                    setTimeLeft(newTimeLeft);

                    if (newTimeLeft <= 0 && !timerExpired) {
                        timerExpired = true; // Prevents multiple triggers
                        clearInterval(timerRef.current);
                        
                        audioManager.stopMusic(); 
						audioManager.playSound('alarm');
                        
                        if (navigator.vibrate) navigator.vibrate();
                        
                        // Host ends the game for everyone in online mode
                        if (isHost && lobbyId) {
                            onEndGame();
                        }
                    }
                };

                if(timerRef.current) clearInterval(timerRef.current);
                updateTimer(); 
                timerRef.current = setInterval(updateTimer, 1000);

                return () => {
					clearInterval(timerRef.current);
					audioManager.stopSound('alarm');
				};
            }, [duration, missionStartTime, isHost, onEndGame, audioManager, lobbyId]);

            const handleIdentifyImposter = () => {
                if (lobbyId && !isHost) return;
                
                if(navigator.vibrate) navigator.vibrate(50);
                
                onEndGame();
            };

            const formatTime = (seconds) => {
                const m = Math.floor(seconds / 60);
                const s = seconds % 60;
                return `${m}:${s < 10 ? '0' : ''}${s}`;
            };

            const progress = duration ? timeLeft / duration : 0;
            const strokeDasharray = 2 * Math.PI * 120;
            const strokeDashoffset = strokeDasharray * (1 - progress);
            const isActive = duration && timeLeft > 0;

            return (
                <div className="h-[100dvh] flex flex-col items-center justify-between p-6 relative overflow-hidden">
                    {showTurnOrder && <TurnOrderReviewModal players={turnOrder} onClose={() => setShowTurnOrder(false)} />}
                    <div className="absolute inset-0 pointer-events-none">
                        <div className={`absolute inset-0 bg-red-600/10 transition-opacity duration-1000 ${timeLeft < 30 && isActive ? 'opacity-100 animate-pulse' : 'opacity-0'}`}></div>
                        <div className="blob bg-brand-900/30 top-0 left-0 w-full h-full"></div>
                    </div>

                    {/* Header */}
                    <div className="w-full mt-8 glass-panel p-4 rounded-[1.5rem] flex items-center justify-between gap-4 z-10">
                        <div className="flex items-center gap-4 min-w-0">
                            <div className="bg-brand-500/20 w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0">
                                <i className="fa-solid fa-comments text-brand-300"></i>
                            </div>
                            <div className="min-w-0">
                                <p className="text-brand-300/70 text-[10px] uppercase font-bold tracking-widest mb-1">First Questioner</p>
                                <div className="flex items-center gap-3">
                                    <PlayerAvatar name={firstPlayer} className="w-6 h-6 rounded-full"/>
                                    <p className="text-white font-display font-bold text-xl tracking-wide truncate">{firstPlayer}</p>
                                </div>
                            </div>
                        </div>
                        <button 
                            onClick={() => {
                                setShowTurnOrder(true);
                                audioManager.playSound('uiClick');
                            }}
                            className="w-12 h-12 flex-shrink-0 bg-white/5 hover:bg-white/10 rounded-full flex items-center justify-center text-white/60 hover:text-white transition-colors active:scale-90"
                            aria-label="Review turn order"
                        >
                            <i className="fa-solid fa-list-ol"></i>
                        </button>
                    </div>

                    {/* Timer */}
                    <div className="flex-1 flex flex-col items-center justify-center z-10 w-full relative">
                        {duration ? (
                            <div className="relative transform scale-90 sm:scale-100 transition-transform">
                                <div className={`absolute inset-0 rounded-full blur-[100px] transition-all duration-1000 ${timeLeft < 30 ? 'bg-red-500/20' : 'bg-brand-500/10'}`}></div>
                                <div className="relative">
                                    {/* Track */}
                                    <svg className="w-72 h-72 transform -rotate-90">
                                        <circle cx="144" cy="144" r="120" stroke="rgba(255,255,255,0.05)" strokeWidth="8" fill="transparent" />
                                        <circle 
                                            cx="144" cy="144" r="120" stroke="currentColor" strokeWidth="8" fill="transparent" 
                                            className={`${timeLeft < 30 ? 'text-red-500 shadow-[0_0_20px_rgba(239,68,68,0.5)]' : 'text-brand-500 shadow-[0_0_20px_rgba(139,92,246,0.5)]'} transition-all duration-1000 drop-shadow-xl`}
                                            strokeDasharray={strokeDasharray}
                                            strokeDashoffset={strokeDashoffset}
                                            strokeLinecap="round"
                                        />
                                    </svg>
                                    <div className="absolute inset-0 flex flex-col items-center justify-center">
                                        <span className={`text-7xl font-mono font-bold tracking-tighter tabular-nums ${timeLeft < 30 && isActive ? 'text-red-500 animate-pulse' : 'text-white'}`}>
                                            {formatTime(timeLeft)}
                                        </span>
                                        <span className="text-white/30 text-[10px] font-bold uppercase tracking-[0.4em] mt-4 ml-1">
                                            {timeLeft === 0 ? "TIME'S UP" : "REMAINING"}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="text-center py-16 px-8 glass-panel rounded-[2.5rem] border border-white/5">
                                <div className="w-24 h-24 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-8 ring-1 ring-white/10">
                                    <i className="fa-solid fa-infinity text-white/50 text-4xl"></i>
                                </div>
                                <h2 className="text-3xl font-display font-bold mb-4 text-white">Untimed Mode</h2>
                                <p className="text-white/40 text-sm font-medium leading-relaxed max-w-xs mx-auto">
                                    Analyze behavior. Watch for nervous ticks. Take your time to find the spy.
                                </p>
                            </div>
                        )}
                    </div>

                    {/* Action */}
                    <div className="w-full z-10 pb-[env(safe-area-inset-bottom)] mb-6">
                        <button 
                            onClick={handleIdentifyImposter}
                            disabled={lobbyId && !isHost}
                            className="w-full bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-500 hover:to-orange-500 text-white font-display font-bold text-lg py-5 rounded-[1.5rem] shadow-[0_0_40px_rgba(220,38,38,0.4)] hover:shadow-[0_0_55px_rgba(234,88,12,0.5)] transition-all duration-300 ease-out active:scale-[0.98] hover:scale-[1.01] flex items-center justify-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <i className="fa-solid fa-user-secret text-xl"></i>
                            {duration && timeLeft === 0 && !lobbyId ? 'REVEAL IMPOSTER' : 'IDENTIFY IMPOSTER'}
                        </button>
                    </div>
                </div>
            );
        };
        
        // 5. Voting Screen
        const VotingScreen = ({ lobbyData, lobbyPlayers, user, lobbyId, audioManager }) => {
            const me = lobbyPlayers.find(p => p.id === user.uid);
            const [selectedVotes, setSelectedVotes] = useState([]);
            const numImposters = lobbyData.imposterIds?.length || lobbyData.fakeWordPlayerIds?.length || 1;
            const isFakeWordMode = lobbyData.isFakeWordMode;

            const handleSelectPlayer = (targetPlayerId) => {
                audioManager.playSound('uiClick');
                setSelectedVotes(prev => {
                    if (prev.includes(targetPlayerId)) {
                        return prev.filter(id => id !== targetPlayerId);
                    }
                    if (prev.length < numImposters) {
                        return [...prev, targetPlayerId];
                    }
                    // If already at max votes, replace the last selection
                    return [...prev.slice(0, prev.length - 1), targetPlayerId];
                });
            };

            const handleConfirmVote = () => {
                if (selectedVotes.length === numImposters) {
                    audioManager.playSound('uiClick');
                    db.collection('lobbies').doc(lobbyId).collection('players').doc(user.uid).update({
                        votedFor: selectedVotes
                    });
                }
            };
            
            const VotedForName = ({ playerId }) => {
                const player = lobbyPlayers.find(p => p.id === playerId);
                if (!player) return <span className="flex-1 text-right font-bold text-white truncate">Unknown</span>;

                return (
                    <div className="flex items-center justify-end gap-2">
                        <span className="flex-1 text-right font-bold text-white truncate">{player.name}</span>
                        <PlayerAvatar name={player.name} className="w-5 h-5 rounded-full" />
                    </div>
                );
            };
            
            const renderVotingRecord = (player) => {
                if (!player.votedFor || !Array.isArray(player.votedFor) || player.votedFor.length === 0) {
                     return <i className="fa-solid fa-ellipsis text-white/40"></i>;
                }
                return <i className="fa-solid fa-check text-green-400 animate-fadeIn"></i>;
            }

            return (
                <div className="h-[100dvh] flex flex-col items-center justify-start pt-16 p-6 text-center overflow-y-auto no-scrollbar relative animate-fadeIn">
                     <div className="absolute inset-0 pointer-events-none">
                        <div className="blob bg-red-600/20 top-0 left-0 w-full h-full"></div>
                    </div>
                    
                    <div className="relative z-10 w-full max-w-sm">
                        <div className="w-24 h-24 rounded-full flex items-center justify-center mb-8 relative mx-auto">
                            <div className="absolute inset-0 bg-red-500/20 blur-2xl rounded-full animate-pulse-slow"></div>
                            <div className="glass-panel w-full h-full rounded-full flex items-center justify-center border border-white/10">
                               <i className={`fa-solid ${isFakeWordMode ? 'fa-question' : 'fa-user-secret'} text-red-400 text-4xl`}></i>
                            </div>
                        </div>
                        <h1 className="text-4xl font-display font-bold text-white mb-4">{isFakeWordMode ? 'Who Has the Fake Word?' : 'Who is the Imposter?'}</h1>
                        <p className="text-white/60 mb-10">{numImposters > 1 ? `Select the ${numImposters} agents you believe are suspicious.` : "Cast your vote. The agent with the most votes will be revealed."}</p>

                        {me?.votedFor && me.votedFor.length > 0 ? (
                             <div className="w-full max-w-sm">
                                <div className="glass-panel p-8 rounded-2xl mb-6 text-center">
                                    <i className="fa-solid fa-check-circle text-green-400 text-4xl mb-4"></i>
                                    <h3 className="text-xl font-bold text-white mb-2">Vote Cast!</h3>
                                    <p className="text-white/50 text-sm mb-4">You voted for:</p>
                                    <div className="flex flex-col gap-2 items-center">
                                        {me.votedFor.map(voteId => <VotedForName key={voteId} playerId={voteId} />)}
                                    </div>
                                    <hr className="border-white/10 my-4" />
                                    <p className="text-white/50 text-sm">Waiting for other agents to vote.</p>
                                </div>
                                <div className="glass-panel p-6 rounded-2xl">
                                    <h4 className="text-sm font-bold tracking-widest text-brand-400 mb-4 uppercase">Voting Status</h4>
                                    <div className="space-y-3">
                                        {lobbyPlayers.map(player => (
                                            <div key={player.id} className="flex items-center justify-between bg-white/5 px-4 py-3 rounded-lg">
                                                <div className="flex items-center gap-3 truncate">
                                                    <PlayerAvatar name={player.name} className="w-6 h-6 rounded-full"/>
                                                    <span className="font-semibold text-white/90 truncate">{player.name}</span>
                                                </div>
                                                {renderVotingRecord(player)}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <>
                                <div className="w-full flex flex-col gap-3">
                                    {lobbyPlayers.filter(p => p.id !== user.uid).map(player => (
                                        <button 
                                            key={player.id} 
                                            onClick={() => handleSelectPlayer(player.id)}
                                            className={`w-full text-left p-4 rounded-xl transition-all flex items-center gap-4 active:scale-95 border ${selectedVotes.includes(player.id) ? 'bg-brand-500/20 border-brand-400' : 'bg-white/5 hover:bg-white/10 border-transparent'}`}
                                        >
                                            <div className={`w-6 h-6 rounded-full flex items-center justify-center border-2 ${selectedVotes.includes(player.id) ? 'bg-brand-500 border-brand-400' : 'border-white/20'}`}>
                                                {selectedVotes.includes(player.id) && <i className="fa-solid fa-check text-xs text-white"></i>}
                                            </div>
                                            <PlayerAvatar name={player.name} className="w-8 h-8 rounded-full" />
                                            <span className="font-bold text-lg">{player.name}</span>
                                        </button>
                                    ))}
                                </div>
                                <button
                                    onClick={handleConfirmVote}
                                    disabled={selectedVotes.length !== numImposters}
                                    className="w-full mt-6 bg-red-600 text-white font-display font-bold text-lg py-4 rounded-xl shadow-[0_0_20px_rgba(220,38,38,0.3)] transition-all active:scale-95 disabled:opacity-50 disabled:shadow-none"
                                >
                                    Confirm Vote ({selectedVotes.length}/{numImposters})
                                </button>
                            </>
                        )}
                    </div>
                </div>
            )
        };

		// 6. Results Screen
        const ResultScreen = ({ lobbyData, lobbyPlayers, onRestart, onBackToHome, onConfirmExit, audioManager, isHost, isLocal }) => {
            const { gameResult, imposterIds, imposterIndices, fakeWordPlayerIds, fakeWordPlayerIndices, secretWord, fakeWord, turnOrder, players } = lobbyData;
            const isFakeWordMode = lobbyData.isFakeWordMode;
            
            const roguePlayerIds = isFakeWordMode ? fakeWordPlayerIds : imposterIds;
            const roguePlayerIndices = isFakeWordMode ? fakeWordPlayerIndices : imposterIndices;

            const roguePlayers = isLocal
                ? roguePlayerIndices.map(i => players[i])
                : lobbyPlayers.filter(p => roguePlayerIds?.includes(p.id));

            const roguePlayerNames = roguePlayers.map(p => p?.name || "Unknown").join(' & ');

            // New logic to check if all players are present for a rematch
            const originalPlayerCount = turnOrder?.length || 0;
            const currentPlayerCount = lobbyPlayers.length;
            const notAllPlayersPresent = !isLocal && originalPlayerCount > 0 && originalPlayerCount !== currentPlayerCount;

            const soundPlayedRef = useRef(false);

            useEffect(() => {
                if (soundPlayedRef.current) return;

                let soundToPlay = null;
                if (isLocal) {
                    soundToPlay = audioManager.getSound('imposterWin'); // Same sound for local reveal
                } else if (gameResult?.winner === 'imposter' || gameResult?.winner === 'fakeWordPlayer') {
                    soundToPlay = audioManager.getSound('imposterWin');
                } else if (gameResult?.winner === 'agents') {
                    soundToPlay = audioManager.getSound('agentWin');
                }

                if (soundToPlay) {
                    soundPlayedRef.current = true;
                    soundToPlay.currentTime = 0;
                    soundToPlay.play().catch(e => console.error("Result music failed to play:", e));
                }
                
                return () => {
                    if (soundToPlay) {
                        soundToPlay.pause();
                        soundToPlay.currentTime = 0;
                    }
                };
            }, [audioManager, gameResult, isLocal]);


            const renderResultContent = () => {
                if (!gameResult) {
                    return <p>Calculating results...</p>;
                }

                const title = isFakeWordMode ? `The Player with the Fake Word Was...` : (roguePlayers.length > 1 ? `The Imposters Were...` : `The Imposter Was...`);

                if (isLocal) {
                    return (
                        <>
                            <div className="w-28 h-28 bg-gradient-to-br from-red-500/20 to-transparent rounded-full flex items-center justify-center mx-auto mb-8 ring-1 ring-red-500/40 shadow-[0_0_40px_rgba(239,68,68,0.2)] overflow-hidden">
                                <img src="https://em-content.zobj.net/source/microsoft-teams/337/ninja_medium-light-skin-tone_1f977-1f3fc_1f3fc.png" alt="Ninja" draggable="false" className="w-30 h-30 drop-shadow-lg relative top-3" />
                            </div>
                            <h2 className="text-3xl font-display font-bold text-white mb-2">{title}</h2>
                            <p className="text-4xl font-black text-red-400 tracking-tight drop-shadow-sm">{roguePlayerNames}</p>
                        </>
                    );
                }
                
                if (gameResult.winner === 'imposter' || gameResult.winner === 'fakeWordPlayer') {
                    const winnerName = isFakeWordMode ? "FAKE WORD PLAYER WINS" : "IMPOSTER WINS";
                    return (
                        <>
                         <div className="w-28 h-28 bg-gradient-to-br from-red-500/20 to-transparent rounded-full flex items-center justify-center mx-auto mb-8 ring-1 ring-red-500/40 shadow-[0_0_40px_rgba(239,68,68,0.2)] overflow-hidden">
                            <img src="https://em-content.zobj.net/source/microsoft-teams/337/ninja_medium-light-skin-tone_1f977-1f3fc_1f3fc.png" alt="Ninja" draggable="false" className="w-30 h-30 drop-shadow-lg relative top-3" />
                        </div>
                        <h2 className="text-3xl font-display font-bold text-red-400 mb-2">{winnerName}</h2>
                        <p className="text-white/60 mb-6 max-w-xs mx-auto">
                            {gameResult.reason === 'tie'
                                ? "The agents couldn't agree on a suspect, allowing the rogue agent to escape!"
                                : `The agents incorrectly accused ${gameResult.accusedName}, allowing the real rogue agent to win!`}
                        </p>
                        <p className="text-white">{title.replace('...', '')} <span className="font-bold text-red-400">{roguePlayerNames}</span></p>
                        </>
                    );
                } else { // Agents win
                     return (
                        <>
                         <div className="w-28 h-28 bg-gradient-to-br from-teal-500/20 to-transparent rounded-full flex items-center justify-center mx-auto mb-8 ring-1 ring-teal-500/40 shadow-[0_0_40px_rgba(20,184,166,0.1)] overflow-hidden">
                            <img src="https://em-content.zobj.net/source/microsoft-teams/363/detective_light-skin-tone_1f575-1f3fb_1f3fb.png" alt="Detective" draggable="false" className="w-35 h-35 drop-shadow-lg relative top-3" />
                        </div>
                        <h2 className="text-3xl font-display font-bold text-teal-400 mb-2">AGENTS WIN</h2>
                        <p className="text-white/60 mb-6 max-w-xs mx-auto">
                           The agents successfully identified a rogue element!
                        </p>
                        <p className="text-white">{title.replace('...', '')} <span className="font-bold text-teal-400">{roguePlayerNames}</span></p>
                        </>
                    );
                }
            };

            return (
                <div className="h-[100dvh] flex flex-col items-center p-6 text-center overflow-y-auto no-scrollbar">
                    <div className="absolute inset-0 pointer-events-none">
                        <div className={`blob ${ (gameResult?.winner !== 'agents' && !isLocal) || isLocal ? 'bg-red-600/20' : 'bg-teal-600/20'} top-0 left-0 w-full h-full`}></div>
                    </div>
                    
                    <div className="relative my-8 animate-float w-full max-w-sm z-10">
                        <div className={`absolute inset-0 ${ (gameResult?.winner !== 'agents' && !isLocal) || isLocal ? 'bg-red-500' : 'bg-teal-500'} rounded-[2.5rem] blur-[50px] opacity-20`}></div>
                        <div className={`relative glass-panel p-10 rounded-[2.5rem] border ${ (gameResult?.winner !== 'agents' && !isLocal) || isLocal ? 'border-red-500/30' : 'border-teal-500/30'}`}>
                           {renderResultContent()}
                        </div>
                    </div>

                    <div className="glass-panel p-6 rounded-[2rem] w-full max-w-sm mb-8 border border-white/5 z-10">
                        <p className="text-slate-500 text-[10px] uppercase tracking-widest font-bold mb-3">{isFakeWordMode ? 'The Real Word' : 'The Secret Word'}</p>
                        <p className="text-3xl font-display font-bold text-teal-400 tracking-wide">{secretWord}</p>
                         {isFakeWordMode && fakeWord && (
                            <>
                                <div className="h-px bg-white/10 my-4"></div>
                                <p className="text-slate-500 text-[10px] uppercase tracking-widest font-bold mb-3">The Fake Word</p>
                                <p className="text-3xl font-display font-bold text-yellow-400 tracking-wide">{fakeWord}</p>
                            </>
                         )}
                    </div>

                    {!isLocal && lobbyData.votingRecord && (
                        <div className="glass-panel p-6 rounded-[2rem] w-full max-w-sm mb-8 border border-white/5 z-10 animate-fadeIn">
                            <h3 className="text-sm font-bold tracking-widest text-brand-400 mb-4 uppercase">Voting Record</h3>
                            <div className="space-y-2 text-left">
                                {lobbyData.votingRecord.map((record, index) => (
                                    <div key={index} className="flex items-center text-sm bg-white/5 px-3 py-2 rounded-lg">
                                        <div className="flex-1 flex items-center gap-2 min-w-0">
                                            <PlayerAvatar name={record.voterName} className="w-5 h-5 rounded-full" />
                                            <span className="font-semibold text-white/80 truncate">{record.voterName}</span>
                                        </div>
                                        <i className="fa-solid fa-arrow-right text-white/30 mx-2 flex-shrink-0"></i>
                                        <div className="flex-1 flex items-center justify-end gap-2 min-w-0">
                                            <span className="font-bold text-white truncate">{record.votedForName}</span>
                                            {record.votedForName !== 'No Vote' && <PlayerAvatar name={record.votedForName} className="w-5 h-5 rounded-full" />}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                    
                    <div className="w-full max-w-sm z-10 flex flex-col gap-3 pb-[env(safe-area-inset-bottom)] mb-8">
                         {isHost ? (
                            <button 
                                onClick={() => {
                                    if(navigator.vibrate) navigator.vibrate(20);
                                    onRestart();
                                }}
                                disabled={notAllPlayersPresent}
                                className="w-full bg-white text-slate-950 py-5 rounded-[1.5rem] font-display font-bold text-lg shadow-[0_0_30px_rgba(255,255,255,0.15)] active:scale-95 transition-all flex items-center justify-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none"
                            >
                                <i className="fa-solid fa-rotate-right text-lg"></i>
                                {notAllPlayersPresent ? 'WAITING FOR PLAYERS' : 'PLAY AGAIN'}
                            </button>
                        ) : (
                             <button
                                disabled={true}
                                className="w-full bg-white text-slate-950 py-5 rounded-[1.5rem] font-display font-bold text-lg opacity-50 cursor-not-allowed flex items-center justify-center gap-3"
                            >
                                <i className="fa-solid fa-hourglass-half text-lg"></i>
                                WAITING FOR HOST
                            </button>
                        )}
                        <button 
                            onClick={isHost ? onBackToHome : onConfirmExit}
                            className="w-full bg-white/5 hover:bg-white/10 text-white/70 py-4 rounded-[1.5rem] font-display font-bold text-base active:scale-95 transition-all flex items-center justify-center gap-3"
                        >
                            <i className="fa-solid fa-house text-sm"></i> BACK TO HOME
                        </button>
                    </div>
                </div>
            );
        };
        
        // --- HELPER FUNCTIONS ---
        const generateRandomString = (length, chars) => {
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        };

        const generateLobbyId = () => generateRandomString(6, 'ABCDEFGHIJKLMNPQRSTUVWXYZ123456789');
        const generateLobbyPassword = () => generateRandomString(4, 'ABCDEFGHIJKLMNPQRSTUVWXYZ123456789');
		
		// --- MODIFIED: Asset Preloading with Progress Callback ---
        const preloadAssets = (onProgress) => {
            // --- Image Preloading ---
            const imageUrls = [
                // General UI & Components
                'https://em-content.zobj.net/source/microsoft-teams/400/disguised-face_1f978.png',
                'https://em-content.zobj.net/source/microsoft-teams/363/detective_light-skin-tone_1f575-1f3fb_1f3fb.png',
                'https://em-content.zobj.net/source/microsoft-teams/337/locked_1f512.png',
                'https://em-content.zobj.net/source/microsoft-teams/337/shushing-face_1f92b.png',
                'https://em-content.zobj.net/source/microsoft-teams/337/clipboard_1f4cb.png',
                'https://em-content.zobj.net/source/microsoft-teams/337/ninja_medium-light-skin-tone_1f977-1f3fc_1f3fc.png',
                'https://em-content.zobj.net/source/microsoft-teams/337/three-oclock_1f552.png',
                'https://www.clashchamps.com/wp-content/uploads/2024/06/czJOx2-Q.png',
                'https://static0.srcdn.com/wordpress/wp-content/uploads/2021/4/Three-new-Clash-of-Clans-games-announced.jpg',
            ];

            Object.values(CATEGORY_ICONS).forEach(icon => {
                if (Array.isArray(icon)) { imageUrls.push(...icon); } 
                else { imageUrls.push(icon); }
            });

            const uniqueImageUrls = [...new Set(imageUrls)];
            const imagePromises = uniqueImageUrls.map(src => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.src = src;
                    const assetLoaded = () => {
                        if (onProgress) onProgress();
                        resolve();
                    };
                    img.onload = assetLoaded;
                    img.onerror = assetLoaded; // Resolve even on error to not block loading
                });
            });

            // --- Audio Preloading ---
            const allAudioUrls = [];
            Object.values(AUDIO_URLS).forEach(value => {
                if (typeof value === 'string') {
                    allAudioUrls.push(value);
                } else if (typeof value === 'object') {
                    Object.values(value).forEach(nestedUrl => allAudioUrls.push(nestedUrl));
                }
            });
            
            const uniqueAudioUrls = [...new Set(allAudioUrls)];
            const audioPromises = uniqueAudioUrls.map(src => {
                return new Promise((resolve) => {
                    const audio = new Audio();
                    const assetLoaded = () => {
                        if (onProgress) onProgress();
                        resolve();
                    };
                    audio.addEventListener('canplaythrough', assetLoaded, { once: true });
                    audio.addEventListener('error', assetLoaded, { once: true });
                    audio.src = src;
                    audio.load();
                });
            });
            
            // Combine all promises and return the total count
            const allPromises = [...imagePromises, ...audioPromises];
            return {
                assetPromise: Promise.all(allPromises),
                count: allPromises.length
            };
        };


        // --- MAIN APP ---
        const App = () => {
            // Core App State
            const [isLoading, setIsLoading] = useState(true);
            const [appReady, setAppReady] = useState(false); // New state for preloading
            const [user, setUser] = useState(null);
            const [gameMode, setGameMode] = useState('select'); // 'select', 'local', 'online'
            const [showHowToPlay, setShowHowToPlay] = useState(false); // New state for "How to Play" modal
            const [initialLobbyParams, setInitialLobbyParams] = useState(null);

            // Local Game State
            const [localGameState, setLocalGameState] = useState('setup'); 
            const [localGameData, setLocalGameData] = useState({
                players: [],
                imposterIndices: [],
                fakeWordPlayerIndices: [],
                secretWord: '',
                fakeWord: '',
                isFakeWordMode: false,
                duration: null,
                firstPlayer: '',
                category: '',
                speakCategory: false,
                turnOrder: [],
            });
            const [localCurrentPlayerIndex, setLocalCurrentPlayerIndex] = useState(0);

            // Online Game State
            const [lobbyId, setLobbyId] = useState(null);
            const [lobbyData, setLobbyData] = useState(null);
            const [lobbyPlayers, setLobbyPlayers] = useState([]);
            const lobbyListenerUnsubscribe = useRef(null);
            const playersListenerUnsubscribe = useRef(null);
            const [showRemovedModal, setShowRemovedModal] = useState(false);
            const [lobbyClosedInfo, setLobbyClosedInfo] = useState(null);
            const [showExitConfirmModal, setShowExitConfirmModal] = useState(false);
            
            // Notification States
            const [restartNotification, setRestartNotification] = useState(null);
            const [showImposterVoteNotification, setShowImposterVoteNotification] = useState(false);
            const lastSeenRestartTimestampRef = useRef(0);

            // Audio Manager, Mute State & Sync State
            const audioManagerRef = useRef(null);
            const [isMuted, setIsMuted] = useState(() => {
                try {
                    const savedMuteState = localStorage.getItem('imposter_isMuted');
                    return savedMuteState !== null ? JSON.parse(savedMuteState) : false;
                } catch {
                    return false;
                }
            });
            const lastPlayedEventTimestamp = useRef(0);
            
            // --- Refs to hold the latest state for use in Firestore listeners ---
            const latestLobbyData = useRef(lobbyData);
            const latestLobbyPlayers = useRef(lobbyPlayers);
            const previousGameStateRef = useRef();
            const previousPlayersRef = useRef(lobbyPlayers);
            
            // --- Effects ---

            // Keep refs updated with the latest state
            useEffect(() => {
                latestLobbyData.current = lobbyData;
            }, [lobbyData]);

            useEffect(() => {
                latestLobbyPlayers.current = lobbyPlayers;
            }, [lobbyPlayers]);
            
            // Initialize Audio Manager
            useEffect(() => {
                if (audioManagerRef.current) return;
                
                const musicTracks = ['mainMenuMusic', 'categorySelectionMusic', 'timerMusic'];
                const sfxTracks = Object.keys(AUDIO_URLS).filter(k => k !== 'categories' && !musicTracks.includes(k));

                const manager = {
                    sounds: {},
                    music: {},
                    isMuted: isMuted,
                    isUnlocked: false,
                    currentMusicTrack: null,
                    
                    unlockAudio: function() { this.isUnlocked = true; },

                    initSound: function(name, url, options = {}) {
                        const audio = new Audio(url);
                        audio.loop = options.loop || false;
                        audio.volume = options.volume || 1.0;
                        audio.preload = 'auto';
                        
                        if (options.isMusic) {
                            this.music[name] = audio;
                        } else {
                            this.sounds[name] = audio;
                        }
                    },
                    playSound: function(name, category = null) {
                        if (!this.isUnlocked) return;
                        let sound = this.sounds[name];
                        if (name === 'category' && category && this.sounds.categories[category]) {
                            sound = this.sounds.categories[category];
                        }
                        if (sound) {
                            sound.currentTime = 0;
                            const playPromise = sound.play();
                            if (playPromise !== undefined) {
                                playPromise.catch(error => { /* Autoplay was prevented */ });
                            }
                        }
                    },
                    getSound: function(name) { return this.sounds[name]; },
					stopSound: function(name) {
                        if (!this.isUnlocked) return;
						const sound = this.sounds[name];
						if (sound) {
							sound.pause();
							sound.currentTime = 0;
						}
					},
                    
                    playMusic: function(name) {
                        if (!this.isUnlocked) return;
                        if (this.currentMusicTrack === name && !this.music[name].paused) return;

                        this.stopMusic();
                        const track = this.music[name];
                        if (track) {
                            this.currentMusicTrack = name;
                            track.muted = this.isMuted;
                            const playPromise = track.play();
                            if (playPromise) playPromise.catch(()=>{});
                        }
                    },
                    stopMusic: function() {
                        if (this.currentMusicTrack && this.music[this.currentMusicTrack]) {
                            const track = this.music[this.currentMusicTrack];
                            track.pause();
                            track.currentTime = 0;
                        }
                        this.currentMusicTrack = null;
                    },
                    setMuted: function(muted) {
                        this.isMuted = muted;
                        Object.values(this.music).forEach(track => track.muted = muted);
                    },
                    pauseAllMusic: function() {
                        if (this.currentMusicTrack && this.music[this.currentMusicTrack]) {
                            this.music[this.currentMusicTrack].pause();
                        }
                    },
                    resumeAllMusic: function() {
                        if (!this.isUnlocked) return;
                        if (this.currentMusicTrack && this.music[this.currentMusicTrack]) {
                            this.music[this.currentMusicTrack].play().catch(()=>{});
                        }
                    }
                };
                
                // Initialize SFX
                sfxTracks.forEach(key => manager.initSound(key, AUDIO_URLS[key]));

                // Initialize Music
                manager.initSound('mainMenuMusic', AUDIO_URLS.mainMenuMusic, { loop: true, isMusic: true });
                manager.initSound('categorySelectionMusic', AUDIO_URLS.categorySelectionMusic, { loop: true, isMusic: true, volume: 0.7 });
                manager.initSound('timerMusic', AUDIO_URLS.timerMusic, { loop: true, isMusic: true, volume: 0.5 });
                manager.initSound('turnOrderReveal', AUDIO_URLS.turnOrderReveal, { volume: 0.6 });
                
                // Initialize Voiceovers
                manager.sounds.categories = {};
                for (const cat in AUDIO_URLS.categories) { 
                    const audio = new Audio(AUDIO_URLS.categories[cat]);
                    audio.preload = 'auto';
                    manager.sounds.categories[cat] = audio;
                }
                
                audioManagerRef.current = manager;
            }, []);
			
			useEffect(() => {
                if (audioManagerRef.current) {
                    audioManagerRef.current.setMuted(isMuted);
                }
            }, [isMuted]);

            // Auth, and URL Param Handling
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const lobbyIdParam = params.get('lobbyId');
                const passwordParam = params.get('password');
                if (lobbyIdParam) {
                    setInitialLobbyParams({ lobbyId: lobbyIdParam, password: passwordParam || '' });
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
                
                const authUnsubscribe = auth.onAuthStateChanged(firebaseUser => {
                    if (firebaseUser) {
                        setUser(firebaseUser);
                    } else {
                        auth.signInAnonymously().catch(error => console.error("Anonymous sign-in failed:", error));
                    }
                });

                const disableImageContextMenu = (e) => {
                    if (e.target.tagName === 'IMG') e.preventDefault();
                };
                document.addEventListener('contextmenu', disableImageContextMenu);

                return () => {
                    authUnsubscribe();
                    document.removeEventListener('contextmenu', disableImageContextMenu);
                };
            }, []);

            // Background Music Manager
            useEffect(() => {
                if (isLoading || !audioManagerRef.current || !audioManagerRef.current.isUnlocked) return;
                
                let targetMusic = null;

                if (gameMode === 'select' || (gameMode === 'online' && !lobbyId)) {
                    targetMusic = 'mainMenuMusic';
                } else if ((gameMode === 'online' && lobbyId && lobbyData?.gameState === 'waiting') || (gameMode === 'local' && localGameState === 'setup')) {
					targetMusic = 'categorySelectionMusic';
				} else if ((gameMode === 'local' && localGameState === 'active') || (gameMode === 'online' && lobbyData?.gameState === 'active')) {
                    targetMusic = 'timerMusic';
                }

                if (targetMusic) {
                    audioManagerRef.current.playMusic(targetMusic);
                } else {
                    audioManagerRef.current.stopMusic();
                }

            }, [isLoading, gameMode, localGameState, lobbyId, lobbyData?.gameState, audioManagerRef.current?.isUnlocked]);
            
            // Handle Browser Tab Visibility
            useEffect(() => {
                const handleVisibilityChange = () => {
                    if (document.hidden) {
                        audioManagerRef.current?.pauseAllMusic();
                    } else {
                        audioManagerRef.current?.resumeAllMusic();
                    }
                };
                document.addEventListener("visibilitychange", handleVisibilityChange);
                return () => document.removeEventListener("visibilitychange", handleVisibilityChange);
            }, []);
			
            const handleMuteToggle = () => {
                const newMutedState = !isMuted;
                setIsMuted(newMutedState);
                try {
                    localStorage.setItem('imposter_isMuted', JSON.stringify(newMutedState));
                } catch (error) {
                    console.error("Could not save mute state to local storage:", error);
                }
            };

            // Firestore Listeners & Game Logic for Online Mode
            useEffect(() => {
                if (gameMode !== 'online' || !lobbyId || !user) {
                    if (lobbyListenerUnsubscribe.current) lobbyListenerUnsubscribe.current();
                    if (playersListenerUnsubscribe.current) playersListenerUnsubscribe.current();
                    return;
                }
                
                const lobbyRef = db.collection('lobbies').doc(lobbyId);
                
                lobbyListenerUnsubscribe.current = lobbyRef.onSnapshot(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        const previousData = latestLobbyData.current;
                        setLobbyData(data);
                        
                        // --- Sound logic based on state changes ---
                        if (previousData && data.gameState !== previousData.gameState) {
                            if (previousData.gameState === 'waiting' && data.gameState === 'reveal') {
                                audioManagerRef.current.playSound(data.isRandomMode ? 'startRandomMission' : 'startMission');
                            }
                            if (previousData.gameState === 'result' && data.gameState === 'waiting') {
                                audioManagerRef.current.playSound('playAgain');
                            }
                        }
                        
                        if (data.lastRestartReason && data.lastRestartReason.timestamp > lastSeenRestartTimestampRef.current) {
							setRestartNotification(data.lastRestartReason.word);
							lastSeenRestartTimestampRef.current = data.lastRestartReason.timestamp;
						}
                        
                        if (data.lastSoundEvent && data.lastSoundEvent.timestamp > lastPlayedEventTimestamp.current) {
                            const soundName = data.lastSoundEvent.name;
                            audioManagerRef.current.playSound(soundName, data.lastSoundEvent.category || null);
                            lastPlayedEventTimestamp.current = data.lastSoundEvent.timestamp;
                        }
                    } else {
                        const wasIHost = latestLobbyData.current?.hostId === user.uid;
                        if (!wasIHost && lobbyId) {
                            const host = latestLobbyPlayers.current.find(p => p.id === latestLobbyData.current?.hostId);
                            setLobbyClosedInfo({ hostName: host ? host.name : 'The host' });
                        }
                        handleBackToHome(true);
                    }
                });

                const playersRef = lobbyRef.collection('players').orderBy('createdAt');
                playersListenerUnsubscribe.current = playersRef.onSnapshot(snapshot => {
                    const newPlayers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const currentLobbyDoc = latestLobbyData.current;

                    if (newPlayers.length > 0 && latestLobbyPlayers.current.length > 0) {
                        const wasIInLobby = latestLobbyPlayers.current.some(p => p.id === user.uid);
                        const amIStillInLobby = newPlayers.some(p => p.id === user.uid);
                        if (wasIInLobby && !amIStillInLobby) setShowRemovedModal(true);
                    }

                    if (currentLobbyDoc?.notifyImposterOnVote && !currentLobbyDoc?.isFakeWordMode && currentLobbyDoc.imposterIds?.includes(user.uid)) {
                        const previouslyConfused = previousPlayersRef.current.some(p => p.status === 'confused');
                        const nowConfused = newPlayers.some(p => p.status === 'confused');
                        if (!previouslyConfused && nowConfused) {
                            setShowImposterVoteNotification(true);
                        }
                    }
                    
                    setLobbyPlayers(newPlayers);
                    previousPlayersRef.current = newPlayers;
                    
                    if (!currentLobbyDoc) return;

                    const hostIsMissing = newPlayers.length > 0 && !newPlayers.some(p => p.id === currentLobbyDoc.hostId);
                    if (hostIsMissing) {
                        const newHost = newPlayers[0];
                        if (newHost && newHost.id === user.uid) {
                            console.log(`Host left. Promoting ${newHost.name} to new host.`);
                            lobbyRef.update({ hostId: newHost.id });
                        }
                    }

                    const isHost = user.uid === currentLobbyDoc.hostId;
                    if (!isHost) return;
                    
                    if (currentLobbyDoc.gameState === 'voting') {
                        const allVoted = newPlayers.length > 0 && newPlayers.every(p => p.votedFor);
                        if (allVoted) setTimeout(() => calculateResults(currentLobbyDoc, newPlayers), 1000);
                    }
                    
                    if (currentLobbyDoc.gameState === 'reveal') {
                        const rogueIds = currentLobbyDoc.isFakeWordMode ? currentLobbyDoc.fakeWordPlayerIds : currentLobbyDoc.imposterIds;
                        if (!rogueIds) return;

                        const pollIsActive = newPlayers.some(p => p.status === 'confused');
                        if (pollIsActive) {
                            // In fake word mode, everyone is polled. In classic, imposters are excluded.
                            const agentsToPoll = currentLobbyDoc.isFakeWordMode 
                                ? newPlayers.filter(p => !p.status)
                                : newPlayers.filter(p => !rogueIds.includes(p.id) && !p.status);

                            if (agentsToPoll.length === 0) {
                                lobbyRef.get().then(doc => {
                                    if (doc.exists && doc.data().gameState === 'reveal') {
                                        calculateConfusionResult(doc.data(), newPlayers);
                                    }
                                });
                            }
                        }
                    }
                });

                return () => {
                    if (lobbyListenerUnsubscribe.current) lobbyListenerUnsubscribe.current();
                    if (playersListenerUnsubscribe.current) playersListenerUnsubscribe.current();
                };
            }, [gameMode, lobbyId, user]);
            
            useEffect(() => {
                if (lobbyData && lobbyData.gameState !== previousGameStateRef.current) {
                    if (
                        user && lobbyId &&
                        (previousGameStateRef.current === 'result' || previousGameStateRef.current === 'reveal') &&
                        lobbyData.gameState === 'waiting'
                    ) {
                        db.collection('lobbies').doc(lobbyId).collection('players').doc(user.uid).update({
                            hasSeenCard: firebase.firestore.FieldValue.delete(),
                            votedFor: firebase.firestore.FieldValue.delete(),
                            status: firebase.firestore.FieldValue.delete()
                        }).catch(err => console.error("Could not reset player state:", err));
                    }
                    previousGameStateRef.current = lobbyData.gameState;
                }
            }, [lobbyData, user, lobbyId]);


            // --- LOCAL GAME HANDLERS ---
            const startLocalGame = (players, selectedCategories, duration, isRandomMode, speakCategory, enableTwoImposters, isFakeWordMode) => {
                const shuffledPlayers = [...players].sort(() => Math.random() - 0.5);
                const useRandom = isRandomMode || (selectedCategories && selectedCategories.length === 0);
                let finalCategory;
                if (useRandom) {
                    const allActualCategories = Object.keys(WORD_BANK);
                    finalCategory = allActualCategories[Math.floor(Math.random() * allActualCategories.length)];
                } else {
                    finalCategory = selectedCategories[0]; // local mode passes an array
                }

                const words = WORD_BANK[finalCategory];
                const secretWord = words[Math.floor(Math.random() * words.length)];
                
                const numRoguePlayers = enableTwoImposters && shuffledPlayers.length >= 10 ? 2 : 1;
                const playerIndices = Array.from(Array(shuffledPlayers.length).keys());
                playerIndices.sort(() => Math.random() - 0.5);
                const roguePlayerIndices = playerIndices.slice(0, numRoguePlayers);

                let fakeWord = '';
                if(isFakeWordMode) {
                    const availableFakeWords = words.filter(w => w !== secretWord);
                    if(availableFakeWords.length > 0) {
                        fakeWord = availableFakeWords[Math.floor(Math.random() * availableFakeWords.length)];
                    } else {
                        fakeWord = secretWord; // Fallback, though unlikely with any reasonable category size
                    }
                }

                setLocalGameData({ 
                    players: shuffledPlayers,
                    imposterIndices: isFakeWordMode ? [] : roguePlayerIndices,
                    fakeWordPlayerIndices: isFakeWordMode ? roguePlayerIndices : [],
                    secretWord,
                    fakeWord,
                    isFakeWordMode,
                    duration,
                    firstPlayer: shuffledPlayers[0].name,
                    category: finalCategory,
                    speakCategory,
                    turnOrder: shuffledPlayers.map((p, i) => ({ name: p.name, id: `local_${i}` }))
                });
                setLocalCurrentPlayerIndex(0);
                setLocalGameState('pass');
            };

            const handleLocalNextPlayer = () => {
                if (localCurrentPlayerIndex < localGameData.players.length - 1) {
                    setLocalCurrentPlayerIndex(prev => prev + 1);
                } else {
                    setLocalGameState('turnOrder');
                }
            };
            const handleStartLocalActiveGame = () => {
                audioManagerRef.current.playSound('uiClick');
                 if (localGameData.speakCategory && localGameData.category) {
                    audioManagerRef.current.playSound('category', localGameData.category);
                }
                setLocalGameData(prev => ({ ...prev, missionStartTime: new Date() }));
                setLocalGameState('active');
            };

            const handleLocalEndGame = () => {
                setLocalGameData(prev => ({
                    ...prev,
                    gameResult: { winner: 'local' }
                }));
                setLocalGameState('result');
            };

            const handleLocalRestart = () => {
                audioManagerRef.current.playSound('playAgain');
                setLocalGameState('setup');
                setLocalGameData({
                    players: [], imposterIndices: [], fakeWordPlayerIndices: [], secretWord: '', fakeWord: '', isFakeWordMode: false,
                    duration: null, firstPlayer: '', category: '', speakCategory: false
                });
            };
            
            // --- ONLINE GAME HANDLERS ---
            const deleteLobby = async (lobbyIdToDelete) => {
                const lobbyRef = db.collection('lobbies').doc(lobbyIdToDelete);
                const playersRef = lobbyRef.collection('players');

                try {
                    const playersSnapshot = await playersRef.get();
                    if (!playersSnapshot.empty) {
                        const batch = db.batch();
                        playersSnapshot.docs.forEach(doc => batch.delete(doc.ref));
                        await batch.commit();
                    }
                    await lobbyRef.delete();
                } catch (error) {
                    console.error("Error deleting lobby:", error);
                }
            };
            
			const handleBackToHome = async (silent = false) => {
                if (!silent && audioManagerRef.current.isUnlocked) {
				    audioManagerRef.current.playSound('uiClick');
                }

				const currentLobbyId = lobbyId;
				const isOnlineMode = gameMode === 'online';
                const currentLobbyData = latestLobbyData.current;

				if (lobbyListenerUnsubscribe.current) lobbyListenerUnsubscribe.current();
				if (playersListenerUnsubscribe.current) playersListenerUnsubscribe.current();
				lobbyListenerUnsubscribe.current = null;
				playersListenerUnsubscribe.current = null;
				
				setGameMode('select');
				setLocalGameState('setup');
				setLobbyId(null);
				setLobbyData(null);
				setLobbyPlayers([]);
                latestLobbyData.current = null;
                previousGameStateRef.current = null;

				if (isOnlineMode && currentLobbyId && user && currentLobbyData) {
                    const isHostLeaving = user.uid === currentLobbyData.hostId;
					if (isHostLeaving) {
						await deleteLobby(currentLobbyId);
					} else {
						await db.collection('lobbies').doc(currentLobbyId).collection('players').doc(user.uid).delete().catch(() => {});
					}
				}
			};

            const handleCreateLobby = async (username) => {
                if (audioManagerRef.current) audioManagerRef.current.unlockAudio();
                const newLobbyId = generateLobbyId();
                const newPassword = generateLobbyPassword();
                const lobbyRef = db.collection('lobbies').doc(newLobbyId);
                const expiryDate = new Date();
                expiryDate.setDate(expiryDate.getDate() + 1);
                
                await lobbyRef.set({
                    hostId: user.uid, password: newPassword, category: 'Movies',
                    isRandomMode: false, speakCategory: false, gameState: 'waiting',
                    isFakeWordMode: false,
                    enableTwoImposters: false, notifyImposterOnVote: false,
                    usedWords: [],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    expireAt: firebase.firestore.Timestamp.fromDate(expiryDate)
                });
                await lobbyRef.collection('players').doc(user.uid).set({
                    name: username, isHost: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                setLobbyId(newLobbyId);
            };

            const handleJoinLobby = async (lobbyId, password, username) => {
                if (audioManagerRef.current) audioManagerRef.current.unlockAudio();
                const lobbyRef = db.collection('lobbies').doc(lobbyId);
                const lobbyDoc = await lobbyRef.get();
                if (!lobbyDoc.exists) throw new Error('Lobby not found.');
                const data = lobbyDoc.data();
                if (data.password !== password) throw new Error('Incorrect password.');
                if (data.gameState !== 'waiting') throw new Error('Game is already in progress.');

                const playersSnapshot = await lobbyRef.collection('players').get();
                if (playersSnapshot.docs.some(doc => doc.id === user.uid)) {
                    setLobbyId(lobbyId);
                    return;
                }
                if (playersSnapshot.docs.map(doc => doc.data().name).includes(username)) throw new Error('Username is already taken.');
                
                await lobbyRef.collection('players').doc(user.uid).set({
                    name: username,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                setLobbyId(lobbyId);
            };
            
             const handleStartGameOnline = async () => {
                if (lobbyPlayers.length < 3) return;
                let finalCategory = lobbyData.isRandomMode 
                    ? Object.keys(WORD_BANK)[Math.floor(Math.random() * Object.keys(WORD_BANK).length)]
                    : lobbyData.category;

                const wordsForCategory = WORD_BANK[finalCategory] || [];
                const availableWords = wordsForCategory.filter(word => !(lobbyData.usedWords || []).includes(word));
                
                let wordPool = availableWords.length > 0 ? availableWords : wordsForCategory;
                const secretWord = wordPool[Math.floor(Math.random() * wordPool.length)];
                
                const shuffledPlayers = [...lobbyPlayers].sort(() => Math.random() - 0.5);
                const numRoguePlayers = lobbyData.enableTwoImposters && lobbyPlayers.length >= 10 ? 2 : 1;
                const roguePlayerIds = shuffledPlayers.slice(0, numRoguePlayers).map(p => p.id);

                let updatePayload = {
                    secretWord,
                    turnOrder: shuffledPlayers.map(p => ({name: p.name, id: p.id})),
                    category: finalCategory,
                    gameState: 'reveal',
                    usedWords: firebase.firestore.FieldValue.arrayUnion(secretWord),
                };

                if (lobbyData.isFakeWordMode) {
                    wordPool = wordPool.filter(w => w !== secretWord);
                    const fakeWord = wordPool.length > 0 ? wordPool[Math.floor(Math.random() * wordPool.length)] : secretWord;
                    updatePayload.fakeWord = fakeWord;
                    updatePayload.fakeWordPlayerIds = roguePlayerIds;
                    updatePayload.imposterIds = []; // Clear imposterIds
                } else {
                    updatePayload.imposterIds = roguePlayerIds;
                    updatePayload.fakeWordPlayerIds = []; // Clear fakeWordPlayerIds
                }
                
                await db.collection('lobbies').doc(lobbyId).update(updatePayload);
            };

            const handleAcknowledgeCard = () => {
                db.collection('lobbies').doc(lobbyId).collection('players').doc(user.uid).update({ hasSeenCard: true });
            };

            const handleDeclareConfusion = () => {
                db.collection('lobbies').doc(lobbyId).collection('players').doc(user.uid).update({ hasSeenCard: true, status: 'confused' });
            };

            const handleConfusionVote = (vote) => {
                db.collection('lobbies').doc(lobbyId).collection('players').doc(user.uid).update({ status: vote });
            };
            
            const handleStartMissionOnline = () => {
                db.collection('lobbies').doc(lobbyId).update({ 
                    gameState: 'turnOrder',
                    lastSoundEvent: { name: 'uiClick', timestamp: Date.now() }
                }); 
            };
            
            const handleStartActiveMission = () => {
                db.collection('lobbies').doc(lobbyId).update({
                    gameState: 'active',
                    missionStartTime: firebase.firestore.FieldValue.serverTimestamp(),
                    duration: 3 * 60,
                    lastSoundEvent: {
                        name: lobbyData.speakCategory ? 'category' : 'uiClick',
                        category: lobbyData.speakCategory ? lobbyData.category : null,
                        timestamp: Date.now()
                    }
                });

                setTimeout(() => {
                    db.collection('lobbies').doc(lobbyId).update({
                        lastSoundEvent: firebase.firestore.FieldValue.delete()
                    }).catch(err => console.log("Could not clear sound event, it might have been cleared already."));
                }, 2000);
            }

            const handleEndGameOnline = () => {
                if (lobbyData.gameState === 'active') {
                    db.collection('lobbies').doc(lobbyId).update({ gameState: 'voting' });
                }
            };

            const calculateConfusionResult = async (currentLobbyData, currentLobbyPlayers) => {
                const rogueIds = currentLobbyData.isFakeWordMode ? currentLobbyData.fakeWordPlayerIds : currentLobbyData.imposterIds;
                
                // In Fake Word mode, everyone is polled. In Classic, imposters are not.
                const polledPlayers = currentLobbyData.isFakeWordMode
                    ? currentLobbyPlayers
                    : currentLobbyPlayers.filter(p => !rogueIds.includes(p.id));

                const confusedCount = polledPlayers.filter(p => p.status === 'confused').length;
                const majorityIsConfused = confusedCount > (polledPlayers.length / 2);

                const lobbyRef = db.collection('lobbies').doc(lobbyId);

                if (majorityIsConfused) {
                    await lobbyRef.update({
                        gameState: 'waiting',
                        lastRestartReason: { word: currentLobbyData.secretWord, timestamp: Date.now() },
                        usedWords: firebase.firestore.FieldValue.arrayUnion(currentLobbyData.secretWord),
                        secretWord: firebase.firestore.FieldValue.delete(),
                        imposterIds: firebase.firestore.FieldValue.delete(),
                        fakeWordPlayerIds: firebase.firestore.FieldValue.delete(),
                        fakeWord: firebase.firestore.FieldValue.delete(),
                        turnOrder: firebase.firestore.FieldValue.delete(),
                    });
                } else {
                    const batch = db.batch();
                    const playersRef = lobbyRef.collection('players');
                    currentLobbyPlayers.forEach(player => {
                        if (player.status) {
                            const playerRef = playersRef.doc(player.id);
                            batch.update(playerRef, { status: firebase.firestore.FieldValue.delete() });
                        }
                    });
                    await batch.commit();
                }
            };
            
            const calculateResults = async (currentLobbyData, currentLobbyPlayers) => {
                if (currentLobbyData.gameState !== 'voting') return;

                const isFakeWordMode = currentLobbyData.isFakeWordMode;
                const roguePlayerIds = isFakeWordMode ? currentLobbyData.fakeWordPlayerIds : currentLobbyData.imposterIds;
                const numRoguePlayers = roguePlayerIds?.length || 1;

                const voteCounts = currentLobbyPlayers.reduce((acc, p) => {
                    if (p.votedFor && Array.isArray(p.votedFor)) {
                        p.votedFor.forEach(voteId => {
                            acc[voteId] = (acc[voteId] || 0) + 1;
                        });
                    }
                    return acc;
                }, {});

                const sortedAccused = Object.entries(voteCounts).sort(([, a], [, b]) => b - a);
                let result = {};

                if (numRoguePlayers === 1) {
                    const maxVotes = sortedAccused.length > 0 ? sortedAccused[0][1] : 0;
                    const accusedIds = sortedAccused.filter(([, votes]) => votes === maxVotes).map(([id]) => id);

                    if (accusedIds.length === 1 && roguePlayerIds.includes(accusedIds[0])) {
                        result = { winner: 'agents' };
                    } else if (accusedIds.length !== 1) {
                        result = { winner: isFakeWordMode ? 'fakeWordPlayer' : 'imposter', reason: 'tie' };
                    } else {
                        const accusedPlayer = currentLobbyPlayers.find(p => p.id === accusedIds[0]);
                        result = { winner: isFakeWordMode ? 'fakeWordPlayer' : 'imposter', reason: 'wrong_vote', accusedName: accusedPlayer?.name || 'an agent' };
                    }
                } else { // Logic for 2 imposters/fake cards
                    const accusedTopTwoIds = sortedAccused.slice(0, 2).map(([id]) => id);
                    const isTieForSecond = sortedAccused.length > 2 && sortedAccused[1][1] === sortedAccused[2][1];

                    if (accusedTopTwoIds.length < 2 || isTieForSecond) {
                        result = { winner: isFakeWordMode ? 'fakeWordPlayer' : 'imposter', reason: 'tie' };
                    } else {
                        const correctlyIdentified = accusedTopTwoIds.every(id => roguePlayerIds.includes(id));
                        if (correctlyIdentified) {
                            result = { winner: 'agents' };
                        } else {
                            const accusedPlayer = currentLobbyPlayers.find(p => p.id === accusedTopTwoIds.find(id => !roguePlayerIds.includes(id)));
                            result = { winner: isFakeWordMode ? 'fakeWordPlayer' : 'imposter', reason: 'wrong_vote', accusedName: accusedPlayer?.name || 'an agent' };
                        }
                    }
                }
                
                const votingRecord = currentLobbyPlayers.flatMap((voter) => {
                    if (!voter.votedFor || voter.votedFor.length === 0) {
                         return [{
                            voterId: voter.id,
                            voterName: voter.name,
                            votedForName: 'No Vote'
                        }];
                    }
                    return voter.votedFor.map(voteId => ({
                        voterId: voter.id,
                        voterName: voter.name,
                        votedForName: currentLobbyPlayers.find(p => p.id === voteId)?.name || 'Unknown'
                    }));
                });

                await db.collection('lobbies').doc(lobbyId).update({ 
                    gameState: 'result', gameResult: result, votingRecord
                });
            };
            
            const handleRestartOnline = async () => {
                if (!lobbyData || user.uid !== lobbyData.hostId || lobbyData.gameState !== 'result') return;
                
                const updatePayload = {
                    gameState: 'waiting',
                    secretWord: firebase.firestore.FieldValue.delete(),
                    imposterIds: firebase.firestore.FieldValue.delete(),
                    fakeWordPlayerIds: firebase.firestore.FieldValue.delete(),
                    fakeWord: firebase.firestore.FieldValue.delete(),
                    turnOrder: firebase.firestore.FieldValue.delete(),
                    gameResult: firebase.firestore.FieldValue.delete(),
                    missionStartTime: firebase.firestore.FieldValue.delete(),
                    duration: firebase.firestore.FieldValue.delete(),
                    votingRecord: firebase.firestore.FieldValue.delete(),
                    lastRestartReason: firebase.firestore.FieldValue.delete(),
                };

                await db.collection('lobbies').doc(lobbyId).update(updatePayload);
            };

            const handleStart = () => {
                if (audioManagerRef.current) {
                    audioManagerRef.current.unlockAudio();
                    audioManagerRef.current.playSound('uiClick');
                }
                setIsLoading(false);
                if (initialLobbyParams) {
                    setGameMode('online');
                }
            };

            // --- RENDER LOGIC ---
            const renderContent = () => {
                if (isLoading || !user) {
                    return <LoadingScreen onStart={handleStart} onFinishedLoading={() => setAppReady(true)} />;
                }

                if (gameMode === 'select') {
                    return <GameModeSelectionScreen onSelectMode={setGameMode} onShowHowToPlay={() => setShowHowToPlay(true)} audioManager={audioManagerRef.current} onMuteToggle={handleMuteToggle} isMuted={isMuted} />;
                }

                if (gameMode === 'local') {
                    switch (localGameState) {
                        case 'setup': return <SetupScreen onStartGame={startLocalGame} audioManager={audioManagerRef.current} onBack={handleBackToHome} />;
                        case 'pass':
                            const isFakeWordPlayer = localGameData.isFakeWordMode && localGameData.fakeWordPlayerIndices.includes(localCurrentPlayerIndex);
                            const isImposter = !localGameData.isFakeWordMode && localGameData.imposterIndices.includes(localCurrentPlayerIndex);
                            const wordToShow = isImposter ? "IMPOSTER" : (isFakeWordPlayer ? localGameData.fakeWord : localGameData.secretWord);
                            return <CardRevealScreen key={localCurrentPlayerIndex} player={localGameData.players[localCurrentPlayerIndex]} word={wordToShow} onNext={handleLocalNextPlayer} isLastPlayer={localCurrentPlayerIndex === localGameData.players.length - 1} audioManager={audioManagerRef.current} />;
                        case 'turnOrder': return <TurnOrderScreen players={localGameData.turnOrder} onStartMission={handleStartLocalActiveGame} audioManager={audioManagerRef.current} isHost={true}/>;
                        case 'active': return <GameTimerScreen lobbyData={localGameData} onEndGame={handleLocalEndGame} firstPlayer={localGameData.firstPlayer} audioManager={audioManagerRef.current} isHost={true} lobbyId={null}/>;
                        case 'result': 
                            return <ResultScreen 
                                isLocal={true} lobbyData={localGameData} lobbyPlayers={localGameData.players} 
                                onRestart={handleLocalRestart} onBackToHome={handleBackToHome} audioManager={audioManagerRef.current} isHost={true} 
                            />;
                        default: return <SetupScreen onStartGame={startLocalGame} audioManager={audioManagerRef.current} onBack={handleBackToHome} />;
                    }
                }
                
                if (gameMode === 'online') {
                    if (!lobbyId || !lobbyData) {
                        return <OnlineLobbyScreen user={user} onCreate={handleCreateLobby} onJoin={handleJoinLobby} audioManager={audioManagerRef.current} onBack={handleBackToHome} initialParams={initialLobbyParams} />;
                    }
                    
                    const meAsPlayer = lobbyPlayers.find(p => p.id === user.uid);
                    const isHost = user.uid === lobbyData.hostId;
                    const onlineState = lobbyData.gameState;
                    
                    if (onlineState === 'waiting' || (onlineState === 'reveal' && meAsPlayer?.hasSeenCard)) {
                         return <WaitingRoom lobbyData={lobbyData} lobbyPlayers={lobbyPlayers} user={user} lobbyId={lobbyId} onStartGame={handleStartGameOnline} onStartMission={handleStartMissionOnline} onLeaveLobby={() => isHost ? handleBackToHome() : setShowExitConfirmModal(true)} audioManager={audioManagerRef.current} onConfusionVote={handleConfusionVote} />;
                    }
                    if (onlineState === 'reveal' && !meAsPlayer?.hasSeenCard) {
                        const isFakeWordPlayerOnline = lobbyData.isFakeWordMode && lobbyData.fakeWordPlayerIds?.includes(user.uid);
                        const isImposterOnline = !lobbyData.isFakeWordMode && lobbyData.imposterIds?.includes(user.uid);
                        const wordForOnlinePlayer = isImposterOnline ? "IMPOSTER" : (isFakeWordPlayerOnline ? lobbyData.fakeWord : lobbyData.secretWord);
                        return <CardRevealScreen 
                                        isOnline={true} player={{ name: meAsPlayer?.name }} 
                                        word={wordForOnlinePlayer}
                                        audioManager={audioManagerRef.current}
                                        onAcknowledge={handleAcknowledgeCard}
                                        onConfused={handleDeclareConfusion}
                                     />;
                    }
                    if (onlineState === 'turnOrder') {
                        return <TurnOrderScreen players={lobbyData.turnOrder || []} onStartMission={handleStartActiveMission} audioManager={audioManagerRef.current} isHost={isHost} />;
                    }
                    if (onlineState === 'active') {
                         return <GameTimerScreen 
                            lobbyData={lobbyData} onEndGame={handleEndGameOnline} 
                            firstPlayer={lobbyData.turnOrder ? lobbyData.turnOrder[0].name : ''} audioManager={audioManagerRef.current} isHost={isHost} lobbyId={lobbyId}
                        />;
                    }
                    if (onlineState === 'voting') {
                        return <VotingScreen lobbyData={lobbyData} lobbyPlayers={lobbyPlayers} user={user} lobbyId={lobbyId} audioManager={audioManagerRef.current} />;
                    }
                    if (onlineState === 'result') {
                        return <ResultScreen 
                            isLocal={false} lobbyData={lobbyData} lobbyPlayers={lobbyPlayers}
                            onRestart={handleRestartOnline} onBackToHome={handleBackToHome} 
                            onConfirmExit={() => setShowExitConfirmModal(true)}
                            audioManager={audioManagerRef.current} isHost={isHost}
                        />;
                    }
                    return <LoadingScreen onStart={handleStart} onFinishedLoading={() => setAppReady(true)} />; // Fallback
                }
            };
            
            return (
                <div className="w-full h-full text-slate-200 font-sans selection:bg-brand-500/30">
                    <div className="fixed inset-0 bg-[#020617] -z-10"></div>
                     <div className="absolute inset-0 pointer-events-none">
                        <div className="blob bg-brand-600/30 top-[-20%] left-[-20%] w-[60%] h-[60%]"></div>
                        <div className="blob bg-cyan-600/30 bottom-[-20%] right-[-20%] w-[60%] h-[60%] animation-delay-2000"></div>
                    </div>
                    {showHowToPlay && <HowToPlayModal onClose={() => setShowHowToPlay(false)} />}
                    {showRemovedModal && <RemovedModal onClose={() => {
                        setShowRemovedModal(false);
                        handleBackToHome(true);
                    }} />}
                    {lobbyClosedInfo && <LobbyClosedModal hostName={lobbyClosedInfo.hostName} onClose={() => {
                        setLobbyClosedInfo(null);
                        handleBackToHome(true);
                    }} />}
                    {restartNotification && <RestartNotificationModal word={restartNotification} onClose={() => setRestartNotification(null)} />}
                    {showImposterVoteNotification && <ImposterVoteNotificationModal onClose={() => setShowImposterVoteNotification(false)} />}
                    {showExitConfirmModal && <ExitLobbyConfirmModal onConfirm={() => { setShowExitConfirmModal(false); handleBackToHome(); }} onCancel={() => setShowExitConfirmModal(false)} />}
                    {renderContent()}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
